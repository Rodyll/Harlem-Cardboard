'use strict';(function(a){var b=!1,c=/\b_super\b/,d=function(){};d.extend=function(a){function d(){b||(this._init&&this._init.apply(this,arguments),this.init&&this.init.apply(this,arguments),this._initAfter&&this._initAfter.apply(this,arguments))}var g=this.prototype;b=!0;var h=new this;b=!1;for(var i in a){var k=Object.getOwnPropertyDescriptor(a,i);k.get||k.set?Object.defineProperty(h,i,k):h[i]="function"==typeof a[i]&&"function"==typeof g[i]&&c.test(a[i])?function(a,b){return function(c,d,e,f,h,
i){var k=this._super;this._super=g[a];this._fn=b;c=this._fn(c,d,e,f,h,i);this._super=k;return c}}(i,a[i]):a[i]}d.prototype=h;d.prototype.constructor=h.init;d.extend=this.extend;return d};a.Class=d;a.Class=d})("undefined"!==typeof window?window:global);
var base64={PADCHAR:"=",ALPHA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",makeDOMException:function(){try{return new DOMException(DOMException.INVALID_CHARACTER_ERR)}catch(a){var b=Error("DOM Exception 5");b.code=b.number=5;b.name=b.description="INVALID_CHARACTER_ERR";b.toString=function(){return"Error: "+b.name+": "+b.message};return b}},getbyte64:function(a,b){var c=base64.ALPHA.indexOf(a.charAt(b));if(-1===c)throw base64.makeDOMException();return c},decode:function(a){var a=
""+a,b=base64.getbyte64,c,d,e,f=a.length;if(0===f)return a;if(0!==f%4)throw base64.makeDOMException();c=0;a.charAt(f-1)===base64.PADCHAR&&(c=1,a.charAt(f-2)===base64.PADCHAR&&(c=2),f-=4);var g=[];for(d=0;d<f;d+=4)e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6|b(a,d+3),g.push(String.fromCharCode(e>>16,e>>8&255,e&255));switch(c){case 1:e=b(a,d)<<18|b(a,d+1)<<12|b(a,d+2)<<6;g.push(String.fromCharCode(e>>16,e>>8&255));break;case 2:e=b(a,d)<<18|b(a,d+1)<<12,g.push(String.fromCharCode(e>>16))}return g.join("")},
getbyte:function(a,b){var c=a.charCodeAt(b);if(255<c)throw base64.makeDOMException();return c},encode:function(a){if(1!==arguments.length)throw new SyntaxError("Not enough arguments");var b=base64.PADCHAR,c=base64.ALPHA,d=base64.getbyte,e,f,g=[],a=""+a,h=a.length-a.length%3;if(0===a.length)return a;for(e=0;e<h;e+=3)f=d(a,e)<<16|d(a,e+1)<<8|d(a,e+2),g.push(c.charAt(f>>18)),g.push(c.charAt(f>>12&63)),g.push(c.charAt(f>>6&63)),g.push(c.charAt(f&63));switch(a.length-h){case 1:f=d(a,e)<<16;g.push(c.charAt(f>>
18)+c.charAt(f>>12&63)+b+b);break;case 2:f=d(a,e)<<16|d(a,e+1)<<8,g.push(c.charAt(f>>18)+c.charAt(f>>12&63)+c.charAt(f>>6&63)+b)}return g.join("")}},mighty=window.mighty={};
mighty.Device={load:function(){void 0===window.console&&(window.console={log:function(){},warn:function(){}});if(void 0!==navigator.isCocoonJS)this.name="CocoonJS",this.version="1.3",this.versionBuffer=[1,3],this.isDevice=this.isCocoonJS=!0,this.userAgent=navigator.userAgent.split(",")[0],console.log("Powered by: "+this.name);else{var a={Chrome:[/Chrome\/(\S+)/],Firefox:[/Firefox\/(\S+)/],MSIE:[/MSIE (\S+);/],Opera:[/Opera\/.*?Version\/(\S+)/,/Opera\/(\S+)/],Safari:[/Version\/(\S+).*?Safari\//]},
b=navigator.userAgent,c,d,e=2;for(c in a)for(;d=a[c].shift();)if(d=b.match(d)){this.version=d[1].match(RegExp("[^.]+(?:.[^.]+){0,"+--e+"}"))[0];this.name=c.toLowerCase();console.log(c+" "+this.version);this.versionBuffer=this.version.split(".");d=this.versionBuffer.length;for(var f=0;f<d;f++)this.versionBuffer[f]=parseInt(this.versionBuffer[f]);break}}null===this.versionBuffer||"unknown"===this.name?console.log("(Warning) Could not detect browser."):(this._loadSupport(),this._loadUnsupportedFeatures())},
_loadSupport:function(){this.support.onloadedmetadata="object"===typeof window.onloadedmetadata;this.support.onkeyup="object"===typeof window.onkeyup;this.support.onkeydown="object"===typeof window.onkeydown;this._checkQuerySelector();this._checkCanvas();this._checkWebGL();this._checkWebAudio()},_loadUnsupportedFeatures:function(){window.btoa||(window.btoa=base64.encode);window.atob||(window.atob=base64.decode)},_checkQuerySelector:function(){var a=document.createElement("div");a.innerHTML="<p class='TEST'></p>";
this.support.querySelector=a.querySelectorAll?0===a.querySelectorAll(".TEST").length?!1:!0:!1},_checkCanvas:function(){if(this.isCocoonJS)this.support.canvas=!0;else if(this.support.canvas=!1,this.support.canvas=!(!window.HTMLCanvasElement||!window.CanvasRenderingContext2D),!0!==this.support.canvas){var a=document.createElement("canvas");this.support.canvas=!(!a.getContext||!a.getContext("2d"))}},_checkWebGL:function(){if(this.isCocoonJS)this.support.webGL=!0;else if(!this.support.canvas||!window.WebGLRenderingContext)this.support.webGL=
!1;else{var a=document.createElement("canvas");try{if(a.getContext("webgl")||a.getContext("experimental-webgl"))this.support.webGL=!0}catch(b){this.support.webGL=!1}}},_checkWebAudio:function(){"chrome"===this.name&&10<=this.versionBuffer[0]&&(this.support.webAudioAPI=!0);"safari"===this.name&&6<=this.versionBuffer[0]&&(this.support.webAudioAPI=!0)},isSupport:function(a){return void 0!==this.support[a]},isMobileSafari:function(){return navigator.userAgent.match(/(iPod|iPhone|iPad)/)&&navigator.userAgent.match(/AppleWebKit/)},
name:"Unknown",version:"0",versionBuffer:null,agent:"web",support:{},isCocoonJS:!1,isLoaded:!1,isDevice:!1};mighty.Device.load();window.Channel={};window.Channel.Base=function(a){this.name=a;this.subscribers=[];this.numSubscribers=0};
window.Channel.Base.prototype={updatePriority:function(){this.subscribers.sort(this._func_priority)},subscribe:function(a,b,c){if("object"!==typeof a)mighty.Error.submit("Channel.subscribe","Error: 'owner' is not an object.");else{void 0===c&&(c=0);if(null!==a)for(var d=0;d<this.numSubscribers;d++)if(this.subscribers[d].owner===a)return!1;a=new Channel.Subscriber(a,b,c);this.subscribers.push(a);this.numSubscribers++;this.updatePriority();return!0}},unsubscribe:function(a){for(var b=0;b<this.numSubscribers;++b)if(this.subscribers[b].owner===
a){this.subscribers[b]=this.subscribers[this.numSubscribers-1];this.subscribers.pop();this.numSubscribers--;break}this.updatePriority()},signal:function(a,b){for(var c=0;c<this.numSubscribers;++c)this.subscribers[c].func(a,b)},signalBreakable:function(a,b){for(var c=0;c<this.numSubscribers&&!this.subscribers[c].func(a,b);++c);},ask:function(a,b){this.mutex=!0;for(var c=0;c<this.numSubscribers;++c){var d=this.subscribers[c].func(a,b);if(void 0!==d)return this.mutex=!1,d}this.mutex=!1;this.numTempSubscribers&&
this._updateTempBuffer();return null},_func_priority:function(a,b){return b.priority-a.priority}};window.Channel.Subscriber=function(a,b,c){this.owner=a;this.func=b;this.priority=c};window.Channel.Event=function(a,b){this.type=a;this.obj=b};window.Channels={};window.CreateChannel=function(a){if(a){var b=Channels[a];if(void 0!==b)return b;b=new Channel.Base(a);return Channels[a]=b}};window.RemoveChannel=function(a){a&&(a.subscribers=null,Channels[a.name]=void 0)};
window.SubscribeChannel=function(a,b,c,d){"string"===typeof a&&(d=c,c=b,b=a,a=null);var e=null;if("string"===typeof b)e=Channels[b],void 0===e&&(e=CreateChannel(b));else{if(!b||void 0===b.signal){mighty.Error.submit("SubscribeChannel","Error: Invalid 'channel' object.");return}e=b}e.subscribe(a,c,d);return e};window.UnsubscribeChannel=function(a,b){var c=Channels[b];if(void 0===c)return null;c.unsubscribe(a)};window.GetChannel=function(a){a=Channels[a];return void 0===a?null:a};
window.SendSignal=function(a,b,c){a=Channels[a];if(void 0===a)return null;a.signal(b,c)};window.Ask=function(a,b,c){a=Channels[a];return void 0===a?null:a.ask(b,c)};
mighty.Error={init:function(){if(!window.navigator.isCocoonJS&&(this.errorBox=document.getElementById("mightyError")))this.errorLog=this.errorBox.getElementsByTagName("ul")[0];var a=this;window.onerror=function(b,c,d){a.showErrorSilent(c+": "+d,b)};this.error=this.submit},submit:function(a,b){this.showError(a,b)},error:null,warning:function(a,b,c){if(Engine.Cfg.errorHandler.showWarning){var d="",d=a&&a.length?b&&b.length?"(Warning) ["+a+"] - "+b:a:b;c?console.warn(d,c):console.warn(d)}},showError:function(a,
b,c){if(Engine.Cfg.errorHandler.showError){if(void 0===window.navigator.isCocoonJS){var d="",d=a&&a.length?b&&b.length?"["+a+"] - "+b:a:b;this.isShowErrorBox&&this.errorLog&&(a=document.createElement("li"),a.innerHTML=d,this.errorLog.appendChild(a),this.errorBox.style.display="block")}else CocoonJS.App.forward("mighty.ShowError('"+a+"', '"+b+"')");c?console.error(d,c):console.error(d)}},showErrorSilent:function(a,b){if(Engine.Cfg.errorHandler.showError)if(window.navigator.isCocoonJS)CocoonJS.App.forward("mighty.ShowError('"+
a+"', '"+b+"')");else{var c="",c=a&&a.length?b&&b.length?"["+a+"] - "+b:a:b;if(this.isShowErrorBox&&this.errorLog){var d=document.createElement("li");d.innerHTML=c;this.errorLog.appendChild(d);this.errorBox.style.display="block"}}},errorBox:null,errorLog:null,isShowErrorBox:!0};mighty.Error.init();mighty.Flag=function(){this.bits=0;this.lastBits=1;this.bitsTotal=0;this.flags={};this.deactivateCB=this.cb=null};
mighty.Flag.prototype={add:function(a){if(void 0!==this.flags[a])mighty.Error.error("mighty.Flag.add","There is already flag with a name - "+a);else{var b=this.lastBits;this.bitsTotal|=b;this.lastBits<<=1;this.flags[a]=new mighty.FlagInfo("",0,b)}},add_Signal:function(a,b,c){if(void 0!==this.flags[a])mighty.Error.error("mighty.Flag.add_Signal","There is already flag with a name - "+a);else{var d=this.lastBits;this.bitsTotal|=d;this.lastBits<<=1;this.flags[a]=new mighty.FlagInfo(b,c,d);var e=this;
SubscribeChannel(this,b,function(b){b===e.flags[a].event&&e.activate(a)})}},activate:function(a){a=this.flags[a];void 0!==a&&!(this.bits&a.bits)&&(this.bits|=a.bits,a.chn&&UnsubscribeChannel(this,a.chn),this.bits===this.bitsTotal&&this.cb&&this.cb())},deactivate:function(a){var b=this.flags[a];if(void 0!==b&&this.bits&b.bits){this.bits^=b.bits;if(b.chn){var c=this;SubscribeChannel(this,b.chn,function(b){b===c.flags[a].event&&c.activate(a)})}this.deactivateCB&&this.deactivateCB()}},is:function(a){return void 0===
this.flags[a]?!1:this.bits&this.flag.bits?!0:!1}};mighty.FlagInfo=function(a,b,c){this.chn=a;this.event=b;this.bits=c};mighty.TemplateCSS=function(a,b,c){this.init=function(){this.path=gParams.path||Resource.Cfg.path;for(var d in a)this.setBackground(d,a[d]);this.src=b;c&&!b&&(this.fullText+="\r\n"+c);this.appendStyles()};this.init()};
mighty.TemplateCSS.prototype={setStyle:function(a,b){this.fullText+=a+" { "+b+"}"},getTexture:function(a){return mighty.Macro.GetTextureByName(a)},setBackground:function(a,b){var c=this.getTexture(b);c?this.setStyle(a,"background-image:url('"+this.path+"/default/img/"+c.id+"."+c.ext+"');"):console.error("Cannot find resource!!",b)},removeStyles:function(){this.style.parentNode&&this.style.parentNode.removeChild(this.style);this.isVisible=1},appendStyles:function(){if(this.style&&!this.isVisible)document.getElementsByTagName("head")[0].appendChild(this.style);
else if(this.isVisible=1,this.src)this.style=document.createElement("link"),this.style.rel="stylesheet",this.style.type="text/css",this.style.setAttribute("href",this.src),document.getElementsByTagName("head")[0].appendChild(this.style);else if(this.style=document.createElement("style"))this.style.type="text/css",this.style.styleSheet?this.style.styleSheet.cssText=this.fullText:this.style.appendChild(document.createTextNode(this.fullText)),document.getElementsByTagName("head")[0].appendChild(this.style)},
style:null,src:null,fullText:"",isVisible:0};mighty.Templates={};mighty.TemplateJS={};
mighty.Template={init:function(){if(Scene.plugin&&Scene.plugin.currScene){Scene.plugin.currScene.flags.add_Signal("UI","UI",UI.Event.LOADED);this.numToLoad=0;this.isLoaded=!1;CreateChannel("UI");var a=this;SubscribeChannel(this,"i18n.OUT",function(b){return b===i18n.Event.LANG_CHANGED?(a.updateLang(),!0):!1})}else mighty.Error.error("mighty.Template.init","Could not initialize template, no current scene found.")},create:function(a,b){void 0===b&&(b=!0);var c=null;Palettes.UI.getByName(a)&&(c=new mighty.TemplateItem(a,
null,{name:"base"}),c.rootPath=mighty.Template.rootPath,c._loadCSS());this.numToLoad+=2;this.isLoaded=!1;var d=document.createElement("div");d.setAttribute("id","view-"+a);var e=new mighty.TemplateItem(a,d);e.rootPath=this.rootPath;e.numToLoad=2;mighty.Templates[a]=e;mighty.Device.isCocoonJS?c?CocoonJS.App.forwardAsync("mighty.AddUI('"+a+"', true);"):CocoonJS.App.forwardAsync("mighty.AddUI('"+a+"');"):(b&&e._loadCSS(),c&&(this.numToLoad++,e.numToLoad++,e.initEditorTemplate=!0,c._getJS(function(){e.checkLoaded();
mighty.Template.checkLoaded()})));e._getJS(function(){e.checkLoaded();mighty.Template.checkLoaded()});return e},remove:function(a){var b=mighty.Templates[a];b&&(!b.isLoaded&&b.inProgress&&(this.numToLoad--,0>=this.numToLoad&&(this.isLoaded=!0)),mighty.Templates[key].hide(),delete mighty.Templates[key]);mighty.TemplateJS[a]&&delete mighty.TemplateJS[key]},removeAll:function(){for(var a in mighty.Templates)mighty.Templates[a].hide(),delete mighty.Templates[a],delete mighty.TemplateJS[a];this.numToLoad=
0;this.isLoaded=!0},load:function(){var a=null,b;for(b in mighty.Templates)(a=mighty.Templates[b].js)?void 0!==a.load&&a.load():mighty.Error.error("UI.load","Could not find JavaScript file for - "+b+" UI.")},unload:function(){var a=null,b;for(b in mighty.Templates)a=mighty.Templates[b].js,void 0!==a.unload&&a.unload()},updateLang:function(){var a=mighty.Templates,b;for(b in a)a[b].updateFromCache()},_populateData:function(a,b){for(var c=mighty.Templates[a],d=JSON.parse(b),e=d.length,f=0;f<e;f++)c._defineAttribute_CocoonJS(d[f])},
checkLoaded:function(){mighty.Template.numToLoad--;0>=mighty.Template.numToLoad&&(mighty.Template.isLoaded=!0,SendSignal("UI",UI.Event.LOADED,null))},rootPath:"src/templates",isLoaded:!0};
mighty.TemplateItem=function(a,b,c){c&&(this._data=c);var d=this;Object.defineProperty(this,"html",{set:function(a){d.isAppended&&d.holder.parentNode&&d.holder.parentNode.removeChild(d.holder);d.cache=[];mighty.Device.isCocoonJS?(d.innerHTML=a,a=window.btoa(a),CocoonJS.App.forwardAsync("mighty.UI."+d.name+".setHTML('"+a+"');")):(d.innerHTML=i18n.plugin.processWithCacheHTML(a,d.cache),d._parseVar(),d.isAppended&&(d.holder.innerHTML="",d.holder.appendChild(d.innerHTML),d.appendElement?mighty.engine.appendElement.appendChild(d.holder):
mighty.engine.domElement.appendChild(d.holder)))},get:function(){return d.innerHTML}});this.name=a;this.innerHTML=null;this.holder=b;this.cache=this.js=null;this.data={};this.properties={};this.appendElement=null;this.isLoaded=!1;this.numToLoad=0;this.isAppended=this.isShow=this.inProgress=!1;this.rootPath="";this._script=this._css=null};
mighty.TemplateItem.prototype={show:function(a){void 0!==a&&(this.appendElement=a);if(!this.isShow)if(this.isShow=!0,this.isLoaded2){if(mighty.Device.isCocoonJS?CocoonJS.App.forwardAsync("mighty.UI."+this.name+".show();"):this._append(),void 0!==this.js.onShow)this.js.onShow()}else if(mighty.Device.isCocoonJS&&(CocoonJS.App.forwardAsync("mighty.UI."+this.name+".show();"),void 0!==this.js.onShow))this.js.onShow()},hide:function(){if(this.isShow&&(this.isShow=!1,this.isLoaded)){if(void 0!==this.js.onHide)this.js.onHide();
mighty.Device.isCocoonJS?CocoonJS.App.forwardAsync("mighty.UI."+this.name+".hide();"):this._remove()}},checkLoaded:function(){if(0!=this.numToLoad&&(this.numToLoad--,!(0<this.numToLoad))){this.isLoaded2=this.isLoaded=!0;this.inProgress=!1;void 0!==this.js.init&&this.js.init();if(this.initEditorTemplate){var a=this,b=a.js.onShow;a.js.onShow=function(){a.holder.style.width="100%";a.holder.style.height="100%";a.holder.style.position="absolute";a.holder.firstChild&&(a.holder.firstChild.style.height="100%");
mighty.templatebase[a.name]();b&&b.call(a.js)}}if(this.isShow)if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".show()");else if(this._append(),void 0!==this.js.onShow)this.js.onShow()}},setVisible:function(a){a?this.show():this.hide()},update:function(){this.html=this.html},addCSS:function(a){var b=document.createElement("link");b.setAttribute("rel","stylesheet");b.setAttribute("type","text/css");b.setAttribute("href",mighty.Template.rootPath+"/"+this.name+"/"+a+".css");
document.head.appendChild(b)},_loadCSS:function(){var a=this.name;this._data&&this._data.name&&(a=this._data.name);mighty.Device.isCocoonJS||(a=this.rootPath+"/"+this.name+"/"+a+".css",this._css=Resource.Templates[this.name]&&Resource.Templates[this.name].css&&gParams.rel?new mighty.TemplateCSS(null,null,Resource.Templates[this.name].css):new mighty.TemplateCSS(null,a))},_getJS:function(a){var b=this.name;this._data&&this._data.name&&(b=this._data.name);var c=this,d=function(){mighty.TemplateJS[b]&&
(c.js=new mighty.TemplateJS[b](c),c.js.ui=c);"base"!=b&&c._getHTML(g);a&&a()};if(Resource.Templates[this.name]&&gParams.release&&"base"!=b){try{eval(Resource.Templates[c.name].js)}catch(e){console.error(e)}d()}else{var f=mighty.Template.rootPath+"/"+this.name+"/"+b+".js",g=mighty.Template.rootPath,h=document.createElement("script");h.setAttribute("type","text/javascript");h.setAttribute("src",f);h.onload=function(){d()};h.onerror=function(){c.html=""};document.getElementsByTagName("head")[0].appendChild(h)}},
_getHTML:function(a){var b=this,c=function(a){b.txt=a;b.html=a;b.isLoaded=!0;b.inProgress=!1;b.checkLoaded();mighty.Template.checkLoaded()};Resource.Templates[this.name]&&gParams.rel?c(Resource.Templates[this.name].html):mighty.Ajax({type:"GET",url:a+"/"+this.name+"/"+this.name+".html",success:function(a){c(a)},error:function(){b.html=""}})},_parseVar:function(a){for(var b={},c=null,d=null,d=void 0===a?this.html.querySelectorAll("[data-var], [data-click]"):[a],a=d.length,e=0;e<a;e++){var c=d[e],f=
c.getAttribute("data-var");if(f)b[f]=c,this.data[f]&&(b[f].innerText=i18n.plugin.processText(this.data[f]));else if((f=c.getAttribute("data-click"))&&void 0===f.onclick)c.onclick=this.createOnClick(f),c.addEventListener("touchend",c.onclick)}for(var g in b)this.properties[g]=b[g],this._defineAttribute(g,b[g])},_defineAttribute:function(a,b){var c=void 0,d=Object.getOwnPropertyDescriptor(this.data,a);d&&void 0===d.set&&(c=this.data[a],delete this.data[a]);if(void 0===this.data[a]){var e=this;Object.defineProperty(this.data,
a,{get:function(){return e.properties[a].innerHTML},set:function(b){e.properties[a].innerHTML=i18n.plugin.processText(b);for(var b=e.properties[a].querySelectorAll("[data-var], [data-click]"),c=0;c<b.length;c++)e._parseVar(b[c])}})}void 0!==c&&(this.data[a]=c,b.prevValue=c,this.cache.push(b))},_defineAttribute_CocoonJS:function(a){if(void 0!==this.data[a]){var b=window.btoa(this.data[a]);CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setVar('"+a+"','"+b+"');");delete this.data[a]}var c=this;Object.defineProperty(this.data,
a,{get:function(){return 1},set:function(b){b=window.btoa(b);CocoonJS.App.forwardAsync("mighty.UI."+c.name+".setVar('"+a+"','"+b+"');")}})},getTemplate:function(){this.inProgress||(this.inProgress=!0,this._getHTML())},_append:function(){this.holder.appendChild(this.innerHTML);this.appendElement?mighty.engine.appendElement.appendChild(this.holder):mighty.engine.domElement&&mighty.engine.domElement.appendChild(this.holder);this._css&&!this._css.isVisible&&this._css.removeStyles();this.isAppended=!0},
_remove:function(){if(void 0!==this.js.onHide)this.js.onHide();this.holder.parentNode&&this.holder.parentNode.removeChild(this.holder);this._script&&this._script.parentNode&&this._script.parentNode.removeChild(this._script);this.isAppended=!1},setParameter:function(a,b){var c=this.properties[a];void 0!==c&&c.innerText?c.innerText=i18n.plugin.processText(b):this.properties[a]=i18n.plugin.processText(b)},updateFromCache:function(){for(var a=i18n.plugin,b=null,c=this.cache.length,d=0;d<c;d++)b=this.cache[d],
b.nodeValue?b.nodeValue=a.processText(b.prevValue):b.innerText=a.processText(b.prevValue)},addTimer:function(a,b,c){return UI.plugin.addTimer(a,b,c)},dataClick:function(a,b){var c=this.js[b[0]];if(c){for(var d=[],e=1;e<b.length;e++)d.push(b[e]);c.apply(this.js,d)}else mighty.Error.warning("UI."+this.name+".dataClick","No such function found - '"+b[0]+"'.")},createElement:function(a,b,c,d){mighty.Device.isCocoonJS?CocoonJS.App.forwardAsync("mighty.UI."+this.name+".createElement('"+a+"', '"+b+"', '"+
c+"', '"+d+"');"):(a=document.createElement(a),b&&a.setAttribute("id",b),c&&(a.className=c),d&&(a.style.cssText=d),this.html.appendChild(a))},createElementEx:function(a,b,c,d,e,f,g){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".createElementEx('"+a+"','"+b+"','"+c+"','"+d+"','"+e+"','"+JSON.stringify(f)+"','"+g+"');");else{a=document.createElement(a);b&&a.setAttribute("id",b);c&&(a.className=c);d&&(a.style.cssText=d);a.innerHTML=e;for(var h in f)a.setAttribute(h,f[h]);
g?(b=document.querySelector(g))?(b.appendChild(a),this._parseVar(a)):mighty.Error.warning("UI.createElementEx","Could not find parent with prefix - "+g):(this.html.appendChild(a),this._parseVar(this.html.lastChild))}},createParentElement:function(a,b){if(!mighty.Device.isCocoonJS){var c=document.createElement(a),d=this.html.querySelector(b);d&&d.appendChild(c)}},addBr:function(a){if(!mighty.Device.isCocoonJS){var b=document.createElement("br");a?(a=this.html.querySelector(a))&&a.appendChild(b):this.html.appendChild(b)}},
clear:function(a){if(!mighty.Device.isCocoonJS)if(a){if(a=this.html.querySelector(a))a.innerHTML=""}else this.html.innerHTML+=""},addText:function(a,b){if(!mighty.Device.isCocoonJS)if(b){var c=this.html.querySelector(b);c&&(c.innerHTML+=a)}else this.html.innerHTML+=a},createOnClick:function(a){var a=a.replace(" ",""),b=a.split(","),c=this;return function(a){c.dataClick(a,b)}},removeElementByID:function(a){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".removeElementByID('"+
a+"');");else{var b=this.html.querySelector("#"+a);b?this.html.removeChild(b):mighty.Error.warning("UI."+this.name+".removeElementByID","No such property found with an ID - '"+a+"'.")}},setAttribute:function(a,b,c){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setAttribute('"+a+"', '"+b+"', '"+window.btoa(c)+"');");else{var d=this.properties[a];d?d[b]=c:mighty.Error.warning("UI."+this.name+".setAttribute","No such property found - '"+a+"'.")}},setStyleAttribute:function(a,
b,c){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setStyleAttribute('"+a+"', '"+b+"', '"+window.btoa(c)+"');");else{var d=this.properties[a];d?d.style[b]=c:mighty.Error.warning("UI."+this.name+".setStyleAttribute","No such property found - '"+a+"'.")}},setStyle:function(a,b){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setStyle('"+a+"', '"+window.btoa(b)+"');");else{var c=this.properties[a];c?c.style.cssText=b:mighty.Error.warning("UI."+
this.name+".setStyle","No such property found - '"+a+"'.")}},setStyleByID:function(a,b){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setStyleByID('"+a+"', '"+b+"');");else{var c=this.html.querySelector("#"+a);c?c.style.cssText=b:mighty.Error.warning("UI."+this.name+".setStyle","No such element with an id - '"+a+"'.")}},addStyle:function(a,b){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".addStyle('"+a+"', '"+JSON.stringify(b)+"');");
else{var c=this.properties[a];if(void 0===!c)mighty.Error.warning("UI."+this.name+".addStyle","No such property found - '"+a+"'.");else{var c=c.style,d;for(d in b)c[d]=b[d]}}},setClass:function(a,b){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".setClass('"+a+"', '"+b+"');");else{var c=this.properties[a];c?c.className=b:mighty.Error.warning("UI."+this.name+".setStyle","No such property found - '"+a+"'.")}},setClassByID:function(a,b){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+
this.name+".setClassByID('"+a+"', '"+b+"');");else{var c=this.html.querySelector("#"+a);c?c.className=b:mighty.Error.warning("UI."+this.name+".setStyle","No such element with an id - '"+a+"'.")}},getElementByClass:function(a){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("mighty.UI."+this.name+".getElementByClass('"+a+"');");else{var b=this.html.querySelector("."+a);return!b?(mighty.Error.warning("UI."+this.name+".setStyle","Could not find element with class - '"+a+"'."),null):b}}};
mighty.UI=mighty.Templates;
mighty.Loader={init:function(){var a=this;this.flags=new mighty.Flag;this.flags.cb=function(){a.onFlagLoad()};this.flags.add("Loaded");this.chn_Loader=SubscribeChannel(this,"Loader",function(b,c){return a.handleSignal_Loader(b,c)});this.elements=[];this.loaderElement=new mighty.Loader.Element("Scripts",0,100);mighty.Device.isCocoonJS&&(this.flags.add("WebView"),CocoonJS.App.onLoadInTheWebViewSucceed.addEventListener(function(b){b.length&&(CocoonJS.App.showTheWebView(),CocoonJS.App.forwardAsync("mighty.InitError();"),mighty.Device.isLoaded=
!0,a.flags.activate("WebView"))}),CocoonJS.App.onLoadInTheWebViewFailed.addEventListener(function(){mighty.Error.error("CocoonJS.WebView","Could not load the HTML file in the webview.")}),CocoonJS.App.loadInTheWebView(this.webViewPath))},onFlagLoad:function(){this.isLoading=!0;this.addElement(this.loaderElement);this.loadNext()},load:function(a){this.cbFunc=a;this.flags.activate("Loaded")},loadNext:function(){var a=this;if(0==this.includes.length){this.isLoaded=!0;var b=mighty.Device;(!b.isDevice||
b.isLoaded)&&this.cbFunc()}else b=this.includes.shift(),window.getScript(b,function(){a.loaderElement.numItemsLoaded++;a.updateElement(a.loaderElement);a.loadNext()})},include:function(a){this.includes.push(this.rootPath+this.path+a);this.loaderElement.numItems++},updateElement:function(a){this.percents=0;for(var b=this.elements.length,c=0;c<b;c++)a=this.elements[c],this.percents+=100/this.totalPower/a.numItems*100*a.numItemsLoaded;this.setPercents(this.percents);this.chn_Loader.signal(Loader.Event.PERCENT_UPDATED,
this.percents);100<=this.percents&&(this.chn_Loader.signal(Loader.Event.LOADED,!0),this.isLoading=!1)},addElement:function(a){0>=a.numItems||(this.isLoading=!0,this.elements.push(a),this.totalPower+=a.amount,this.updateElement(a))},getElement:function(a){for(var b,c=this.elements.length,d=0;d<c;d++)if(b=this.elements[d],b.name===a)return b;return null},setPercents:function(a){this.percents=Math.round(a);this.template&&void 0!==this.template.data.progress&&this.template.setStyle("progress","width: "+
this.percents+"%")},showBlank:function(){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("document.getElementById('blankScreen').style.display = 'block';");else{var a=document.getElementById("blankScreen");a&&(a.style.display="block")}},hideBlank:function(){if(mighty.Device.isCocoonJS)CocoonJS.App.forwardAsync("document.getElementById('blankScreen').style.display = 'none';");else{var a=document.getElementById("blankScreen");a&&(a.style.display="none",this._template&&this._template.hide())}},
handleSignal_Loader:function(a){switch(a){case Loader.Event.LOADED:return!this.isLoading}return null},set isLoading(a){this._isLoading=a;this._template&&a&&(this._template.show(),this.setPercents(this.percents))},get isLoading(){return this._isLoading},set template(a){this._template=a;this.setPercents(this.percents);this._template.show()},get template(){return this._template},includes:[],path:"",rootPath:"",cbFunc:null,elements:null,fixedItems:0,loaderItem:null,totalPower:0,percents:0,_isLoading:!1,
isLoaded:!1,flags:null,webViewPath:"engine/library/WebView.html",_template:null,query:{}};mighty.Loader.Element=function(a,b,c){this.name=a;this.numItems=b;this.loaderElement=this.numItemsLoaded=0;void 0===c&&(c=100);this.amount=c;this.percentsPerItem=0};mighty.OnDomLoad=function(a){if(window.onload){var b=window.onload;window.onload=function(){b();a()}}else window.onload=a;"complete"===document.readyState&&a()};mighty.Loader.init();window.gParams=window.gParams||{};mighty.editor=gParams.editor;
(function(){for(var a=window.location.href.split("?").pop().split("&"),b=0;b<a.length;b++){var c=a[b].split("=");1<c.length&&(window.gParams[c[0]]=c[1])}})();var tempObj={},key;for(key in Engine)tempObj[key]=Engine[key];var shaderProgram=null;mighty.scale=1;
mighty.engine={init:function(a){this.initUI(a);this.initCfg();console.log(this.name+": 1.1.1v");this.chn_Engine=CreateChannel("Engine");this._loadExtensions();this.isWebGL&&(this.initWebGL(),this.initShaders());this.updateWindowSize();this.initStyles();this.initEvents();mighty.scale=1;return!0},initWebGL:function(){this.context.clearColor(0,0,0,1);this.context.clearDepth(1);this.context.enable(this.context.DEPTH_TEST);this.context.depthFunc(this.context.LEQUAL);this.context.blendFunc(this.context.SRC_ALPHA,
this.context.ONE_MINUS_SRC_ALPHA);this.context.enable(this.context.BLEND);this.context.pixelStorei(this.context.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initShaders:function(){var a=this.getShaderFromScript("shader-vs"),b=this.getShaderFromScript("shader-fs"),c=this.context.createProgram();this.context.attachShader(c,a);this.context.attachShader(c,b);this.context.linkProgram(c);this.context.getProgramParameter(c,this.context.LINK_STATUS)?(this.context.useProgram(c),window.shaderProgram=c,this.context.loc=
{},a=this.context.loc,a.vertice=this.context.getAttribLocation(c,"vertice"),this.context.enableVertexAttribArray(a.vertice),a.pos=this.context.getUniformLocation(c,"pos"),a.texCoord=this.context.getAttribLocation(c,"texCoord"),this.context.enableVertexAttribArray(a.texCoord),a.texture=this.context.getUniformLocation(c,"texture"),this.context.activeTexture(this.context.TEXTURE0),a.projMatrix=this.context.getUniformLocation(c,"projMatrix"),c=new mighty.Math.Matrix4,c.ortho(0,this.width,this.height,
0,0,1),this.projMatrix=c):mighty.Error.error("Engine.initShaders","Unable to initialize the shader program.")},getShader:function(a){var b=null;if("shader-vs"===a)b=this.context.createShader(this.context.VERTEX_SHADER),this.context.shaderSource(b,"attribute vec2 aVertexPosition;attribute vec2 aTextureCoord;uniform vec2 pos;uniform vec2 flip;uniform mat4 uPMatrix;uniform vec2 frames;varying highp vec2 vTextureCoord;void main(void) {vec2 newPos = aVertexPosition + pos;gl_Position = uPMatrix * vec4(newPos, 0.0, 1.0);float offsetX = 1.0 / frames.x;vTextureCoord = vec2(flip.x - offsetX * ((frames.y + 1.0) - (1.0 - aTextureCoord.x)),  aTextureCoord.y);}");
else if("shader-fs"===a)b=this.context.createShader(this.context.FRAGMENT_SHADER),this.context.shaderSource(b,"varying highp vec2 vTextureCoord;uniform sampler2D uSampler;void main() {gl_FragColor = texture2D(uSampler, vTextureCoord);}");else return mighty.Error.error("Engine.getShader","Could not determine shader type."),null;this.context.compileShader(b);return!this.context.getShaderParameter(b,this.context.COMPILE_STATUS)?(mighty.Error.error("Engine.getShader","An error occured while compiling the shader ["+
a+"]: "+this.context.getShaderInfoLog(b)),null):b},getShaderFromScript:function(a){var b=document.getElementById(a);if(!b)return mighty.Error.error("Engine.getShaderFromScript","Could not get shader with an id - "+a),null;for(var c="",d=b.firstChild;d;)3==d.nodeType&&(c+=d.textContent),d=d.nextSibling;console.log(c);if("shader/fragment"==b.type)d=this.context.createShader(this.context.FRAGMENT_SHADER);else if("shader/vertex"==b.type)d=this.context.createShader(this.context.VERTEX_SHADER);else return mighty.Error.error("Engine.getShaderFromScript",
"Unknown shader type - '"+b.type+"', with an id - "+a),null;this.context.shaderSource(d,c);this.context.compileShader(d);return!this.context.getShaderParameter(d,this.context.COMPILE_STATUS)?(mighty.Error.error("Engine.getShaderFromScript","An error occurred compiling the "+b.type.split("/")[1]+" '"+a+"': "+this.context.getShaderInfoLog(d)),null):d},_loadExtensions:function(){this.extensions=["webkit","moz","ms","opera"]},initCfg:function(){var a=Engine.Cfg;a.tUpdateDeltaF=a.tUpdateDelta/1E3;var b=
Object.keys(Engine.Version);void 0===a.version?(a.version=Engine.Version[b[0]],this.version=b[0]):this.version=b[a.version]},initStyles:function(){this.parentElement&&(this.parentElement.style["-webkit-tap-highlight-color"]="rgba(0,0,0,0)",this.parentElement.style["user-select"]="none")},clear:function(){this.context.clearRect(0,0,this.width*mighty.camera.zoom,this.height*mighty.camera.zoom)},pushRenderTarget:function(a){this.prevRenderTarget=mighty.context;mighty.context=a},popRenderTarget:function(){mighty.context=
this.prevRenderTarget},updateWindowSize:function(){this.parentElement&&(this.width=this.parentElement.offsetWidth,this.height=this.parentElement.offsetHeight,0==this.height&&(this.height=window.innerHeight),0==this.width&&(this.width=window.innerWidth),this.width*=mighty.scale,this.height*=mighty.scale,this.canvas.width=this.width,this.canvas.height=this.height,this.isWebGL&&(this.projMatrix.ortho(0,this.width,this.height,0,-100,100),this.context.viewport(0,0,this.width,this.height),this.context.uniformMatrix4fv(this.context.loc.projMatrix,
!1,this.projMatrix.m)),this.updateOffset())},onResize:function(){this.updateWindowSize();null!==this.subscriber&&this.subscriber.handleResize(this.width,this.height);this.chn_Engine.signal(Engine.Event.RESIZE,this)},handleSignal_Device:function(){return!1},setCamera:function(a){mighty.camera=a;this.chn_Engine.signal(Engine.Event.CAMERA,a)},setZoom:null,_setZoom_2D:function(a){this.context.restore();this.context.save();this.context.scale(a,a);this.chn_Engine.signal(Engine.Event.ZOOM,this.zoom)},_setZoom_3D:function(){this.chn_Engine.signal(Engine.Event.ZOOM,
this.zoom)},onVisibilityChange:function(){switch(document.webkitVisibilityState){case "visible":window.top===window?this.setFocus(!0):this.setFocus(!1);this.setVisible(!0);break;case "hidden":this.setFocus(!1),this.setVisible(!1)}},subscribe:function(a){this.subscriber=a},CanvasLayer:function(a,b){this.canvas=!mighty.Device.isCocoonJS||"android"===mighty.Device.userAgent?mighty.engine.createLayer("canvas",a,b):mighty.engine.createLayer("screencanvas",a,b);Engine.Cfg.rendering===Engine.Rendering.WEBGL&&
mighty.Device.support.webGL?(this.context=this.canvas.getContext("webgl")||this.canvas.getContext("experimental-webgl"),mighty.engine.setZoom=mighty.engine._setZoom_3D,mighty.engine.context=this.context,mighty.engine.isWebGL=!0,this.context.bindVBO=null,this.context.bindTex=null,console.log("WebGL accelerated.")):(this.context=this.canvas.getContext("2d"),this.context.save(),mighty.engine.setZoom=mighty.engine._setZoom_2D);mighty.ctx=this.context;mighty.context=this.context;mighty.canvas=this.canvas;
mighty.engine.setBackgroundColor(Engine.Cfg.clearColor)},createLayer:function(a,b,c){a=document.createElement(a);b&&(a.style.cssText=b);c&&c.appendChild(a);return a},initUI:function(a){"string"===typeof a&&(a=document.getElementById(a));this.parentElement=a?a:this.createLayer("div","width: 100%; height: 100%; position: absolute; left: 0; top: 0;",document.body);this.canvasElement=this.createLayer("div","width: 100%; height: 100%; position: absolute; left: 0; top: 0;");this.canvasElement.setAttribute("id",
this.canvasElementID);this.domElement=this.createLayer("div","width: 100%; height: 100%; position: absolute; left: 0; top: 0;");this.domElement.setAttribute("id",this.uiElementID);a=new this.CanvasLayer("width: 100%; height: 100%; position: absolute; left: 0; top: 0;",this.canvasElement);this.canvas=a.canvas;this.context=a.context;this.parentElement.appendChild(this.canvasElement);this.parentElement.appendChild(this.domElement)},initEvents:function(a){var b=this;this.canvasInput=a?window:this.parentElement;
this.canvasInput=window.document;window.onfocus=function(){b.setFocus(!0)};window.onblur=function(){b.setFocus(!1)};window.onresize=function(){b.onResize()};window.onorientationchange=function(){b.onResize()};-1<navigator.userAgent.toLowerCase().indexOf("chrome")?(this.onVisibilityChange(),this._onVisibilityChange=function(){b.onVisibilityChange()},document.addEventListener("webkitvisibilitychange",this._onVisibilityChange,!1)):(window.onfocus=function(){b.setFocus(!0);b.setVisible(!0)},window.onblur=
function(){b.setFocus(!1);b.setVisible(!1)})},releaseListeners:function(){Input.plugin&&Input.plugin.releaseListeners();-1<navigator.userAgent.toLowerCase().indexOf("chrome")&&document.removeEventListener("webkitvisibilitychange",this._onVisibilityChange,!1)},setFocus:function(a){this.isFocus!==a&&(this.isFocus=a,this.chn_Engine.signal(Engine.Event.FOCUS,a))},setVisible:function(a){this.isVisible=a},updateOffset:function(){this.offsetTop=this.offsetLeft=0;var a=this.canvasElement;if(a.offsetParent){do this.offsetLeft+=
a.offsetLeft,this.offsetTop+=a.offsetTop;while(a=a.offsetParent)}},setBackgroundColor:function(a){this._bgColor=a;if(!Engine.Cfg.fillScreen||!mighty.Device.isCocoonJS)document.body.style.backgroundColor=a},set bgColor(a){this.setBackgroundColor(a)},get bgColor(){return this._bgColor},convertToVersion:function(a,b,c){return a<<24|b<<16|c<<8},setScale:function(a){mighty.scale=a;this.updateWindowSize()},name:"MightyEngine",version:"",build:890,cfg:null,params:null,canvas:null,context:null,canvasInput:null,
prevRenderTarget:null,parentElement:null,canvasElement:null,domElement:null,offsetLeft:0,offsetTop:0,width:800,height:600,zoom:1,_bgColor:"#555",subscriber:null,blockInput:!0,filter:null,isVisible:!0,isFocus:!1,isWebGL:!1,canvasElementID:"canvas-view",uiElementID:"ui-view",extensions:null,chn_Engine:null,chn_Device:null};mighty.canvas=null;mighty.context=null;mighty.camera=null;for(key in tempObj)Engine[key]=tempObj[key];tempObj=void 0;mighty.EmptyFunc=function(){};
window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1E3/60)}}());window.CloneJSON=function(a,b){for(var c in a)b[c]=a[c]};mighty.Clone=function(a){var b=new a.constructor,c;for(c in a)b[c]=a[c];return b};window.IsDefined=function(a){return"undefined"!==typeof a&&null!==a};
window.IsEqual=function(a,b){return 1E-12>Math.abs(a-b)?!0:!1};function NullResize(a,b){a.length=b;for(var c=a.length;c<b;c++)a[c]=null}function IsObjectEmpty(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}
window.Palette=Class.extend({init:function(a){this.name=a;this.items=[]},add:function(a){null===a||"undefined"===typeof a?console.log("(warning) Palette: Adding undefined item."):(this.cachedItem=a,this.items.push(a),this.numItems++)},getByID:function(a){if(0===this.numItems)return null;if(this.cachedItem.id===a)return this.cachedItem;for(var b=0;b<this.numItems;++b){var c=this.items[b];if(c.id===a)return this.cachedItem=c}return null},getByName:function(a){if(0===this.numItems)return null;if(this.cachedItem.name===
a)return this.cachedItem;for(var b=0;b<this.numItems;++b){var c=this.items[b];if(c.name===a)return this.cachedItem=c}return null},getByType:function(a){for(var b=null,c=[],d=0;d<this.numItems;d++)b=this.items[d],b.type===a&&c.push(b);return c},getByGroup:function(a){for(var b=null,c=[],d=0;d<this.numItems;d++)b=this.items[d],b.group===a&&c.push(b);return c},name:"",items:null,numItems:0,cachedItem:null});window.Palettes={};mighty.Math={};mighty.Math.ToRadians=function(a){return a*Math.PI/180};
mighty.Math.ToDegree=function(a){return 180*a/Math.PI};mighty.Math.RadiansToPoint=function(a,b,c,d){return Math.atan((c-a)/(d-b))};mighty.Math.Map=function(a,b,c,d,e){return a==b?d:(a-b)*(e-d)/(c-b)+d};mighty.Math.Length2=function(a,b){return Math.sqrt(a*a+b*b)};mighty.Math.LookAt=function(a,b,c,d){return Math.atan2(c-a,b-d)};mighty.Math.LookAtEntity=function(a,b){return mighty.Math.LookAt(a.x,a.y,b.x,b.y)};mighty.Math.Map=function(a,b,c,d,e){return a==b?d:(a-b)*(e-d)/(c-b)+d};
mighty.Math.AABB=function(a,b,c,d){this.minX=a;this.minY=b;this.maxX=c;this.maxY=d};
mighty.Math.AABB.prototype={translate:function(a,b){this.minX+=a;this.minY+=b;this.maxX+=a;this.maxY+=b},move:function(a,b){var c=this.maxX-this.minX,d=this.maxY-this.minY;this.minX=a;this.minY=b;this.maxX=a+c;this.maxY=b+d},resize:function(a,b){this.maxX=this.minX+a;this.maxY=this.minY+b},copy:function(a){this.minX=a.minX;this.minY=a.minY;this.maxX=a.maxX;this.maxY=a.maxY},vsAABB:function(a){return this.minX>a.maxX||this.maxX<a.minX||this.minY>a.maxY||this.maxY<a.minY?!1:!0},vsBorderAABB:function(a){return this.minX>=
a.maxX||this.maxX<=a.minX||this.minY>=a.maxY||this.maxY<=a.minY?!1:!0},vsAABBIntersection:function(a){return this.minX>a.maxX||this.maxX<a.minX||this.minY>a.maxY||this.maxY<a.minY?0:this.minX>a.minX||this.minY>a.minY||this.maxX<a.maxX||this.maxY<a.maxY?1:2},vsPoint:function(a,b){return this.minX>a||this.maxX<a||this.minY>b||this.maxY<b?!1:!0},vsBorderPoint:function(a,b){return this.minX>=a||this.maxX<=a||this.minY>=b||this.maxY<=b?!1:!0},getSqrDistance:function(a,b){var c,d=0;a<this.minX&&(c=this.minX-
a,d+=c*c);a>this.maxX&&(c=a-this.maxX,d+=c*c);b<this.minY&&(c=this.minY-b,d+=c*c);b>this.maxY&&(c=b-this.maxY,d+=c*c);return d},isUndefined:function(){return void 0===this.maxY},draw:function(a){var b=Math.round(this.minX),c=Math.round(this.minY),d=Math.round(this.maxX),e=Math.round(this.maxY);a.beginPath();a.moveTo(b-0.5,c-0.5);a.lineTo(d+0.5,c-0.5);a.lineTo(d+0.5,e+0.5);a.lineTo(b-0.5,e+0.5);a.lineTo(b-0.5,c-0.5);a.stroke()},drawTranslated:function(a){var b=mighty.camera;this.translate(b.x,b.y);
this.draw(a);this.translate(-b.x,-b.y)},print:function(a){a?console.log("(AABB) "+a+" minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY):console.log("(AABB) minX: "+this.minX+" minY: "+this.minY+" maxX: "+this.maxX+" maxY: "+this.maxY)}};mighty.Math.Vector2=function(a,b){this.x=a;this.y=b};
mighty.Math.Vector2.prototype={reset:function(){this.y=this.x=0},set:function(a,b){this.x=a;this.y=b},sub:function(a){this.x-=a;this.y-=a},mul:function(a){this.x*=a;this.y*=a},subVec2:function(a){this.x-=a.x;this.y-=a.y},mulVec2:function(a){this.x*=a.x;this.y*=a.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},normalize:function(){var a=Math.sqrt(this.x*this.x+this.y*this.y);0===a?this.y=this.x=0:(this.x/=a,this.y/=a)},dot:function(a,b){return this.x*a+this.y*b},truncate:function(a){Math.sqrt(this.x*
this.x+this.y*this.y)>a&&(this.normalize(),this.x*=a,this.y*=a)},limit:function(a){this.x>a&&(this.x=a);this.y>a&&(this.y=a)},lengthSq:function(){return this.x*this.x+this.y*this.y},perp:function(){var a=this.x;this.x=-this.y;this.y=a},print:function(a){a?console.log('[vec "'+a+'"] x: '+this.x+" y: "+this.y):console.log("[vec] x: "+this.x+" y: "+this.y)}};mighty.Math.Sphere=function(a,b,c){this.x=a;this.y=b;this.radius=c};
mighty.Math.Sphere.prototype={move:function(a,b){this.x=a+this.radius;this.y=b+this.radius},translate:function(a,b){this.x+=a;this.y+=b},resize:function(a){this.radius=a},copy:function(a){a.x=this.x;a.y=this.y;a.radisu=this.radius},vsSphere:function(a){var b=this.x-a.x,c=this.y-a.y,a=this.radius+a.radius;return b*b+c*c<a*a},vsBorderSphere:function(a){var b=this.x-a.x,c=this.y-a.y,a=this.radius+a.radius;return b*b+c*c<=a*a},vsPoint:function(a,b){var c=Math.abs(this.x-a),d=Math.abs(this.y-b);return c<
this.radius&&d<this.radius},vsBorderPoint:function(a,b){var c=Math.abs(this.x-a),d=Math.abs(this.y-b);return c<=this.radius&&d<=this.radius},vsAABB:function(a){return a.getSqrDistance(this.x,this.y)<this.radius*this.radius},vsBorderAABB:function(a){return a.getSqrDistance(this.x,this.y)<=this.radius*this.radius},draw:function(a){a.beginPath();a.arc(this.x,this.y,this.radius,0,2*Math.PI,!1);a.stroke()},drawTranslated:function(a){var b=mighty.camera;this.translate(b.x,b.y);this.draw(a);this.translate(-b.x,
-b.y)},print:function(a){a?console.log("(Sphere) "+a+" x: "+this.x+" y: "+this.y+" radius: "+this.radius):console.log("(Sphere) x: "+this.x+" y: "+this.y+" radius: "+this.radius)}};mighty.Math.Random=function(){this.oneOverM=this.r=this.q=this.m=this.a=this.seed=0;this.init()};
mighty.Math.Random.prototype={init:function(){this.setSeed(3456789012,!0)},generate:function(){var a=this.a*(this.seed%this.q)-this.r*Math.floor(this.seed/this.q);this.seed=0<a?a:a+this.m;return this.seed*this.oneOverM},getNumber:function(a,b){var c=this.generate();return Math.round((b-a)*c+a)},getNumberF:function(a,b){var c=this.generate();return(b-a)*c+a},setSeed:function(a,b){void 0!==b&&(b=!0);if(!0===b){var c=new Date;this.seed=a+16777215*c.getSeconds()+65535*c.getMinutes()}else this.seed=a;
this.a=48271;this.m=2147483647;this.q=Math.floor(this.m/this.a);this.r=this.m%this.a;this.oneOverM=1/this.m}};mighty.Random=new mighty.Math.Random;mighty.Math.DrawAABB=function(a,b,c,d){this.minX=a;this.minY=b;this.maxX=c;this.maxY=d;this.offsetY=this.offsetX=0;this.sizeX=c-a;this.sizeY=d-b;this.initSizeX=this.sizeX;this.initSizeY=this.sizeY;this.x=this.minX+this.sizeX/2;this.y=this.minY+this.sizeY/2};
mighty.Math.DrawAABB.prototype={reinit:function(a,b,c,d){this.minX=a;this.minY=b;this.maxX=c;this.maxY=d;this.offsetY=this.offsetX=0;this.sizeX=c-a;this.sizeY=d-b;this.initSizeX=this.sizeX;this.initSizeY=this.sizeY;this.x=this.minX+this.sizeX/2;this.y=this.minY+this.sizeY/2},translate:function(a,b){this.minX+=a;this.minY+=b;this.maxX+=a;this.maxY+=b},move:function(a,b){this.minX=a+this.offsetX;this.minY=b+this.offsetY;this.maxX=this.minX+this.sizeX;this.maxY=this.minY+this.sizeY},resize:function(a,
b){this.sizeX=a;this.sizeY=b;this.maxX=this.minX+this.sizeX;this.maxY=this.minY+this.sizeY},scale:function(a,b){this.sizeX=this.initSizeX*a;this.sizeY=this.initSizeY*b;var c=(this.initSizeX-this.sizeX)/2,d=(this.initSizeY-this.sizeY)/2;this.minX+=c-this.offsetX;this.minY+=d-this.offsetY;this.maxX=this.minX+this.sizeX;this.maxY=this.minY+this.sizeY;this.offsetX=c;this.offsetY=d},copy:function(a){this.minX=a.minX;this.minY=a.minY;this.maxX=a.maxX;this.maxY=a.maxY;this.sizeX=a.sizeX;this.sizeY=a.sizeY},
vsAABB:function(a){return this.minX>a.maxX||this.maxX<a.minX||this.minY>a.maxY||this.maxY<a.minY?!1:!0},vsBorderAABB:function(a){return this.minX>=a.maxX||this.maxX<=a.minX||this.minY>=a.maxY||this.maxY<=a.minY?!1:!0},vsPoint:function(a,b){return this.minX>a||this.maxX<a||this.minY>b||this.maxY<b?!1:!0},vsBorderPoint:function(a,b){return this.minX>=a||this.maxX<=a||this.minY>=b||this.maxY<=b?!1:!0},getSqrDistance:function(a,b){var c,d=0;a<this.minX&&(c=this.minX-a,d+=c*c);a>this.maxX&&(c=a-this.maxX,
d+=c*c);b<this.minY&&(c=this.minY-b,d+=c*c);b>this.maxY&&(c=b-this.maxY,d+=c*c);return d},isUndefined:function(){return void 0===this.maxY},draw:function(a){var b=Math.round(this.minX),c=Math.round(this.minY),d=Math.round(this.maxX),e=Math.round(this.maxY);a.beginPath();a.moveTo(b-0.5,c-0.5);a.lineTo(d+0.5,c-0.5);a.lineTo(d+0.5,e+0.5);a.lineTo(b-0.5,e+0.5);a.lineTo(b-0.5,c-0.5);a.stroke()},drawTranslated:function(a){var b=mighty.camera;this.translate(b.x,b.y);this.draw(a);this.translate(-b.x,-b.y)},
set width(a){this.sizeX=a},set height(a){this.sizeY=a},get width(){return this.sizeX},get height(){return this.sizeY},print:function(a){a?console.log("(DrawAABB) "+a+" x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+" w: "+this.maxY):console.log("(DrawAABB) x: "+this.minX+" y: "+this.minY+" z: "+this.maxX+" w: "+this.maxY)}};mighty.Math.Matrix4=function(){this.m=new Float32Array(16);this.m[0]=1;this.m[5]=1;this.m[10]=1;this.m[15]=1};
mighty.Math.Matrix4.prototype={ortho:function(a,b,c,d,e,f){this.m[0]=2/(b-a);this.m[1]=0;this.m[2]=0;this.m[3]=0;this.m[4]=0;this.m[5]=2/(d-c);this.m[6]=0;this.m[7]=0;this.m[8]=0;this.m[9]=0;this.m[10]=-2/(f-e);this.m[11]=0;this.m[12]=-(b+a)/(b-a);this.m[13]=-(d+c)/(d-c);this.m[14]=-(f+e)/(f-e);this.m[15]=1}};mighty.Flag=function(){this.bits=0;this.lastBits=1;this.bitsTotal=0;this.flags={};this.deactivateCB=this.cb=null};
mighty.Flag.prototype={add:function(a){if(void 0!==this.flags[a])mighty.Error.error("mighty.Flag.add","There is already flag with a name - "+a);else{var b=this.lastBits;this.bitsTotal|=b;this.lastBits<<=1;this.flags[a]=new mighty.FlagInfo("",0,b)}},add_Signal:function(a,b,c){if(void 0!==this.flags[a])mighty.Error.error("mighty.Flag.add_Signal","There is already flag with a name - "+a);else{var d=this.lastBits;this.bitsTotal|=d;this.lastBits<<=1;this.flags[a]=new mighty.FlagInfo(b,c,d);var e=this;
SubscribeChannel(this,b,function(b){b===e.flags[a].event&&e.activate(a)})}},activate:function(a){a=this.flags[a];void 0!==a&&!(this.bits&a.bits)&&(this.bits|=a.bits,a.chn&&UnsubscribeChannel(this,a.chn),this.bits===this.bitsTotal&&this.cb&&this.cb())},deactivate:function(a){var b=this.flags[a];if(void 0!==b&&this.bits&b.bits){this.bits^=b.bits;if(b.chn){var c=this;SubscribeChannel(this,b.chn,function(b){b===c.flags[a].event&&c.activate(a)})}this.deactivateCB&&this.deactivateCB()}},is:function(a){return void 0===
this.flags[a]?!1:this.bits&this.flag.bits?!0:!1}};mighty.FlagInfo=function(a,b,c){this.chn=a;this.event=b;this.bits=c};mighty.Serialize=function(a){var b=[],c;for(c in a)b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));return b.join("&")};
mighty.Ajax=function(a){a.responseType="html"===a.dataType?"document":"script"===a.dataType||"json"===a.dataType?"text":void 0===a.dataType?"GET":a.dataType;var b=mighty.Serialize(a.data),c=new XMLHttpRequest;c.open(a.type,a.url,!0);c.setRequestHeader("Content-type","application/x-www-form-urlencoded");c.onload=function(){4===c.readyState&&200===c.status?void 0!==a.success&&("document"===a.responseType?a.success(c.responseXML):"script"===a.dataType?a.success(eval(c.responseText)):"json"===a.dataType?
a.success(JSON.parse(c.responseText)):a.success(c.responseText)):void 0!==a.error&&a.error()};c.send(b);return c};
mighty.Coord={load:function(){this._cfg=Terrain.Cfg;this._cfg.type===Terrain.Type.ISOMETRIC?(this.toWorld=this._toWorld_Isometric,this.toGrid=this._toGrid_Isometric):(this.toWorld=this._toWorld_TopDown,this.toGrid=this._toGrid_TopDown)},_toWorld_TopDown:function(a){a.x*=this._cfg.grid.width;a.y*=this._cfg.grid.height;return a},_toWorld_Isometric:function(a){this._x=a.x;this._y=a.y;a.x=(this._y-this._x)*this._cfg.grid.halfWidth;a.y=(this._y+this._x)*this._cfg.grid.halfHeight;return a},_toGrid_TopDown:function(a){a.x=
Math.floor(a.x/this._cfg.grid.width);a.y=Math.floor(a.y/this._cfg.grid.height);return a},_toGrid_Isometric:function(a){this._x=a.x;this._y=a.y;this._width=this._cfg.grid.width;this._height=this._cfg.grid.height;a.x=Math.round(this._y/this._height-this._x/this._width);a.y=Math.round(this._x/this._width+this._y/this._height);return a},_cfg:null,_x:0,_y:0,_width:0,_height:0,toWorld:null,toGrid:null};function BinaryHeap(a){this.content=[];this.length=0;this.scoreFunction=a}
BinaryHeap.prototype={push:function(a){this.content.push(a);this.length++;this.sinkDown(this.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();this.length--;0<this.length&&(this.content[0]=b,this.bubbleUp(0));return a},remove:function(a){var b=this.content.indexOf(a),c=this.content.pop();this.length--;b!==this.numConents-1&&(this.content[b]=c,this.scoreFunction(c)<this.scoreFunction(a)?this.sinkDown(b):this.bubbleUp(b))},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},
sinkDown:function(a){for(var b=this.content[a];0<a;){var c=(a+1>>1)-1,d=this.content[c];if(this.scoreFunction(b)<this.scoreFunction(d))this.content[c]=b,this.content[a]=d,a=c;else break}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=a+1<<1,f=e-1,g=null;if(f<b){var h=this.scoreFunction(this.content[f]);h<d&&(g=f)}if(e<b&&this.scoreFunction(this.content[e])<(null===g?d:h))g=e;if(null!==g)this.content[a]=this.content[g],this.content[g]=c,a=g;else break}}};
var ByteBuffer=Class.extend({init:function(a){this.data=Array(a);this.length=a;for(a=0;a<this.length;++a)this.data[a]=0},writeByte:function(a){this.data[this.offset]=a&255;this.offset++},writeShort:function(a){this.data[this.offset+1]=a&255;this.data[this.offset]=a>>8&255;this.offset+=2},writeInt:function(a){this.data[this.offset+3]=a&255;a>>=8;this.data[this.offset+2]=a&255;a>>=8;this.data[this.offset+1]=a&255;this.data[this.offset]=a>>8&255;this.offset+=4},readByte:function(){var a=this.data[this.offset];
this.offset++;return a},readShort:function(){var a=(this.data[this.offset]<<8)+this.data[this.offset+1];this.offset+=2;return a},readInt:function(){var a=(this.data[this.offset]<<24)+(this.data[this.offset+1]<<16)+(this.data[this.offset+2]<<8)+this.data[this.offset+3];this.offset+=4;return a},eof:function(){return this.offset===this.length?!0:!1},reset:function(){this.offset=0},resize:function(a){this.length=this.data.length=a;this.offset>a&&(this.offset=a)},setBuffer:function(a){this.data=a;this.length=
a.length;this.offset=0},setData:function(a){this.length=a.length;this.offset=0;this.data.length=this.length;for(var b=0;b<this.length;++b)this.data[b]=a.charCodeAt(b)},getData:function(){for(var a="",b=0;b<this.offset;++b)a+=String.fromCharCode(this.data[b]);return a},data:"",offset:0});
function DepthList(){this.length=0;this.firstNode=new DepthListNode(null);this.lastNode=new DepthListNode(null);this.firstNode.depth=-2147483648;this.firstNode.next=this.lastNode;this.lastNode.depth=2147483648;this.lastNode.prev=this.firstNode}
DepthList.prototype={push:function(a){var b=null,c=this.firstNode;do{if(a.depth<c.depth){a.prev=b;a.next=c;c.prev=a;b.next=a;this.length++;return}b=c;c=c.next}while(c);console.log("Error: DEPTH LIST - OUT OF BONDS")},remove:function(a){null!==a.next&&(a.next&&(a.next.prev=a.prev),a.prev&&(a.prev.next=a.next),a.next=null,a.prev=null,this.length--)},update:function(a){var b=a.prev;if(b){if(b!==this.firstNode&&b.depth>a.depth){a.next.prev=a.prev;a.prev.next=a.next;do{if(b.depth<a.depth){a.prev=b;a.next=
b.next;a.next.prev=a;b.next=a;return}b=b.prev}while(b)}b=a.next;if(b!==this.lastNode&&b.depth<a.depth){a.next.prev=a.prev;a.prev.next=a.next;do{if(b.depth>a.depth){a.next=b;a.prev=b.prev;a.prev.next=a;b.prev=a;break}b=b.next}while(b)}}},print:function(){if(0===this.length)console.log("Empty");else{var a=this.firstNode.next;a&&console.log("FirstNode: "+a.depth);do console.log(a.depth),a=a.next;while(a!==this.lastNode);this.lastNode.prev&&console.log("LastNode: "+this.lastNode.prev.depth)}}};
function DepthListNode(a){this.entity=a;this.depth=0;this.next=this.prev=null}
function PriorityList(a){this.push=function(a){a=new PriorityListNode(a,this.itemFunc(a));this.length++;if(null===this.firstNode)this.firstNode=a;else{for(var c=a.value,d=null,e=this.firstNode;e;){if(c<e.value){a.prev=d;a.next=e;e.prev=a;d&&(d.next=a);e===this.firstNode&&(this.firstNode=a);return}d=e;e=e.next}a.prev=d;d.next=a}this.lastNode=a};this.remove=function(a){if(this.firstNode&&this.firstNode.item===a)this.firstNode=this.firstNode.next,this.firstNode.prev=null;else if(this.lastNode&&this.lastNode.value===
a)this.lastNode=this.lastNode.prev,this.lastNode.next=null;else{var c=this.firstNode,d=c.next;do{if(d.item===a){c.next=d.next;d.next.prev=c;break}c=d;d=d.next}while(d)}};this.popFront=function(){if(null===this.firstNode)return null;var a=this.firstNode.next;a&&(a.prev=null,this.firstNode=a);this.length--;return this.firstNode.item};this.popBack=function(){if(null===this.lastNode)return null;var a=this.lastNode.prev;a.next=null;this.lastNode=a;this.length--;return this.lastNode.item};this.pushBtw=
function(a,c){a.prev=c.prev;a.next=c;c.prev.next=a;c.prev=a};this.print=function(){var a=this.firstNode;do console.log(a.value),a=a.next;while(a)};this.itemFunc=a;this.length=0;this.lastNode=this.firstNode=null}function PriorityListNode(a,b){this.item=a;this.value=b;this.next=this.prev=null}mighty.Profiler={start:function(a){this.msg=a;this.tStart=Date.now()},stop:function(){var a=Date.now()-this.tStart;console.log(this.msg+": "+a+"ms")},msg:"",tStart:0};var PluginPalette=Plugin.palette;
Plugin=Class.extend({init:function(){},initCfg:function(){},install:function(){},unload:function(){},_init:function(){this.timers=[];this.timersToRemove=[]},_initCfg:function(){"undefined"!==typeof this.scope.Cfg&&(this.cfg=this.scope.Cfg)},_install:function(){if(!this.name)return console.log("(Warning) Plugin: Could not add plugin without name!"),!1;this._initCfg();this.initCfg();this.installModules();this.loadPalette();this.scene.addPlugin(this);return!0},uninstall:function(){},installModules:function(){this.module=
{};this.modules=[];var a=this.scope.Module;if(a)for(var b in a)(a=this.scope.Module[b])||console.log("(Warning) (Plugin:"+this.name+"): Could not find module with name: "+b),a=new a,a._init(this,b),void 0!==a.setup&&a.setup(),this.module[b]=a,this.modules.push(a)},_unload:function(){this.timers.length=0;this.numTimersToRemove=this.numTimers=this.timersToRemove.length=0},ready:function(){},load:function(){this.loadModules()},loadModules:function(){for(var a,b=this.modules.length,c=0;c<b;c++)a=this.modules[c],
void 0!==a.load&&a.load()},loadPalette:function(){this.palette=new Palette(this.name);Palettes[this.name]=this.palette;if(this.scope.palette){var a=!0;void 0!==this.cfg&&void 0!==this.cfg.isTemplate&&(a=this.cfg.isTemplate);a?this.loadPaletteAsTemplate():this.loadPaletteAsObj()}},loadPaletteAsTemplate:function(){var a=Template.Entity,b=this.scope.palette,c=b.length,d,e;if("Map"===this.name||"UI"===this.name)for(d=0;d<c;d++){e=b[d];e.type=0;var f=new a(e.id,e.name,e.type);f.setBrush(e.texture);f.loadHead(e);
f.loadBody(e.body);f.loadFooter(e.footer);this.palette.add(f)}else if("Component"!==this.name)for(d=0;d<c;d++)e=b[d],f=new a(e.id,e.name,e.type),void 0!==f.obj&&(f.setBrush(e.brush),f.loadHead(e),f.loadBody(e.body),f.loadFooter(e.footer),this.palette.add(f));else for(d=0;d<c;d++)e=b[d],this.palette.add(e)},loadPaletteAsObj:function(){var a,b,c,d=null,e=this.scope.Obj,f=this.scope.palette,g=f.length;for(a=0;a<g;a++)c=f[a],b=e[c.type],void 0===this.scope[b]?mighty.Error.submit("Plugin::"+this.name,
"Could not find object with a name - "+b):(d=Resource.plugin.module.Texture.getByID(parseInt(c.texture)),b=new this.scope[b],b.setup(c.id,c.name,d),this.palette.add(b));for(a=0;a<g;a++)c=f[a],b=this.palette.items[a],c.head&&b.loadVar(c.head),c.body&&b.loadVar(c.body),c.footer&&b.load(c.footer),b.update()},updateTimer:function(a){var b,c;for(b=0;b<this.numTimers;b++)if(c=this.timers[b],!c.isPaused)for(c.tAccumulator+=a;c.tAccumulator>=c.tDelta;)if(c.tAccumulator-=c.tDelta,0!==c.numTimes&&c.func(c),
c.tStart+=c.tDelta,-1!==c.numTimes&&(c.numTimes--,0>=c.numTimes)){this.timersToRemove.push(c);this.numTimersToRemove++;break}if(0<this.numTimersToRemove){for(b=0;b<this.numTimersToRemove;b++)this.removeTimer(this.timersToRemove[b]);this.timersToRemove=[];this.numTimersToRemove=0}},addTimer:function(a,b,c){a=new mighty.Timer(this,a,b,c);this.timers.push(a);this.numTimers++;1===this.numTimers&&this.scene.addPluginTimer(this);return a},removeTimer:function(a){for(var b=0;b<this.numTimers;b++){var c=
this.timers[b];if(c.id===a.id){c.removeFunc&&c.removeFunc();this.timers[b]=this.timers[this.numTimers-1];this.timers.pop();this.numTimers--;break}}0===this.numTimers&&this.scene.removePluginTimer(this)},removeAllTimers:function(){this.numTimers=this.timers.length=0;this.scene.removePluginTimer(this)},id:0,priority:500,scope:null,cfg:null,palette:null,module:null,modules:null,name:"",scene:null,subscriber:null,timers:null,timersToRemove:null,numTimers:0,numTimersToRemove:0,isLoaded:!1});
mighty.Module=Class.extend({_init:function(a,b){this.mgr=a;this.name=b},setup:function(){},load:function(){},mgr:null,userMgr:null,name:""});mighty.CreateModule=function(a,b,c){a=window[a];void 0===a.Module&&(a.Module={});a.Module[b]=mighty.Module.extend(c)};mighty.CreateModuleEx=function(a,b,c,d){a=window[a];void 0===a.Module&&(a.Module={});void 0===a[c]?mighty.Error.submit("CreateModuleEx","Could not find class - "+c):a.Module[b]=a[c].extend(d)};
mighty.GetModule=function(a,b){var c=window[a];if(void 0===c||void 0===c.plugin)return mighty.Error.submit("GetModule","No such plugin loaded '"+a+"'"),null;c=c.plugin.module[b];return void 0==c?(mighty.Error.submit("GetModule","No such module '"+b+"' in the scope '"+a+"'"),null):c};mighty.timerIndex=0;
mighty.Timer=function(a,b,c,d){this.remove=function(){this.numTimes=0};this.pause=function(){this.isPaused=!0};this.resume=function(){this.isPaused=!1;this.tStart=Date.now()};this.id=mighty.timerIndex++;this.plugin=a;this.func=b;this.removeFunc=null;this.tDelta=c;this.numTimes=d;void 0===this.numTimes&&(this.numTimes=-1);this.tAccumulator=0;this.isPaused=!1};Component.Manager=Plugin.extend({});Component.Basic=function(){this.name="Basic"};
Entity.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+101;Engine.Cfg.fillScreen||mighty.Device.isCocoonJS?this.clearScreen=this._clearScreen_fill:Engine.Cfg.rendering===Engine.Rendering.WEBGL&&(this.clearScreen=this._clearScreen_WebGL);Engine.Cfg.rendering===Engine.Rendering.WEBGL?(this.clearScreen=this._clearScreen_WebGL,this.drawScreen=this._drawScreen_WebGL):this.drawScreen=this._drawScreen;!mighty.engine.isWebGL&&Engine.Cfg.rendering===Engine.Rendering.NONE&&(this.render=
mighty.EmptyFunc);this.entitiesToRemove=[];this.initBuffers()},initBuffers:function(){var a,b,c,d,e;for(e in this.entitiesMap){a=this.entitiesMap[e];b=a.length;for(c=0;c<b;c++)d=a[c],d.remove()}this.numEntitiesToRemove&&this.handleRemove();this.updateEntities=[];this.redrawEntities=[];this.visibleEntities=new DepthList;this.animEntities=new DepthList;this.visibleFirst=this.visibleEntities.firstNode;this.visibleLast=this.visibleEntities.lastNode;this.animFirst=this.animEntities.firstNode;this.animLast=
this.animEntities.lastNode;this.entitiesMap={};this.grid=this.instanceEntities=this.instance=this.level=null;this.numRedrawEntities=this.numUpdateEntities=0},install:function(){this.chn_Entity=CreateChannel("Entity.OUT");this.chn_EntityInteract=CreateChannel("EntityInteract");var a=this;SubscribeChannel(this,"Entity.IN",function(b,c){return a.handleSignal_EntityInt(b,c)});SubscribeChannel(this,"Engine",function(b,c){a.handleSignal_Engine(b,c)});SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,
c)});this.patchMgr=this.scene.patchMgr;this.terrainMgr=this.scene.terrainMgr;this.visiblePatchs=this.patchMgr.visiblePatchs;mighty.editor&&(this.cfg.input.picking.pickAbleFlag=!1)},load:function(){this.level=this.scene.level;this.instance=[];this.instanceEntities={};this.terrainCfg=Terrain.Cfg;this.gridCfg=this.terrainCfg.grid;switch(Terrain.Cfg.type){case Terrain.Type.TOP_DOWN:Entity.Geometry.prototype.drawGrid=Entity.Geometry.prototype._drawGrid_TopDown;Entity.Geometry.prototype.calcDrawOffset=
Entity.Geometry.prototype._calcDrawOffset_TopDown;Entity.Geometry.prototype.updateDepth=this.cfg.depthSorting===Entity.DepthSorting.WEIGHTED?Entity.Geometry.prototype._updateDepth_TopDown:Entity.Geometry.prototype._updateDepth_Manual;this.updateGridPos=this._updateGridPos_TopDown;this.drawInstanceGrid=this._drawInstanceGrid_TopDown;break;case Terrain.Type.ISOMETRIC:Entity.Geometry.prototype.drawGrid=Entity.Geometry.prototype._drawGrid_Isometric,Entity.Geometry.prototype.calcDrawOffset=Entity.Geometry.prototype._calcDrawOffset_Isometric,
Entity.Geometry.prototype.updateDepth=this.cfg.depthSorting===Entity.DepthSorting.WEIGHTED?Entity.Geometry.prototype._updateDepth_Isometric:Entity.Geometry.prototype._updateDepth_Manual,this.updateGridPos=this._updateGridPos_Isometric,this.drawInstanceGrid=this._drawInstanceGrid_Isometric}var a=this;SubscribeChannel(this,"Camera",function(b,c){a.handleSignal_Camera(b,c)});this._super();this.loadLevel();this.terrainCfg.type===Terrain.Type.ISOMETRIC&&(this._offsetX=-(this.level.numTilesX*this.terrainCfg.halfTileWidth),
this._offsetY=this.level.numTilesY*this.terrainCfg.halfTileHeight-this.terrainCfg.tileHeight);if(this.emptyEntityInst=this.addFromInfo(new Entity.Info(Palettes.Entity.getByName("null"),0,0)))this.emptyEntityInst.texture=null,this.emptyEntityInst.isSaved=!1,this.emptyEntityInst.setVisible(!1)},unload:function(){this.numEntitiesToRemove&&this.handleRemove();this.initBuffers();mighty.context.clearRect(0,0,this.camera.width,this.camera.height)},update:function(a){for(var b=null,c=0;c<this.numUpdateEntities;c++)b=
this.updateEntities[c],b.update(a),b.updateComponents(a);this.camera.update(a);this.numEntitiesToRemove&&this.handleRemove()},render:function(a,b){for(var c=null,d=this.visibleFirst.next;d!==this.visibleLast;d=d.next)c=d.entity,c.isNeedRemove||(c.wasCleared=!1,c.isNeedStage&&c.updateStage(),c.isAnimating&&c.updateAnim(b),c.isNeedDraw&&c._isVisible&&(this.isNeedRender=!0));this.isNeedRender&&(this.isJustRendered=!1,this.isNeedRender&&(Scene.plugin.state.trueFPS++,this.drawScreen(),this.isJustRendered=
!0),this.grid&&this.terrainMgr.cfg.grid.showDebug&&this.grid.draw(mighty.context))},clearScreen:function(){mighty.context.clearRect(0,0,this.camera.width,this.camera.height)},_clearScreen_fill:function(){var a=mighty.context;a.fillStyle=mighty.engine._bgColor;a.fillRect(0,0,this.camera.width,this.camera.height)},_clearScreen_WebGL:function(){var a=mighty.context;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT)},drawScreen:mighty.EmptyFunc,_drawScreen:function(){var a=this.camera,b=mighty.context;b.restore();
b.save();b.scale(a.zoomValue,a.zoomValue);this.clearScreen();this.terrainCfg.visible&&this.drawInstanceGrid(b);if(this.terrainCfg.showDebug){var c=this.terrainCfg.volume;b.save();b.beginPath();b.strokeStyle="red";b.moveTo(c.minX+a.x-0.5,c.minY+a.y-0.5);b.lineTo(c.maxX+a.x+0.5,c.minY+a.y-0.5);b.lineTo(c.maxX+a.x+0.5,c.maxY+a.y+0.5);b.lineTo(c.minX+a.x-0.5,c.maxY+a.y+0.5);b.lineTo(c.minX+a.x-0.5,c.minY+a.y-0.5);b.stroke();b.restore()}this.patchMgr.cfg.isDebug&&this.patchMgr.drawDebug();a=null;for(c=
this.visibleFirst.next;c!==this.visibleLast;)a=c.entity,a._isVisible&&(a.draw(b),a.isNeedDraw=!1),c=c.next;if(this.cfg.debug.drawGrid)for(c=this.visibleFirst.next;c!==this.visibleLast;)a=c.entity,a._isVisible&&a.drawGrid(b),c=c.next;if(this.isDrawBounds||this.cfg.debug.drawBounds)if(b.strokeStyle="red",c=this.visibleFirst.next,this.cfg.debug.drawBounds)for(;c!==this.visibleLast;)a=c.entity,a._isVisible&&a.drawBounds(b),c=c.next;else for(;c!==this.visibleLast;)a=c.entity,a._isDrawBounds&&a._isVisible&&
a.drawBounds(b),c=c.next;this.isNeedRender=!1},_drawScreen_WebGL:function(){var a=mighty.ctx;a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT);this.terrainCfg.visible&&this.drawInstanceGrid(a);for(var b=null,c=this.visibleFirst.next;c!==this.visibleLast;)b=c.entity,b._isVisible&&(b.draw(a),b.isNeedDraw=!1),c=c.next;this.isNeedRender=!1},drawInstanceGrid:null,_drawInstanceGrid_TopDown:function(a){for(var b=0,c=this.terrainMgr.cfg.tileWidth,d=this.terrainMgr.cfg.tileHeight,e=this.patchMgr.startGridX,f=
this.patchMgr.endGridX,g=this.patchMgr.endGridY,b=0,h=this.patchMgr.startGridY;h<g;h++)for(var i=e;i<f;i++)if(b=i+h*this.level.sizeX,b=this.instance[b])b.drawX=i*c,b.drawY=h*d,b.draw(a)},_drawInstanceGrid_Isometric:function(a){for(var b=0,c=Math.floor(this.terrainCfg.halfTileWidth),d=Math.floor(this.terrainCfg.halfTileHeight),e=this.patchMgr.startGridX,f=this.patchMgr.startGridY,g=this.patchMgr.endGridX,b=e+f*this.terrainCfg.numTilesX,h=this.patchMgr.endGridY;h>=f;h--)for(var i=e;i<g;i++)if(b=i+h*
this.terrainCfg.numTilesX,b=this.instance[b])b.drawX=this._offsetX+i*c+h*c,b.drawY=this._offsetY+i*d-h*d,b.draw(a)},renderFromVolume:function(a,b){var c=a.volume,d=c.minX,e=c.minY,f=c.maxX,c=c.maxY;d<b.minX&&(d=b.minX);e<b.minY&&(e=b.minY);f>b.maxX&&(f=b.maxX);c>b.maxY&&(c=b.maxY);a.drawRect(d,e,f,c)},forceRedraw:function(){this.isNeedRender=!0},handleRemove:function(){if(0!==this.numEntitiesToRemove){this.isNeedRender=!0;for(var a=null,b=0;b<this.numEntitiesToRemove;b++)a=this.entitiesToRemove[b],
a._removeSelf(),this.visibleEntities.remove(a.node),a.isAnimating&&this.animEntities.remove(a.animNode);this.numEntitiesToRemove=this.entitiesToRemove.length=0}},updateView:function(){this.camera.minSector.isChanged()||this.camera.maxSector.isChanged();this.isNeedRender=this.isForceRedraw=this.patchMgr.isNeedRender=!0},add:function(a){var b=this.entitiesMap[a.type];void 0===b&&(this.entitiesMap[a.type]=[],b=this.entitiesMap[a.type]);b.push(a);this.chn_Entity.signal(Entity.Event.ADDED,a);return a},
addEntity:function(a){return this.add(a)},addFromInfo:function(a){if(void 0===a)return null;if(void 0===a.template||null===a.template)return mighty.Error.warning("Entity.addFromInfo","No template specified."),null;var b=a.template.create(),b=this.add(b);b.forceMove(a.x,a.y);return b},remove:function(a){a.isNeedDraw=!1;a.isNeedRemove=!0;this.entitiesToRemove.push(a);this.numEntitiesToRemove++;this.isNeedRender=!0;this.chn_Entity.signal(Entity.Event.REMOVED,a)},removeFromMap:function(a){var b=this.entitiesMap[a.type];
if(void 0===b)mighty.Error.submit("Entity.Manager::removeFromMap","No such type found - "+mighty.Macro.GetStrEnum(GameObject,a.type));else for(var c,d=b.length,e=0;e<d;e++)if(c=b[e],c===a){b[e]=b[d-1];b.pop();break}},addAnimating:function(a){this.animEntities.push(a.animNode)},removeAnimating:function(a){this.animEntities.remove(a.animNode)},addUpdating:function(a){a.updateNodeID=this.numUpdateEntities;this.updateEntities.push(a);this.numUpdateEntities++},removeUpdating:function(a){var b=this.updateEntities[this.numUpdateEntities-
1];b.updateNodeID=a.updateNodeID;this.updateEntities[b.updateNodeID]=b;this.updateEntities.pop();this.numUpdateEntities--},addRedrawEntity:function(a){a.isNeedRedraw||(this.redrawEntities[this.numRedrawEntities++]=a,a.isNeedRedraw=!0)},createID:function(){return this.uniqueID++},loadGridBuffer:function(a){if(!a||!a.buffer)mighty.Error.submit("Entity::loadGridBuffer","Invalid grid buffer.");else{var b=new Terrain.Selector(a.gridX,a.gridY,a.gridX+a.sizeX,a.gridY+a.sizeY);if(b.numTiles!==a.buffer.length)mighty.Error.submit("Entity::loadGridBuffer",
"Invalid size of the buffer.");else{var c=new Entity.Info;b.reverse();var a=a.buffer,d=a.length-1;do{var e=a[d--];e&&-1!==e&&(c.template=this.palette.getByID(e),c.x=b.x,c.y=b.y,this.addFromInfo(c))}while(b.prev())}}},loadGridInstance:function(a){var b,c,d,e=new Entity.Info;e.x=0;e.y=0;var f=null,g=null;c=a.entityBuffer;d=c.length;for(b=0;b<d;b++)if((f=c[b])&&void 0===this.instanceEntities[f.id])f.node?g=f:(e.template=f,g=this.addFromInfo(e)),g.setVisible(!1),g.isSaved=!1,this.instanceEntities[f.id]=
g;c=a.buffer;d=c.length;for(b=0;b<d;b++)a=c[b],c[b]=0<a?this.instanceEntities[a]:null;this.instance=c},removeGridInstance:function(){this.isNeedRender=!0},setGridInstance:function(a,b){var c=this.instanceEntities[b.template.id];c||(c=new Entity.Info,c.template=b.template,c.x=0,c.y=0,c=this.addFromInfo(c),c.setVisible(!1),c.isSaved=!1,this.instanceEntities[b.template.id]=c);this.instance[a]=c;this.isNeedRender=!0},handleSignal_EntityInt:function(a,b){switch(a){case Entity.Event.ADD:return this.add(b);
case Entity.Event.ADD_FROM_INFO:return this.addFromInfo(b);case Entity.Event.REMOVE:return this.remove(b),!0;case Entity.Event.GET_BY_TYPE:return this.getByType(b);case Entity.Event.GET_BY_NAME:return this.getByName(b);case Entity.Event.LOAD_GRID_BUFFER:return this.loadGridBuffer(b),!0;case Entity.Event.LOAD_GRID_INSTANCE:return this.loadGridInstance(b),!0}return!1},handleSignal_Camera:function(a){switch(a){case Camera.Event.MOVED:this.isNeedRender=!0}},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.setCamera(b);
break;case Engine.Event.ZOOM:this.forceRedraw()}},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.handleInput_Moved(b);break;case Input.Event.INPUT_DOWN:this.handleInput_Pressed(b);break;case Input.Event.INPUT_UP:case Input.Event.CLICKED:case Input.Event.DB_CLICKED:this.handleInput_Clicked(b)}return!1},handleInput_Pressed:function(a){this._updateInputOver(a);null!==this.inputOverEntity&&(this.pressedEntity=this.inputOverEntity,this.clickSensiTreshhold=this.cfg.clickSensitivity,
this.inputOverEntity.onPress(a),this.chn_EntityInteract.signal(Entity.Event.PRESSED,this.inputOverEntity))},handleInput_Clicked:function(a){this.isEntityMoved&&!this.cfg.input.ignoreDrag?(this.pressedEntity.onDrag(a),this.chn_EntityInteract.signal(Entity.Event.DRAGGED,this.pressedEntity)):(this._updateInputOver(a),null!==this.inputOverEntity&&(this.inputOverEntity.onClick(a),this.chn_EntityInteract.signal(Entity.Event.CLICKED,this.inputOverEntity)));this.pressedEntity=null;this.isEntityMoved=!1},
handleInput_Moved:function(a){this._updateInputOver(a);this.pressedEntity&&(this.pressedEntity.onDragMove(a),this.isEntityMoved=!0)},_updateInputOver:function(){var a=this.cfg.input.picking,b=Cursor.plugin.screenX,c=Cursor.plugin.screenY,d=null;if(1===this.activeLayerID){for(var e=this.visibleLast.prev;e!==this.visibleFirst;e=e.prev)if(d=e.entity,!a.pickAbleFlag||d.isPickable)if(d._isVisible&&d.isInside(b,c)&&(!a.pixelPerfect||d.isInsidePerPx(b,c))){this.inputOverEntity&&d!==this.inputOverEntity&&
(d.isInputOver=!1,this.inputOverEntity.onOverExit(),this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity));d.onOver(b,c);this.inputOverEntity===d?(d.isInputOver=!0,this.chn_EntityInteract.signal(Entity.Event.OVER,d)):(this.inputOverEntity=d,this.chn_EntityInteract.signal(Entity.Event.OVER_ENTER,d));return}this.inputOverEntity&&(this.inputOverEntity.onOverExit(),this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity),this.inputOverEntity.isInputOver=!1,this.inputOverEntity=
null)}else if(a=Math.floor(b/this.terrainCfg.tileWidth),c=Math.floor(c/this.terrainCfg.tileHeight),b=a+c*this.terrainCfg.numTilesX,0>a||0>c||a>=this.terrainCfg.numTilesX||c>=this.terrainCfg.numTilesY)this.inputOverEntity.onOverExit(),this.chn_EntityInteract.signal(Entity.Event.OVER_EXIT,this.inputOverEntity),this.inputOverEntity=null,this.inputOverID=-1;else return d=this.instance[b],this.inputOverID===b?(d.isInputOver=!0,this.chn_EntityInteract.signal(Entity.Event.OVER,d)):(d.moveSilently(a*this.terrainCfg.tileWidth,
c*this.terrainCfg.tileHeight),this.inputOverEntity=d,this.inputOverID=b,this.chn_EntityInteract.signal(Entity.Event.OVER_ENTER,d)),d},setCamera:function(a){if(this.camera=a)this.isNeedRender=!0},getFromAABB:function(a){for(var b=null,c=[],d=this.visibleLast.prev;d!==this.visibleFirst;)b=d.entity,b.isLoaded&&b.collide(a,Entity.VolumeType.AABB)&&c.push(b),d=d.prev;return c},getFromPos:function(a,b){for(var c=null,d=this.visibleLast.prev;d!==this.visibleFirst;){c=d.entity;if(c._isVisible&&c.isLoaded&&
c.isInside(a,b))return c;d=d.prev}return null},getFromPosEx:function(a,b,c){for(var d=null,e=this.visibleLast.prev;e!==this.visibleFirst;){d=e.entity;if(d._isVisible&&d!==c&&d.isLoaded&&d.isInside(a,b))return d;e=e.prev}return null},getFromPosPx:function(a,b){for(var c=null,d=this.visibleLast.prev;d!==this.visibleFirst;){c=d.entity;if(c._isVisible&&c.isLoaded&&c.isInside(a,b)&&c.isInsidePerPx(a,b))return c;d=d.prev}return null},getByType:function(a){a=this.entitiesMap[a];return void 0===a?null:0<
a.length?a[0]:null},getByName:function(a){var b=null,c=0,d=null,e=null,f=0;for(b in this.entitiesMap){e=this.entitiesMap[b];f=e.length;for(c=0;c<f;c++)if(d=e[c],d.name===a)return d}return null},getEntityFromEntity:function(a){for(var b=null,c=this.visibleLast.prev;c!==this.visibleFirst;c=c.prev)if(b=c.entity,b!==a&&b.volume.vsAABB(a.volume))return b;return null},getEntityFromPoint:function(a,b){for(var c=null,d=this.visibleLast.prev;d!==this.visibleFirst;d=d.prev)if(c=d.entity,c.volume.vsPoint(a,
b))return c;return null},getData:function(a){return a?Entity.Loader.convertToBinary(this):Entity.Loader.convertToJSON(this)},loadLevel:function(a){return a?Entity.Loader.loadFromBinary(this):Entity.Loader.loadFromJSON(this)},getEntityFromMap:function(a,b){if(void 0===a)return mighty.Error.submit("Entity.Manager.GetEntity","Warning: Undefined type"),null;void 0===b&&(b=0);var c=this.entitiesMap[a];return void 0===c?(mighty.Error.submit("Entity.Manager.GetEntity","Warning: No entities found with type - GameObject."+
mighty.Macro.GetStrEnum(GameObject,a)+"("+a+")"),null):c.length<=b?(mighty.Error.submit("Entity.Manager.GetEntity","Warning: No such index in the map - "+b),null):c[b]},addDrawBounds:function(){this.isDrawBounds=!0;this.numDrawBounds++},removeDrawBounds:function(){this.numDrawBounds--;0>=this.numDrawBounds&&(this.isDrawBounds=!1)},updateGridPos:mighty.EmptyFunc,_updateGridPos_TopDown:function(a){a.prevGridX=a.gridX;a.prevGridY=a.gridY;a.gridX=Math.round(a.drawX/this.gridCfg.width);a.gridY=Math.round(a.drawY/
this.gridCfg.height);this.grid&&(a.gridX!==a.prevGridX||a.gridY!==a.prevGridY)&&this.grid.updateCell(a)},_updateGridPos_Isometric:function(a){a.prevGridX=a.gridX;a.prevGridY=a.gridY;var b=this.gridCfg.width,c=this.gridCfg.height;a.gridX=Math.round(a.y/c-a.x/b);a.gridY=Math.round(a.x/b+a.y/c);1<a.gridSizeX&&(a.gridX-=a.gridSizeX-1);this.grid&&a.useGrid&&(a.gridX!==a.prevGridX||a.gridY!==a.prevGridY)&&this.grid.updateCell(a)},switchActiveLayer:function(a){this.activeLayerID=a},editor:null,camera:null,
grid:null,patchMgr:null,terrainMgr:null,patchCfg:null,terrainCfg:null,gridCfg:null,level:null,isUpdateAnim:!0,isDrawAnim:!0,instance:null,instanceEntities:null,entitiesMap:null,entitiesToRemove:null,numEntitiesToRemove:-1,uniqueID:1,numDrawChanges:0,activeLayerID:1,visiblePatchs:null,updateEntities:null,redrawEntities:null,numUpdateEntities:0,numRedrawEntities:0,visibleEntities:null,visibleFirst:null,visibleLast:null,animEntities:null,animFirst:null,animLast:null,inputOverEntity:null,inputOverID:0,
pressedEntity:null,isEntityMoved:!1,prevInput_x:0,prevInput_y:0,clickSensiTreshhold:0,isForceRedraw:!1,isNeedRender:!1,isNeedUpdate:!1,isJustRendered:!1,isDrawBounds:!1,numDrawBounds:0,chn_Engine:null,chn_Entity:null,chn_EntityIn:null,chn_EntityInteract:null,_offsetX:0,_offsetY:0});Entity.Info=function(a,b,c){void 0===b&&(b=0);void 0===c&&(c=0);this.template=a;this.x=b;this.y=c};Entity.GridBuffer=function(a,b,c,d,e){this.buffer=a;this.gridX=b;this.gridY=c;this.sizeX=d;this.sizeY=e};
Entity.InstanceGridBuffer=function(a,b){this.entityBuffer=a;this.buffer=b};
Entity.Basic=Class.extend({init:mighty.EmptyFunc,load:mighty.EmptyFunc,unload:mighty.EmptyFunc,ready:mighty.EmptyFunc,_unload:function(){var a=null,b;for(b in this.component)a=this.component[b],a.unload&&a.unload(),a.isUnique&&(a.parent=null);this.component=null;this.chn_unique&&RemoveChannel(this.chn_unique)},update:mighty.EmptyFunc,updateComponents:mighty.EmptyFunc,_updateComponents:function(a){for(var b=0;b<this.numUpdateComponents;b++)this.componentsToUpdate[b].update(a);this.isNeedUpdate=!0},
_loadComponents:function(){var a=null,b;for(b in this.component)a=this.component[b],void 0!==a.load&&a.load();this.updateComponents=this._updateComponents},_createUniqueChannel:function(){return this.chn_unique=CreateChannel(this.name+"_"+this.id)},subscribe:function(a,b){this.chn_unique||this._createUniqueChannel();this.chn_unique.subscribe(a,b)},unsubscribe:function(a){this.chn_unique.unsubscribe(a)},addTimer:function(a,b,c){return this.parent.addTimer(a,b,c)},addComponent:function(a){var a=Palettes.Component.getByName(a),
b=Component.Obj[a.type],c;a.isUnique?(c=new Component[b](a),c.parent=this):(c=a,c.parent=null);IsObjectEmpty(this.component)&&(this.component={});this.component[b]=c;this.isLoaded&&void 0!==c.load&&c.load();a.innerUpdate&&c.update&&(0===this.numUpdateComponents&&(this.componentsToUpdate=[]),this.componentsToUpdate.push(c),this.numUpdateComponents++)},getComponent:function(a){var b=this.component[a];if(void 0===b)mighty.Error.submit("Entity::name - "+this.name,"There is no such component - "+a);else return b},
onSave:function(){return null},onLoad:function(){},is:function(a){return this instanceof a},print:function(a){console.log("[Entity",this.name+":"+this.id+"]",a)},parent:null,id:0,name:"unknown",type:0,template:null,component:{},componentsToUpdate:null,numUpdateComponents:0,chn_unique:null,isLoaded:!1,isLoading:!0,isTemplate:!1});Template.Manager=Plugin.extend({init:function(){this._super("Template")}});
Template.Entity=Class.extend({init:function(a,b,c){this.id=parseInt(a);this.name=b;this.type=parseInt(c);if(void 0===c)mighty.Error.submit("Template::Entity","Invalid type for - "+b);else if(a=Entity.Obj[c])if(this.obj=Entity[a]){var d=this;this.loaders={};this.register("component",function(a){d.loadComponents(a)});this.register("available",function(a){d.loadAvailables(a)});delete Entity.palette}else mighty.Error.submit("Template::Entity","There is no such entity object defined in the scope: ["+a+
"]");else mighty.Error.submit("Template::Entity","There is no such entity object name defined with type: ["+c+"]")},loadHead:function(a){this.brush=Palettes.Brush.getByID(a.brush)},loadBody:function(a){this.body=a?a:{};this.body.name=this.name;this.brush&&(this.body.brush=this.brush)},loadFooter:function(a){this.footer={};for(var b in a)this.loaders[b](a[b])},loadComponents:function(a){if(void 0!==a){var b={};this.footer.component=b;for(var c=a.length,d=Palettes.Component,e=0;e<c;e++){var f=d.getByID(a[e]);
f?(f.objType=Component.Obj[f.type],f.isUnique||(f.obj=new Component[f.objType](f)),b[f.objType]=f):mighty.Error.warning("Template.loadComponents","Could not find component with an ID - "+a[e])}}},loadAvailables:function(a){for(var b={},c=a.length,d=0;d<c;d++)b[a[d]]=1;this.footer.available=b},create:function(){var a=new this.obj(this.body,this.param);a.template=this;for(var b in this.footer)if("component"===b){var c=this.footer.component;a.component={};for(var d in c){var e=c[d];if(e.isUnique){var f=
Component[e.objType];void 0==f?console.error("unknown type:",e.objType):(f=new f(e),f.parent=a,a.component[e.objType]=f,e.innerUpdate&&f.update&&(0===a.numUpdateComponents&&(a.componentsToUpdate=[]),a.componentsToUpdate.push(f),a.numUpdateComponents++))}else a.component[e.objType]=e.obj,e.parent=null}}else a[b]=this.footer[b];a.isLoading=!1;a.handleLoaded();return a},register:function(a,b){this.loaders[a]=b},setBrush:function(a){this.brush=Palettes.Brush.getByID(a)},id:0,name:"",type:0,brush:null,
body:null,footer:null,obj:null,loaders:null,isTemplate:!0,param:{cancelLoading:!0}});Template.Element=function(a,b){this.key=a;this.value=b};
Resource.Manager=Plugin.extend({init:function(){this.path=Resource.Cfg.path+"/";gParams.branch&&(this.path=this.path+gParams.branch+"/");this.chn_resource=CreateChannel("Resource")},install:function(){this.scene.flags.add_Signal("Resource","Resource",Resource.Event.LOADED)},load:function(){this.isLoading=!0;for(var a=this.modules.length,b=0;b<a;b++)this.modules[b].load()},unload:function(){this.isLoaded=!1},updateLoading:function(){0<this.numModulesLoading||(this.isLoading=!1,this.isLoaded=!0,this.chn_resource.signal(Resource.Event.LOADED,
!0))},_loadModuleType:function(){this.moduleByType=[];var a=this.scope.ModuleType,b=this.scope.Type,c;for(c in a)this.moduleByType[b[c]]=this.module[a[c]]},loadPalette:function(){this._loadModuleType();for(var a,b=this.scope.palette,c=b.length,d=0;d<c;d++)a=b[d],void 0===a.type?mighty.Error.submit("Resource.Manager::loadPalette","Undefined resource type - "+a.name):this.moduleByType[a.type].addItem(a,!0);for(var e in this.moduleByType)this.moduleByType[e].setupLoader()},moduleByType:null,path:"",
chn_resource:null,numModulesLoading:0,isLoading:!1,isLoaded:!1});
Resource.Basic=Class.extend({_init:function(){this.cache={};this.date=Date.now()},load:function(){},loadAsCache:function(){},finishLoad:function(){this.isLoaded=!0;this.channel&&this.channel.signal(Resource.Event.LOADED,this)},createObj:function(){return new Resource[Resource.Obj[this.type]]},subscribe:function(a,b){this.channel||(this.channel=CreateChannel("resource_"+this.id));return this.channel.subscribe(a,b,Priority.MEDIUM)},unsubscribe:function(a,b){this.channel&&(this.channel.unsubscribe(b),
0>=this.channel.numSubscribers&&RemoveChannel(this.channel))},signal:function(a,b){this.channel&&this.channel.signal(a,b)},addCacheSetup:function(a){null===this.cacheSetup&&(this.cacheSetup=[]);this.cacheSetup.push(a)},doCacheSetup:function(){if(null!==this.cacheSetup){for(var a=this.cacheSetup.length,b=0;b<a;b++)this.cacheSetup[b]._loadAsCache();this.cacheSetup=null}},parent:null,module:null,id:0,name:"Unknown",path:"",type:0,data:null,cache:null,cacheSetup:null,channel:null,isLoaded:!0});
Resource.ResourceModule=mighty.Module.extend({init:function(){this.resources=[]},setup:function(){this.loader=mighty.Loader;this.loaderElement=new mighty.Loader.Element(this.name,0,100)},setupLoader:function(){this.isLoaderAdded||(this.loader.addElement(this.loaderElement),this.isLoaderAdded=!0)},load:function(){this.isLoading=!0;this.isPreLoaded&&this.mgr.numModulesLoading++;this._updateLoading()},_updateLoading:function(){this.isLoading&&this.loaderElement.numItemsLoaded>=this.loaderElement.numItems&&
(this.isLoading=!1,this.isPreLoaded&&(this.mgr.numModulesLoading--,this.mgr.updateLoading()))},addItem:function(a,b){this.isEmptyItem||this.addEmptyItem(a);var c=this.mgr.scope,c=new c[c.Obj[a.type]](null);c.module=this;for(var d in a)c[d]=a[d];void 0===a.preload||a.preload?b?c.load(this.mgr.path+this.path,!0):c.load("",!0):c.path=this.mgr.path+this.path+c.id+"."+c.ext;this.resources.push(c);this.loaderElement.numItems++},addEmptyItem:function(a){var b=this.mgr.scope,b=new b[b.Obj[a.type]](null);
b.name="_error";b.id=a.id;b.ext=a.ext;b.type=a.type;b.module=this;a.type!==Resource.Type.SOUND&&b.load(this.mgr.path+this.path,!0);this.resources.push(b);this.isEmptyItem=!0;this.loaderElement.numItems++;this.loaderElement.numItemsLoaded++},loadSuccess:function(){this.loaderElement.numItemsLoaded++;this._updateLoading();this.loader.updateElement(this.loaderElement)},loadFailed:function(){this.loaderElement.numItemsLoaded++;this.loader.updateElement(this.loaderElement)},getByID:function(a){if(!a)return null;
for(var b,c=this.resources.length,d=0;d<c;d++)if(b=this.resources[d],b.id===a)return b;return null},getByName:function(a){for(var b=null,c=this.resources.length,d=0;d<c;d++)if(b=this.resources[d],b.name===a)return b;b="Texture"===this.name?this.getByName("error")||this.getByName("_error"):null;mighty.Error.warning("Resource.Module","Could not found Resource.Type."+this.name+" with a name - '"+a+"'.");return b},name:"",path:"",resources:null,resourcesToLoad:0,loader:null,loaderElement:null,isLoaderAdded:!1,
isEmptyItem:!1,isLoading:!0,isPreLoaded:!0});mighty._LoadCustomResource_ID=0;mighty.LoadCustomResource=function(a,b,c){var d=Scene.plugin.currScene,e=new Resource.Basic;e.id=mighty._LoadCustomResource_ID;e.name="CustomResource";d&&!d.isLoaded&&d.flags.add(e.name+"_"+e.id);mighty.Ajax({type:"POST",url:a,success:function(a){e.data=a;b&&b(a,e);d&&!d.isLoaded&&d.flags.activate(e.name+"_"+e.id)},error:function(){c&&c()}});mighty._LoadCustomResource_ID++;return e};
mighty.LoadTexture=function(a){if(a)if(Scene.plugin&&Scene.plugin.currScene&&Scene.plugin.currScene.isLoaded)mighty.Error.error("mighty.AddTexture","");else{a.length||(a=[a]);for(var b,c,d=a.length,e=0;e<d;e++)if(b=a[e],b.path){c=b.path.indexOf(".");-1!==c?(b.id=b.path.slice(0,c),b.ext||(b.ext=b.path.slice(c+1))):(b.ext||(b.ext="png"),b.id=b.path,b.path+="."+b.ext);if(!b.name||!b.name.length)c=b.id.split("/"),b.name=c[c.length-1];b.width||(b.width=0);b.height||(b.height=0);b.date||(b.date=Date.now());
!b.numFrames||!b.numRows?b.type=Resource.Type.TEXTURE:(b.type=Resource.Type.ANIM_TEXTURE,b.fps||(b.fps=9),b.numFrames||(b.numFrames=1),b.numRows||(b.numRows=1));Resource.plugin.module.Texture.addItem(b,!1)}else mighty.Error.warning("mighty.AddTexture","Not defined path for an object. Could not add as texture.",b)}};
mighty.CreateModuleEx("Resource","Texture","ResourceModule",{init:function(){this.name="Texture";this.path="default/img/";if(mighty.engine.isWebGL){Resource.Texture.prototype.setCanvas=Resource.Texture.prototype.setCanvas_WebGL;Resource.Texture.prototype.setWidth=Resource.Texture.prototype.drawOver_WebGL;Resource.Texture.prototype.setWidth=Resource.Texture.prototype.setWidth_WebGL;Resource.Texture.prototype.setHeight=Resource.Texture.prototype.setHeight_WebGL;Resource.Texture.prototype.draw=Resource.Texture.prototype._draw_WebGL;
var a=mighty.ctx,b=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,b);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),a.STATIC_DRAW);Resource.Texture.prototype._texVBO=b;a.bindBuffer(a.ARRAY_BUFFER,b);a.vertexAttribPointer(a.loc.texCoord,2,a.FLOAT,!1,0,0)}else Resource.Texture.prototype.setCanvas=Resource.Texture.prototype.setCanvas_Canvas,Resource.Texture.prototype.setWidth=Resource.Texture.prototype.drawOver_Canvas,Resource.Texture.prototype.setWidth=Resource.Texture.prototype.setWidth_Canvas,
Resource.Texture.prototype.setHeight=Resource.Texture.prototype.setHeight_Canvas,Resource.Texture.prototype.draw=Resource.Texture.prototype._draw;this._super()},texturesToCombine:0});
Resource.Texture=Resource.Basic.extend({init:function(a,b){a||(mighty.engine.isWebGL?this.generate(Resource.TextureType.WEBGL):this.generate(Resource.TextureType.CANVAS));if("number"===typeof a)this.generate(a);else if("string"===typeof a){if(b)for(var c in b)this[c]=b[c];mighty.engine.isWebGL?this.generate(Resource.TextureType.WEBGL):this.generate(Resource.TextureType.CANVAS);this.load(a)}else a instanceof HTMLCanvasElement&&this.setCanvas(a)},load:function(a,b){this.isLoaded=!1;var c=new Image,
d=this;c.onload=function(){d.createFromImg(c);d.finishLoad();d.module&&d.module.loadSuccess(d);c.onload=null};c.onerror=function(){d.module&&d.module.loadFailed(d)};c.onabort=c.onerror;this._calcResolution();a&&a.length?mighty.IsUrl(a)?(this.path=a,this.getDataAt=function(){return[255,255,255,255]}):(c.crossOrigin="anonymous",b?a&&(this.path=a+this.id+"."+this.ext):this.path=a):this.path&&this.path.length&&!mighty.IsUrl(this.path)&&(c.crossOrigin="anonymous");c.src=Resource.Cfg.useTimestamp?this.path+
"?"+this.date:this.path},loadAsCache:function(){this.parent&&(this.create(),this.isLoaded=!0)},createFromImg:function(a){if(a instanceof HTMLImageElement)if(this.setWidth(a.width),this.setHeight(a.height),this._calcResolution(),mighty.engine.isWebGL){var b=mighty.context,c=new Float32Array([0,0,a.width,0,0,a.height,a.width,a.height]);this.vbo=b.createBuffer();b.bindBuffer(b.ARRAY_BUFFER,this.vbo);b.bufferData(b.ARRAY_BUFFER,c,b.STATIC_DRAW);b.bindTexture(b.TEXTURE_2D,this.image);b.texImage2D(b.TEXTURE_2D,
0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,a);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MIN_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_MAG_FILTER,b.LINEAR);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_S,b.CLAMP_TO_EDGE);b.texParameteri(b.TEXTURE_2D,b.TEXTURE_WRAP_T,b.CLAMP_TO_EDGE);b.bindTexture(b.TEXTURE_2D,null)}else this.flipType!==Resource.Flip.NONE?(this._calcResolution(),this.generateFlip()):this.ctx.drawImage(a,0,0),this.doCacheSetup();else mighty.Error.warning("Resource.Texture.createFromImg",
"Supplied 'img' argument is not an Image object.")},generate:function(a,b,c){a||(a=mighty.engine.isWebGL?Resource.TextureType.WEBGL:Resource.TextureType.CANVAS);this._width=b|1;this._height=c|1;a===Resource.TextureType.CANVAS?(this.image=document.createElement("canvas"),this.image.width=this.width,this.image.height=this.height,this.ctx=this.image.getContext("2d")):a===Resource.TextureType.WEBGL&&(this.image=mighty.context.createTexture());this.texType=a},resize:function(a,b){this._width=a;this._height=
b;mighty.engine.isWebGL||(this.image.width=a,this.image.height=b)},_calcResolution:function(){this.parent&&(this._width=this.parent._width,this._height=this.parent._height)},copy:function(a){this.id=a.id;this.name=a.name;this.width=a.width;this.height=a.height;this.offsetX=a.offsetX;this.offsetY=a.offsetY;this.cbFuncs=a.cbFuncs},clone:function(a){var b=new Resource.Texture(this.te);b.generate(this._width,this._height);b.copy(this);b.name=a;b.ctx.drawImage(this.canvas,0,0);return b},draw:mighty.EmptyFunc,
_draw:function(a,b,c){this.isLoaded&&a.drawImage(this.image,b,c)},_draw_WebGL:function(a,b,c){this.isLoaded&&(a.bindVBO!==this.vbo&&(a.bindBuffer(a.ARRAY_BUFFER,this.vbo),a.vertexAttribPointer(a.loc.vertice,2,a.FLOAT,!1,0,0),a.bindVBO=this.vbo),a.bindTex!==this.image&&(a.bindTexture(a.TEXTURE_2D,this.image),a.uniform1i(a.loc.texture,0),a.bindTex=this.image),a.uniform2f(a.loc.pos,b,c),a.drawArrays(a.TRIANGLE_STRIP,0,4))},drawRect:function(a,b,c,d,e,f,g){!1!==this.isLoaded&&a.drawImage(this.image,d,
e,f,g,b,c,f,g)},drawFilter:function(a,b,c,d){!1!==this.isLoaded&&(d.process(this),a.drawImage(d.img,Math.floor(b),Math.floor(c)))},drawFilterRect:function(a,b,c,d,e,f,g,h){!1!==this.isLoaded&&(h.process(this),a.drawImage(h.img,d,e,f,g,b,c,f,g))},drawScaled:function(a,b,c,d,e){!1!==this.isLoaded&&a.drawImage(this.image,0,0,this._width,this._height,b,c,d,e)},drawBufferScaled:function(a,b,c,d,e,f){!1!==this.isLoaded&&a.drawImage(b,0,0,this._width,this._height,c,d,e,f)},generateAlphaMask:function(){for(var a=
this.ctx.getImageData(0,0,this._width,this._height).data,b=a.length,c=0;c<b;c+=4)50<a[c+3]?(a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255):(a[c]=0,a[c+1]=0,a[c+2]=0,a[c+3]=0);this.ctx.putImageData(a,0,0);return this.image},generateRGBAFromAlpha:function(a,b,c,d,e){var f=document.createElement("canvas");f.width=d;f.height=e;var g=f.getContext("2d");g.drawImage(this.image,b,c,d,e,0,0,d,e);b=g.getImageData(0,0,d,e);a=a.getContext("2d").getImageData(0,0,d,e);d=b.data.length;e=3;for(c=0;c<d;c+=4){var h=a.data[e];
h<b.data[e]&&(b.data[e]=h);e+=4}g.putImageData(b,0,0);return f},flip:function(a){if(!a||a===Resource.Flip.NONE)return this.parent;var b=null;this.cache.flip||(this.cache.flip={});void 0===this.cache.flip[a]?(b=this.createObj(),b.copy(this),b.parent=this,b.flipType=a,this.isLoaded?b.generateFlip():this.addCacheSetup(b),this.cache.flip[a]=b):b=this.cache.flip[a];return b},generateFlip:function(){switch(this.flipType){case Resource.Flip.HORIZONTAL:this.ctx.translate(this.image.width,0);this.ctx.scale(-1,
1);this.ctx.drawImage(this.parent.image,0,0);break;case Resource.Flip.VERTICAL:this.ctx.translate(0,this.image.height);this.ctx.scale(1,-1);this.ctx.drawImage(this.parent.image,0,0);break;case Resource.Flip.HORIZONTAL_VERTICAL:this.ctx.translate(this.image.width,this.image.height),this.ctx.scale(-1,-1),this.ctx.drawImage(this.parent.image,0,0)}},createFlip_WebGL:function(){switch(this.flipType){case Resource.Flip.HORIZONTAL:this.flipY=this.flipX=0;break;case Resource.Flip.VERTICAL:this.flipY=this.flipX=
1;break;case Resource.Flip.HORIZONTAL_VERTICAL:this.flipX=0,this.flipY=1}},setCanvas:mighty.EmptyFunc,drawOver:mighty.EmptyFunc,setCanvas_Canvas:function(a){var b=!1;this.image&&(b=!0);this.image=a;this.ctx=a.getContext("2d");this._width=this.image.width;this._height=this.image.height;b&&this.signal(Resource.Event.REPLACE,this)},drawOver_Canvas:function(a){this.ctx.drawImage(a,0,0)},setCanvas_WebGL:function(){},drawOver_WebGL:function(){},_loadAsCache:function(){this._calcResolution();this.flipType&&
(this.image.width=this.parent.image.width,this.image.height=this.parent.image.height,this.generateFlip())},getFrameImg:function(a,b){var c=document.createElement("canvas");c.width=this._width;c.height=this._height;var d=c.getContext("2d");void 0===b?d.putImageData(this.getImgData(),0,0):(b.process(this),d.putImageData(b.getImgData(),0,0));d=new Image;d.name=this.name;d.src=c.toDataURL();return d},getInfo:function(){return this.ctx.getImageData(0,0,this._width,this._height)},getData:function(){return this.ctx.getImageData(0,
0,this._width,this._height).data},getDataAt:function(a,b){return this.ctx.getImageData(a,b,1,1).data},getImgData:function(){return this.ctx.getImageData(0,0,this._width,this._height)},setWidth:mighty.EmptyFunc,setHeight:mighty.EmptyFunc,setWidth_Canvas:function(a){this._width=a;this.image.width=a},setHeight_Canvas:function(a){this._height=a;this.image.height=a},setWidth_WebGL:function(a){this._width=a},setHeight_WebGL:function(a){this._height=a},set width(a){this.setWidth(a)},get width(){return this._width},
set height(a){this.setHeight(a)},get height(){return this._height},image:null,ctx:null,vbo:null,_texVBO:null,_width:0,_height:0,bufferImg:null,bufferCtx:null,texType:0,combine:null,mask:null,maskType:MaskType.DEFAULT,offsetX:0,offsetY:0,numFrames:1,numRows:1,totalFrames:1,fps:9,isAnimated:!1,flipType:0,flipX:1,flipY:0});window.document&&"file:"===window.location.protocol&&(Resource.Texture.prototype.getDataAt=function(){return[255,255,255,255]});
Resource.AnimTexture=Resource.Texture.extend({_calcResolution:function(){this.isAnimated=!0;this.parent?(this.fullWidth=this.parent.fullWidth,this.fullHeight=this.parent.fullHeight):(this.fullWidth=this._width,this.fullHeight=this._height);this._width=this.fullWidth/this.numFrames;this._height=this.fullHeight/this.numRows;this.totalFrames=this.numFrames*this.numRows;this.tAnimUpdate=Math.round(1E3/this.fps)},generateFlip:function(){switch(this.flipType){case Resource.Flip.HORIZONTAL:this.ctx.translate(this.fullWidth,
0);this.ctx.scale(-1,1);this.ctx.drawImage(this.parent.image,0,0);break;case Resource.Flip.VERTICAL:this.ctx.translate(0,this.fullHeight);this.ctx.scale(1,-1);this.ctx.drawImage(this.parent.image,0,0);break;case Resource.Flip.HORIZONTAL_VERTICAL:this.ctx.translate(this.fullWidth,this.fullHeight),this.ctx.scale(-1,-1),this.ctx.drawImage(this.parent.image,0,0)}},copy:function(a){this._super(a);this.numFrames=a.numFrames;this.numRows=a.numRows;this.totalFrames=a.totalFrames;this.fps=a.fps},draw:function(a,
b,c,d){!1!==this.isLoaded&&(b=Math.floor(b),c=Math.floor(c),a.drawImage(this.image,this._width*(d%this.numFrames),this._height*Math.floor(d/this.numFrames),this._width,this._height,b,c,this._width,this._height))},drawRect:function(a,b,c,d,e,f,g,h){!1!==this.isLoaded&&(b=Math.floor(b),c=Math.floor(c),a.drawImage(this.image,this._width*(h%this.numFrames)+d,this._height*Math.floor(h/this.numFrames)+e,f,g,b,c,f,g))},drawFilter:function(a,b,c,d,e){!1!==this.isLoaded&&(e.process(this),b=Math.floor(b),c=
Math.floor(c),a.drawImage(e.img,this._width*(d%this.numFrames),this._height*Math.floor(d/this.numFrames),this._width,this._height,b,c,this._width,this._height))},getDataAt:function(a,b,c){return this.ctx.getImageData(a+c*this._width,b,1,1).data},getImgData:function(a){return this.ctx.getImageData(this._width*(a%this.numFrames),this._height*Math.floor(a/this.numFrames),this._width,this._height)},getFrameImg:function(a,b){var c=document.createElement("canvas");c.width=this._width;c.height=this._height;
var d=c.getContext("2d");void 0===b?d.putImageData(this.getImgData(a),0,0):(b.process(this),d.putImageData(b.getImgData(),0,0));d=new Image;d.name=this.name;d.src=c.toDataURL();return d},getRandFrame:function(){return mighty.Random.getNumber(0,this.numFrames-1)},setFPS:function(a){this.fps=a;this.tAnimUpdate=Math.round(1E3/this.fps)},fullWidth:1,fullHeight:1,tAnimUpdate:0,tPause:5});
window.document&&"file:"===window.document.location.protocol&&(Resource.AnimTexture.prototype.getDataAt=function(){return[255,255,255,255]});
mighty.CreateModuleEx("Resource","Sound","ResourceModule",{init:function(){this.name="Sound";this.path="default/snd/";this.isPreLoaded=!1;this.setupLoader=mighty.EmptyFunc;this._super();var a=this;SubscribeChannel(this,"Sound",function(b,c){a.handleSignal_Sound(b,c)});this.checkCapabilities()},setup:function(){this.volume=this.mgr.cfg.sound.volume;this._super()},stopAll:function(){for(var a=this.resources.length,b=0;b<a;b++)this.resources[b].stop()},disable:function(){this.isDisabled=!0;this.stopAll()},
enable:function(){this.isDisabled=!1},checkCapabilities:function(){this.audio=document.createElement("audio");void 0===this.audio.canPlayType&&(this.isAudioSupported=!1);this._getContext();this._checkFormats();this.audio=null},_getContext:function(){if(void 0!==window.AudioContext)this.context=new window.AudioContext;else for(var a=mighty.engine.extensions.length,b=0;b<a;b++){var c=window[mighty.engine.extensions[b]+"AudioContext"];if(void 0!==c){this.context=new c;return}}this.context||(this.isAudioSupported=
!1)},_checkFormats:function(){this.formats=[];var a=document.createElement("audio");mighty.Device.isCocoonJS?this.formats.push("ogg"):(""!=a.canPlayType('audio/mp4; codecs="mp4a.40.2"').replace(/no/i,"")&&this.formats.push("m4a"),a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&this.formats.push("ogg"),a.canPlayType("audio/mpeg;").replace(/no/,"")&&this.formats.push("mp3"),a.canPlayType('audio/wav; codecs="1"').replace(/no/,"")&&this.formats.push("wav"));0===this.formats.length&&(this.isAudioSupported=
!1)},setVolume:function(a){if(!isNaN(a)){this.volume=a;for(var a=null,b=this.resources.length,c=0;c<b;c++)a=this.resources[c],a.setVolume(a.volume)}},handleSignal_Sound:function(a,b){switch(a){case Sound.Event.PLAY:var c=this.getByName(b);return!c?(mighty.Error.submit("Sound.Event.PLAY","Could not find audio file with name - "+b),this.getByName("_error")):c;case Sound.Event.DISABLE:return this.disable(),!0;case Sound.Event.ENABLE:return this.enable(),!0;case Sound.Event.STOP_ALL:return this.stopAll(),
!0;case Sound.Event.SET_VOLUME:this.setVolume(b)}return!1},audio:null,context:null,formats:null,isAudioSupported:!0,isDisabled:!1,volume:1});
Resource.Sound=Resource.Basic.extend({load:function(a){this.sounds=[];this.path=a+this.path+this.id+".";this.play=this._play;this.stop=this._stop;this.pause=this._pause;this.setVolume=this._setVolume;a&&this._loadNextExtension()},_loadNextExtension:function(){this.currExtIndex++;if(this.currExtIndex>this.module.formats.length-1)this.module.loadFailed();else{var a=this;this.sound||(this.sound=this._getAudioInstance(),this.sound.audio.addEventListener("error",function(){a._loadNextExtension()}));var b=
this.path+this.module.formats[this.currExtIndex];Resource.Cfg.useTimestamp&&(b+="?"+this.date);this.sound.audio.src=b;this.sound.audio.load()}},_loadNextExtension_audioAPI:function(){this.currExtIndex++;if(this.currExtIndex>this.module.formats.length-1)this.module.loadFailed();else{var a=this,b=this.path+this.module.formats[this.currExtIndex];Resource.Cfg.useTimestamp&&(b+="?"+this.date);var c=new XMLHttpRequest;c.open("GET",b,!0);c.responseType="arraybuffer";c.onload=function(){404===c.status?a._loadNextExtension_audioAPI():
(a.module.context.decodeAudioData(c.response,function(b){a.buffer=b;a.module.loadSuccess()},function(){a._loadNextExtension_audioAPI()}),a.path+=a.module.formats[a.currExtIndex],a.isLoaded=!0)};c.send()}},play:null,stop:null,pause:null,setVolume:null,_play:function(a){if(!this.module.isDisabled){if(void 0===a){if(a=this._getAudioInstance(),!a.canPlay||!a.metaLoaded){a.isNeedPlay=!0;return}}else a.isNeedPlay=!1;a.isPlaying=!0;this.numPlaying++;this.isPlaying=!0;a.audio.currentTime!==this.startTime&&
(a.audio.currentTime=this.startTime);a.audio.load();a.audio.play();a.audio.volume=this.module.volume*this.volume;var b=this,c=function(){a.audio.removeEventListener("ended",c,!1);a.isPlaying=!1;b.numPlaying--;b.isLoop&&!b.module.isDisabled?b.play():0===b.numPlaying&&(b.isPlaying=!1)};a.audio.addEventListener("ended",c,!1);return a}},_playAudioAPI:function(){if(!this.module.isDisabled&&this.module.isAudioSupported){var a=this.module.context.createBufferSource();a.buffer=this.buffer;a.connect(this.module.context.destination);
void 0!==a.start?a.start(0):a.noteOn(0)}},_stop:function(){if(this.isPlaying){for(var a,b=this.sounds.length,c=0;c<b;c++)a=this.sounds[c],a.isPlaying&&(a.audio.pause(),a.isPlaying=!1,a.isNeedPlay=!1);this.numPlaying=0;this.isPlaying=!1}},_stopAudioAPI:function(){},_pause:function(){if(!this.module.isDisabled){for(var a,b=this.sounds.length,c=0;c<b;c++)a=this.sounds[c],a.isPlaying&&a.audio.play();this.isPaused=!this.isPaused}},_setVolume:function(a){0>a?a=0:1<a&&(a=1);this.volume=a;var b,c,d=this.sounds.length;
for(c=0;c<d;c++)b=this.sounds[c],b.isPlaying&&(b.audio.volume=this.module.volume*a)},_getAudioInstance:function(){for(var a,b=this.sounds.length,c=0;c<b;c++)if(a=this.sounds[c],!a.isPlaying&&!a.isNeedPlay)return a;a=new Resource.AudioInstance;var d=this;a.audio.addEventListener("canplaythrough",function(){d.isLoaded||(d.isLoaded=!0,d.module.loadSuccess(this));a.canPlay=!0;d.sound?!a.isPlaying&&(a.isNeedPlay&&a.metaLoaded)&&d.play(a):(d.module.loadSuccess(this),d.path+=d.module.formats[d.currExtIndex],
d.isLoaded=!0)},!1);mighty.Device.support.onloadedmetadata?a.audio.addEventListener("loadedmetadata",function(){!d.isLoaded&&a.canPlay&&(d.isLoaded=!0,d.module.loadSuccess(this));a.metaLoaded=!0;d.sound&&(!a.isPlaying&&a.isNeedPlay&&a.canPlay)&&d.play(a)},!1):a.metaLoaded=!0;this.sounds.push(a);this.sound&&(a.audio.src=this.sound.audio.src,a.audio.load());return a},sound:null,sounds:null,numPlaying:0,isPlaying:!1,isPaused:!1,buffer:null,source:null,volume:1,currExtIndex:-1,startTime:0,isAutoPlay:!1,
isLoop:!1});Resource.AudioInstance=function(){this.metaLoaded=this.canPlay=this.isNeedPlay=this.isPlaying=!1;this.timeout=null;this.audio=new window.Audio;this.audio.preload="auto"};Material.Manager=Plugin.extend({});
Material.Basic=Class.extend({init:function(a){this.name=a;this.img=document.createElement("canvas");this.ctx=this.img.getContext("2d")},clone:function(a){this.info=a.getInfo();this.data=this.info.data;this.length=this.data.length;this.width=a.width;this.height=a.height;this.img.width=this.width;this.img.height=this.height},create:function(){this.ctx.putImageData(this.info,0,0)},process:mighty.EmptyFunc,getInfo:function(){return this.ctx.getImageData(0,0,this.width,this.height)},getData:function(){return this.ctx.getImageData(0,
0,this.width,this.height).data},name:"",img:null,ctx:null,width:0,height:0,info:null,data:null,length:0});
Material.Color=Material.Basic.extend({process:function(a){this.clone(a);for(a=0;a<this.length;a+=4)this.data[a]=this.mulColor(this.data[a],this.r),this.data[a+1]=this.mulColor(this.data[a+1],this.g),this.data[a+2]=this.mulColor(this.data[a+2],this.b),this.data[a+3]=this.mulColor(this.data[a+3],this.a);this.create()},mulColor:function(a,b){return Math.ceil(255*a/255*(b/255))},setRGB:function(a,b,c){this.r=a;this.g=b;this.b=c;this.a=255},setRGBA:function(a,b,c,d){this.r=a;this.g=b;this.b=c;this.a=d},
r:255,g:255,b:255,a:255});Material.Grayscale=Material.Basic.extend({process:function(a){this.clone(a);for(a=0;a<this.length;a+=4){var b=this.getLuminance(this.data[a],this.data[a+1],this.data[a+2],this.data[a+3]);this.data[a]=b;this.data[a+1]=b;this.data[a+2]=b}this.create()},getLuminance:function(a,b,c){return Math.ceil(0.3*a+0.59*b+0.11*c)},power:1});
Input.Manager=Plugin.extend({init:function(){this.engine=mighty.engine;this.numFingers=10;this.chn_input=CreateChannel("Input");var a=this;SubscribeChannel(this,"Input.IN",function(b,c){return a.handleSignal_Input(b,c)});SubscribeChannel(this,"Scene.OUT",function(b,c){return a.handleSignal_Scene(b,c)});this.cachedEvent=new Input.EventInfo(null,-1,-1,-1);this.keys=Array(256);this.isPressed=Array(3);this.loadIgnoreKeys()},install:function(){void 0!==gParams.editor&&(this.cfg.stickyKeys=!1)},uninstall:function(){Input._macroBuffer=
[]},unload:function(){this.releaseListeners()},load:function(){this.addListeners();var a=0;for(this.touches=Array(this.numFingers);a<this.numFingers;++a)this.touches[a]=new Input.TouchItem(a);this.numLinks=this.numFingers;2===this.numLinks?this.numLinks=1:1===this.numLinks&&(this.numLinks=0);this.numLinks&&(this.links=Array(this.numLinks));for(a=0;a<this.numLinks;++a)this.links[a]=new Input.TouchLink(a)},reset:function(){this.cachedEvent=new Input.EventInfo(null,-1,-1,-1);this.keys=Array(256);this.isPressed=
Array(3);this.numActiveLinks=this.numActiveTouches=0},addListeners:function(){var a=this;this._onMouseMove=function(b){a.handleMouseMove(b)};this._onMouseDown=function(b){a.handleMouseDown(b)};this._onMouseUp=function(b){a.handleMouseUp(b)};this._onTouchStart=function(b){a.handleTouchStart(b)};this._onTouchEnd=function(b){a.handleTouchEnd(b)};this._onTouchMove=function(b){a.handleTouchMove(b)};this._onTouchCancel=function(b){a.handleTouchCancel(b)};window.addEventListener("mousemove",this._onMouseMove);
window.addEventListener("mousedown",this._onMouseDown);window.addEventListener("mouseup",this._onMouseUp);window.addEventListener("touchstart",this._onTouchStart);window.addEventListener("touchend",this._onTouchEnd);window.addEventListener("touchmove",this._onTouchMove);window.addEventListener("touchcancel",this._onTouchCancel);mighty.Device.support.onkeydown&&(this._onKeyDown=function(b){a.handleKeyDown(b);window.top&&a.iFrameKeys[b.keyCode]&&b.preventDefault();void 0!==a.cmdKeys[b.keyCode]&&a.numCmdKeys++;
void 0===a.ignoreKeys[b.keyCode]&&0>=a.numCmdKeys&&Input.Cfg.preventDefault&&b.preventDefault()},window.addEventListener("keydown",this._onKeyDown));mighty.Device.support.onkeyup&&(this._onKeyUp=function(b){a.handleKeyUp(b);window.top&&a.iFrameKeys[b.keyCode]&&b.preventDefault();void 0!==a.cmdKeys[b.keyCode]&&this.numCmdKeys--;void 0===a.ignoreKeys[b.keyCode]&&0>=a.numCmdKeys&&Input.Cfg.preventDefault&&b.preventDefault()},window.addEventListener("keyup",this._onKeyUp))},releaseListeners:function(){window.removeEventListener("mousemove",
this._onMouseMove);window.removeEventListener("mousedown",this._onMouseDown);window.removeEventListener("mouseup",this._onMouseUp);window.removeEventListener("touchstart",this._onTouchStart);window.removeEventListener("touchend",this._onTouchEnd);window.removeEventListener("touchmove",this._onTouchMove);window.removeEventListener("touchcancel",this._onTouchCancel);mighty.Device.support.onkeydown&&window.removeEventListener("keydown",this._onKeyDown);mighty.Device.support.onkeyup&&window.removeEventListener("keyup",
this._onKeyUp)},handleMouseDown:function(a){if(!this.engine.blockInput){this.isPressed[a.button]=!0;var b=(a.pageX-this.engine.offsetLeft)*mighty.scale,c=(a.pageY-this.engine.offsetTop)*mighty.scale;this.cachedEvent.set(a,a.button,b,c);this.chn_input.signalBreakable(Input.Event.INPUT_DOWN,this.cachedEvent);this.prevX=b;this.prevY=c}},handleMouseUp:function(a){if(!this.engine.blockInput){var b=(a.pageX-this.engine.offsetLeft)*mighty.scale,c=(a.pageY-this.engine.offsetTop)*mighty.scale;this.isPressed[a.button]=
!1;this.cachedEvent.set(a,a.button,b,c);0===a.button?(this.isDrag?this.chn_input.signal(Input.Event.INPUT_UP,this.cachedEvent):this.chn_input.signal(Input.Event.CLICKED,this.cachedEvent),this.isDrag=!1):this.chn_input.signalBreakable(Input.Event.INPUT_UP,this.cachedEvent);this.prevX=b;this.prevY=c}},handleMouseMove:function(a){if(!this.engine.blockInput){!0===this.isPressed[0]&&(this.isDrag=!0);var b=(a.pageX-this.engine.offsetLeft)*mighty.scale,c=(a.pageY-this.engine.offsetTop)*mighty.scale;this.cachedEvent.set(a,
-1,b,c,this.prevX,this.prevY);this.chn_input.signal(Input.Event.MOVED,this.cachedEvent);this.prevX=b;this.prevY=c}},handleTouchStart:function(a){if(!this.engine.blockInput&&(a.preventDefault(),this.numActiveTouches!==this.numFingers))for(var b=a.changedTouches,c=b.length,d=0,e=0,f=0;f<c;f++){var e=b[f],d=e.identifier,g=this.getFreeTouch();g.uid=d;this.numActiveTouches++;d=(e.pageX-this.engine.offsetLeft)*mighty.scale;e=(e.pageY-this.engine.offsetTop)*mighty.scale;this.firstTouch?this.isTouchPressed=
!1:(this.cachedEvent.set(a,Input.Key.BUTTON_LEFT,d,e),this.chn_input.signal(Input.Event.INPUT_DOWN,this.cachedEvent),this.firstTouch=g,this.isTouchPressed=!0)}},handleTouchEnd:function(a){if(!this.engine.blockInput){a.preventDefault();for(var b=a.changedTouches,c=b.length,d=0,e=0,f=0;f<c;f++){var e=b[f],g=this.getTouchByUid(b[f].identifier);null!==g&&(g.uid=-1,this.numActiveTouches--,d=(e.pageX-this.engine.offsetLeft)*mighty.scale,e=(e.pageY-this.engine.offsetTop)*mighty.scale,this.firstTouch===g&&
(this.cachedEvent.set(a,Input.Key.BUTTON_LEFT,d,e),this.chn_input.signal(Input.Event.INPUT_UP,self.cachedEvent),this.firstTouch=null))}0===this.numActiveTouches&&(this.isDrag=!1)}},handleTouchMove:function(a){if(!this.engine.blockInput){a.preventDefault();for(var b=a.changedTouches,c=b.length,d=0,e=0,d=0,e=d=null,f=0;f<c;f++)e=b[f],d=e.identifier,d=this.getTouchByUid(d),null!==d&&(d=(e.pageX-this.engine.offsetLeft)*mighty.scale,e=(e.pageY-this.engine.offsetTop)*mighty.scale,1===this.numActiveTouches?
(this.cachedEvent.set(a,Input.Key.BUTTON_LEFT,d,e),this.chn_input.signal(Input.Event.MOVED,this.cachedEvent)):this.isTouchPressed=!1,this.isDrag=!0);this.processActiveTouches()}},handleTouchCancel:function(a){this.engine.blockInput||(a.preventDefault(),this.handleTouchEnd(a))},handleKeyDown:function(a){if(!this.engine.blockInput&&(!this.cfg.stickyKeys||!this.keys[a.keyCode]))this.keys[a.keyCode]=!0,this.cachedEvent.set(a,a.keyCode,0,0),this.chn_input.signal(Input.Event.KEY_DOWN,this.cachedEvent)},
handleKeyUp:function(a){if(!this.engine.blockInput&&(!this.cfg.stickyKeys||this.keys[a.keyCode]))this.keys[a.keyCode]=!1,this.cachedEvent.set(a,a.keyCode,0,0),this.chn_input.signal(Input.Event.KEY_UP,this.cachedEvent)},processActiveTouches:function(){for(var a=0;a<this.numLinks;++a){var b=this.links[a];b.isActive()&&1==this.numActiveLinks&&this.processPinch(b)}},processPinch:function(a){var b=a.item2.x-a.item1.x,a=a.item2.y-a.item1.y,b=Math.sqrt(b*b+a*a),a=this.prevPinchDistance-b;0<a?(this.cachedEvent.set(0,
a,0),this.chn_input.signal(Input.Event.PINCH_IN,this.cachedEvent)):(this.cachedEvent.set(0,a,0),this.chn_input.signal(Input.Event.PINCH_OUT,this.cachedEvent));this.prevPinchDistance=b},getTouchByUid:function(a){for(var b=0;b<this.numFingers;++b){var c=this.touches[b];if(c.uid===a)return c}return null},getFreeTouch:function(){for(var a=0;a<this.numFingers;++a){var b=this.touches[a];if(-1===b.uid)return b}return null},getFreeLink:function(){for(var a=0;a<this.numLinks;++a){var b=this.links[a];if(b.isFree())return b}return null},
handleSignal_Input:function(a,b){switch(a){case Input.Event.IS_KEY:if(void 0!==this.keys[b])return this.keys[b];break;case Input.Event.GET_KEYS:return this.keys}return!1},handleSignal_Scene:function(a){switch(a){case Scene.Event.LOADED:return this.reset(),!0}return!1},loadIgnoreKeys:function(){this.ignoreKeys=[];this.ignoreKeys[8]=1;this.ignoreKeys[9]=1;this.ignoreKeys[13]=1;this.ignoreKeys[17]=1;this.ignoreKeys[91]=1;this.ignoreKeys[38]=1;this.ignoreKeys[39]=1;this.ignoreKeys[40]=1;this.ignoreKeys[37]=
1;this.ignoreKeys[112]=1;this.ignoreKeys[113]=1;this.ignoreKeys[114]=1;this.ignoreKeys[115]=1;this.ignoreKeys[116]=1;this.ignoreKeys[117]=1;this.ignoreKeys[118]=1;this.ignoreKeys[119]=1;this.ignoreKeys[120]=1;this.ignoreKeys[121]=1;this.ignoreKeys[122]=1;this.ignoreKeys[123]=1;this.ignoreKeys[124]=1;this.ignoreKeys[125]=1;this.ignoreKeys[126]=1;this.cmdKeys=[];this.cmdKeys[91]=1;this.cmdKeys[17]=1;this.iFrameKeys=[];this.iFrameKeys[37]=1;this.iFrameKeys[38]=1;this.iFrameKeys[39]=1;this.iFrameKeys[40]=
1},activateTouches:function(){mighty.Device.isCocoonJS&&(CocoonJS.App.disableTouchInTheWebView(),CocoonJS.App.enableTouchInCocoonJS())},resetTouches:function(){Input.plugin.firstTouch=!1;Input.plugin.numChangedTouches=0;Input.plugin.numActiveTouches=0;mighty.Device.isCocoonJS&&(CocoonJS.App.disableTouchInCocoonJS(),CocoonJS.App.enableTouchInTheWebView());this.cachedEvent.set({},Input.Key.BUTTON_LEFT,Cursor.plugin.x,Cursor.plugin.y);this.chn_input.signal(Input.Event.MOVED,this.cachedEvent);mighty.camera.isDrag=
!1;mighty.camera.isPrepareDrag=!1;mighty.camera.drawX=Cursor.plugin.x;mighty.camera.drawY=Cursor.plugin.y;for(var a=0;a<this.numFingers;++a){var b=this.touches[a];b.uid=-1;b.item1=null;b.item2=null}},touches:null,numFingers:0,numActiveTouches:0,links:null,numLinks:0,numActiveLinks:0,isPressed:null,isTouchPressed:!1,tTouchEnd:0,touchEndAction:null,prevPinchDistance:0,chn_input:null,chn_debug:null,cachedEvent:null,stickyKeys:null,isDrag:!1,prevX:0,prevY:0,firstTouch:null,ignoreKeys:null,cmdKeys:null,
iFrameKeys:null,numCmdKeys:0});Input.EventInfo=function(a,b,c,d,e,f){this.set=function(a,b,c,d,e,f){this.alternativeEvent=a;this.keyCode=b;this.x=c;this.y=d;this.prevX=e;this.prevY=f};this.keyCode=b;this.x=c;this.y=d;this.prevX=e;this.prevY=f;this.alternativeEvent=null};
Input.TouchItem=function(a){this.show=function(){this.prevX=this.x;this.prevY=this.y};this.move=function(a,c){this.prevX=this.x;this.prevY=this.y;this.x=a;this.y=c};this.id=a;this.uid=-1;this.prevY=this.prevX=this.y=this.x=0;this.link=null};Input.TouchLink=function(a){this.isFree=function(){return!this.item1||!this.item2};this.isActive=function(){return this.item1&&this.item2};this.id=a;this.item2=this.item1=null};void 0!==Input&&(Input._macroBuffer={});
mighty.OnInputMove=function(a,b){void 0!==Input&&(void 0===b&&(b=a,a=null),mighty._IsOnInputUnique("inputMove",a)?(void 0===Input._macroBuffer.inputMove&&(Input._macroBuffer.inputMove=[]),a={o:a,e:"inputMove"},Input._macroBuffer.inputMove.push(a),SubscribeChannel(a,"Input",function(a,d){a===Input.Event.MOVED&&b(d)})):mighty.Error.warning("mighty.OnInputMove","Object is already subscribed to the event!"))};
mighty.OnInputDown=function(a,b){void 0===b&&(b=a,a=null);mighty._IsOnInputUnique("inputDown",a)?(void 0===Input._macroBuffer.inputDown&&(Input._macroBuffer.inputDown=[]),a={o:a,e:"inputDown"},Input._macroBuffer.inputDown.push(a),SubscribeChannel(a,"Input",function(a,d){a===Input.Event.INPUT_DOWN&&b(d)})):mighty.Error.warning("mighty.OnInputDown","Object is already subscribed to the event!")};
mighty.OnInputUp=function(a,b){void 0===b&&(b=a,a=null);mighty._IsOnInputUnique("inputUp",a)?(void 0===Input._macroBuffer.inputUp&&(Input._macroBuffer.inputUp=[]),a={o:a,e:"inputUp"},Input._macroBuffer.inputUp.push(a),SubscribeChannel(a,"Input",function(a,d){(a===Input.Event.INPUT_UP||a===Input.Event.CLICKED)&&b(d)})):mighty.Error.warning("mighty.OnInputUp","Object is already subscribed to the event!")};
mighty.OnKeyDown=function(a,b){void 0===b&&(b=a,a=null);mighty._IsOnInputUnique("keyDown",a)?(void 0===Input._macroBuffer.keyDown&&(Input._macroBuffer.keyDown=[]),a={o:a,e:"keyDown"},Input._macroBuffer.keyDown.push(a),SubscribeChannel(a,"Input",function(a,d){a===Input.Event.KEY_DOWN&&b(d)})):mighty.Error.warning("mighty.OnKeyDown","Object is already subscribed to the event!")};
mighty.OnKeyUp=function(a,b){void 0===b&&(b=a,a=null);mighty._IsOnInputUnique("keyUp",a)?(void 0===Input._macroBuffer.keyUp&&(Input._macroBuffer.keyUp=[]),a={o:a,e:"keyUp"},Input._macroBuffer.keyUp.push(a),SubscribeChannel(a,"Input",function(a,d){a===Input.Event.KEY_UP&&b(d)})):mighty.Error.warning("mighty.OnKeyUp","Object is already subscribed to the event!")};mighty.RemoveOnInputMove=function(a){mighty._RemoveOnInput("inputMove",a)};
mighty.RemoveOnInputDown=function(a){mighty._RemoveOnInput("inputDown",a)};mighty.RemoveOnInputUp=function(a){mighty._RemoveOnInput("inputUp",a)};mighty.RemoveOnKeyDown=function(a){mighty._RemoveOnInput("keyDown",a)};mighty.RemoveOnKeyUp=function(a){mighty._RemoveOnInput("keyUp",a)};
mighty._RemoveOnInput=function(a,b){var c=Input._macroBuffer[a];if(void 0!==c){var d,e,f=c.length;if(null!==b&&void 0!==b)for(e=0;e<f;e++){if(d=c[e],d.o===b&&d.e===a){UnsubscribeChannel(d,"Input");c[e]=c[f-1];c.pop();break}}else for(e=0;e<f;e++)d=c[e],null===d.o&&d.e===a&&(UnsubscribeChannel(d,"Input"),c[e]=c[f-1],c.pop())}};
mighty._IsOnInputUnique=function(a,b){if(null===b)return!0;var c=Input._macroBuffer[a];if(void 0===c)return!0;for(var d,e=c.length,f=0;f<e;f++)if(d=c[f],d.o===b&&d.e===a)return!1;return!0};
Patch.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+102;this.visiblePatchs=[]},install:function(){this.entityMgr=this.scene.entityMgr;var a=this;SubscribeChannel(this,"Patch.IN",function(b,c){return a.handleSignal_Patch(b,c)});SubscribeChannel(this,"Engine",function(b,c){return a.handleSignal_Engine(b,c)});SubscribeChannel(this,"Camera",function(b,c){a.handleSignal_Camera(b,c)});switch(Terrain.Cfg.type){case Terrain.Type.TOP_DOWN:this.getPatchAt=this.getPatchAt_TopDown;break;
case Terrain.Type.ISOMETRIC:this.getPatchAt=this.getPatchAt_Isometric}},create:function(a){this.level=a;this.updateCfg();this.createPatches();this.updateView=Terrain.Cfg.type===Terrain.Type.TOP_DOWN?this._updateView_TopDown:this._updateView_Isometric},createPatches:function(){var a=this.cfg,b=Terrain.Cfg;this.terrainCfg=b;this.patchs=Array(a.numPatchs);this.visiblePatchs.length=a.numPatchs;for(var c=Patch[Patch.Obj[Terrain.Cfg.type]],d=0,e=new mighty.Math.Vector2(0,0),f=0;f<a.numY;f++)for(var e=this.getRowPos(e,
f),g=0;g<a.numX;g++){var h=a.numTilesX,i=a.numTilesY,k=g*h,j=f*i;k+h>b.numTilesX&&(h-=k+h-b.numTilesX);j+i>b.numTilesY&&(i-=j+i-b.numTilesY);h=new c(d,g,f,e.x,e.y,a.width,a.height,k,j,h,i);h.parent=this;h.prepare();this.patchs[d]=h;d++;e=this.getNextPos(e)}this.genBoundsPatch();this.useGrid(this.terrainCfg.grid.use);this.isLoaded=!0},unload:function(){this._super();this.grid&&(this.grid.clear(),this.grid=null);this.level=null;this.patchs=[];this.boundsPatch=null;this.visiblePatchs=[];this.prevEndNodeY=
this.prevEndNodeX=this.prevStartNodeY=this.prevStartNodeX=this.numVisiblePatchs=0;this.isNeedUpdateView=this.isNeedRender=!1;this.grid&&this.grid.clear();mighty.context.clearRect(0,0,this.camera.width,this.camera.height)},load:function(){this.level=this.scene.level},update:function(){this.isNeedUpdateView&&this.updateView()},drawDebug:function(){for(var a=0;a<this.numVisiblePatchs;++a)this.visiblePatchs[a].renderDebug()},updateView:null,_updateView_TopDown:function(){if(this.level&&this.camera){Entity.plugin.isNeedRender=
!0;this.isNeedUpdateView=!1;var a=this.camera.viewFrustum,b=Math.floor(a.minX/this.cfg.optimalSizeX),c=Math.floor(a.minY/this.cfg.optimalSizeY),d=Math.ceil(a.maxX/this.cfg.optimalSizeX),e=Math.ceil(a.maxY/this.cfg.optimalSizeY),b=Math.max(0,b),c=Math.max(0,c),d=Math.max(0,d),e=Math.max(0,e);0>b&&(b=0);0>c&&(c=0);d>this.cfg.numX&&(d=this.cfg.numX);e>this.cfg.numY&&(e=this.cfg.numY);this._updateViewGrid_TopDown();var f,g;for(g=c;g<e;g++)for(f=b;f<d;f++)j=this.patchs[f+this.cfg.numX*g],j.visibility=
a.vsAABBIntersection(j.volume);if(!(b===this.prevStartNodeX&&c===this.prevStartNodeY&&d===this.prevEndNodeX&&e===this.prevEndNodeY)){a=Math.min(this.prevStartNodeX,b);f=Math.min(this.prevStartNodeY,c);var h=Math.max(this.prevEndNodeX,d),i=Math.max(this.prevEndNodeY,e),k,j;this.numVisiblePatchs=0;for(g=f;g<i;g++){k=g*this.cfg.numX;for(f=a;f<h;f++)j=k+f,j=this.patchs[j],f>=b&&f<d&&g>=c&&g<e?(j.setVisible(!0),this.visiblePatchs[this.numVisiblePatchs]=j,this.numVisiblePatchs++):j.setVisible(!1)}this.prevStartNodeX=
b;this.prevStartNodeY=c;this.prevEndNodeX=d;this.prevEndNodeY=e}}},_updateView_Isometric:function(){if(this.level&&this.camera){Entity.plugin.isNeedRender=!0;this.isNeedUpdateView=!1;var a,b=0,c=this.cfg.numX,d=this.cfg.numY;a=Math.max(0,0);b=Math.max(0,b);c=Math.max(0,c);d=Math.max(0,d);0>a&&(a=0);0>b&&(b=0);c>this.cfg.numX&&(c=this.cfg.numX);d>this.cfg.numY&&(d=this.cfg.numY);this._updateViewGrid_Isometric();if(!(a===this.prevStartNodeX&&b===this.prevStartNodeY&&c===this.prevEndNodeX&&d===this.prevEndNodeY)){var e=
Math.min(this.prevStartNodeX,a),f=Math.min(this.prevStartNodeY,b),g=Math.max(this.prevEndNodeX,c),h=Math.max(this.prevEndNodeY,d),i;this.numVisiblePatchs=0;for(var k=f;k<h;k++)for(var f=k*this.cfg.numX,j=e;j<g;j++)i=f+j,i=this.patchs[i],j>=a&&j<c&&k>=b&&k<d?(i.setVisible(!0),this.visiblePatchs[this.numVisiblePatchs]=i,this.numVisiblePatchs++):i.setVisible(!1);this.prevStartNodeX=a;this.prevStartNodeY=b;this.prevEndNodeX=c;this.prevEndNodeY=d}}},_updateViewGrid_TopDown:function(){var a=this.camera.viewFrustum;
this.startGridX=Math.floor(a.minX/this.terrainCfg.tileWidth);this.startGridY=Math.floor(a.minY/this.terrainCfg.tileHeight);this.endGridX=Math.ceil(a.maxX/this.terrainCfg.tileWidth);this.endGridY=Math.ceil(a.maxY/this.terrainCfg.tileHeight);this.offsetX=a.minX%this.terrainCfg.tileWidth-this.startGridX*this.terrainCfg.tileWidth;this.offsetY=a.minY%this.terrainCfg.tileHeight-this.startGridY*this.terrainCfg.tileHeight;0>this.startGridX&&(this.startGridX=0);0>this.startGridY&&(this.startGridY=0);this.endGridX>
this.level.terrain.sizeX&&(this.endGridX=this.level.terrain.sizeX);this.endGridY>this.level.terrain.sizeY&&(this.endGridY=this.level.terrain.sizeY)},_updateViewGrid_Isometric:function(){this.startGridY=this.startGridX=0;this.endGridX=this.level.sizeX;this.endGridY=this.level.sizeY},updatePatchAt:function(a,b){this.patchs[a+b*this.cfg.numX].isNeedRender=!0},genBoundsPatch:function(){this.boundsPatch=new Patch[Patch.Obj[Terrain.Cfg.type]];this.boundsPatch.id=-1;this.boundsPatch.parent=this;this.boundsPatch.isVisible=
!0;return this.boundsPatch},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.setCamera(b);break;case Engine.Event.ZOOM:this.updateView()}},handleSignal_Camera:function(a){switch(a){case Camera.Event.MOVED:this.updateView()}},handleSignal_Patch:function(a,b){switch(a){case Patch.Event.VISIBLE_PATCHES:return this.visiblePatchs;case Patch.Event.USE_GRID:return this.useGrid(b),!0;case Patch.Event.UPDATE_VIEW:return this.updateView(),!0}return!1},setCamera:function(a){if(this.camera=
a)this.isNeedUpdateView=!0},setTerrainData:function(a){for(var b=0;b<this.cfg.numPatchs;b++){var c=this.patchs[b];c.data=a;c.prepareDraw()}this.isNeedRender=!0},getPatch:function(a,b){return 0>a||a>=this.cfg.numX||0>b||b>=this.cfg.numY?this.boundsPatch:this.patchs[a+b*this.cfg.numX]},getPatchAt:null,getPatchAt_TopDown:function(a,b){a=Math.floor(a/this.cfg.width);if(0>a||a>=this.cfg.numX)return this.boundsPatch;b=Math.floor(b/this.cfg.height);return 0>b||b>=this.cfg.numY?this.boundsPatch:this.patchs[a+
b*this.cfg.numX]},getPatchAt_Isometric:function(){console.log("Patch.Manager.getPatchAt_Isometric() :: To be implemented!");return null},getPatchFromGridPos:function(a,b){if(!this.boundsPatch)return this.genBoundsPatch();if(isNaN(a)||isNaN(b)||a>=this.level.numGridX)return this.boundsPatch;var c=Math.floor(a/this.cfg.numGridX);if(0>c||b>=this.level.numGridY)return this.boundsPatch;var d=Math.floor(b/this.cfg.numGridY);if(0>d)return this.boundsPatch;c+=d*this.cfg.numX;return c>=this.cfg.numPatchs?
this.boundsPatch:this.patchs[c]},getNextPos:function(a){var b=Terrain.Cfg;switch(b.type){case Terrain.Type.ISOMETRIC:return a.x+=this.cfg.numTilesX*b.halfTileWidth,a.y+=this.cfg.numTilesX*Math.floor(b.halfTileHeight),a;case Terrain.Type.TOP_DOWN:return a.x+=this.cfg.numTilesX*b.tileWidth,a}return null},getRowPos:function(a,b){var c=Terrain.Cfg;switch(c.type){case Terrain.Type.ISOMETRIC:return a.x=-(this.cfg.numTilesY*c.halfTileWidth)*b,a.y=this.cfg.numTilesY*Math.floor(c.halfTileHeight)*b,a;case Terrain.Type.TOP_DOWN:return a.x=
this.cfg.startPosX,a.y=this.cfg.startPosY+this.cfg.numTilesY*c.tileHeight*b,a}return null},setPatchFromGridPos:function(a,b,c){a.patch=null;a.entityPatch=null;for(var d=0;d<this.numVisiblePatchs;d++){var e=this.visiblePatchs[d];if(e.gridAABB.vsPoint(b,c)){a.patch=e;break}}},updateCfg:function(){var a=Patch.Cfg,b=Terrain.Cfg;this._updateCfgPatches();a.numTilesX=a.optimalSizeX/b.tileWidth;a.numTilesY=a.optimalSizeY/b.tileHeight;a.numGridX=a.optimalSizeX/b.grid.width;a.numGridY=a.optimalSizeY/b.grid.height;
b.grid.sizeX=Math.ceil(b.width/b.grid.width);b.grid.sizeY=Math.ceil(b.height/b.grid.height);switch(b.type){case Terrain.Type.ISOMETRIC:a.width=Math.ceil(a.numTilesX*b.halfTileWidth+a.numTilesY*b.halfTileWidth);a.height=Math.ceil(a.numTilesY*b.halfTileHeight+a.numTilesX*b.halfTileHeight);break;case Terrain.Type.TOP_DOWN:a.width=a.numTilesX*b.tileWidth,a.height=a.numTilesY*b.tileHeight}a.halfWidth=a.width/2;a.halfHeight=a.height/2;a.startPosX=0;a.startPosY=0},_updateCfgPatches:function(){var a=Terrain.Cfg,
b;switch(a.type){case Terrain.Type.TOP_DOWN:this.cfg.optimalSizeX<a.tileWidth?this.cfg.optimalSizeX=a.tileWidth:(b=this.cfg.optimalSizeX%a.tileWidth,this.cfg.optimalSizeX=b<=a.halfTileWidth?this.cfg.optimalSizeX-b:this.cfg.optimalSizeX+(a.tileHeight-b));this.cfg.optimalSizeY<a.tileHeight?this.cfg.optimalSizeY=a.tileHeight:(b=this.cfg.optimalSizeY%a.tileHeight,this.cfg.optimalSizeY=b<=a.halfTileHeight?this.cfg.optimalSizeY-b:this.cfg.optimalSizeY+(a.tileHeight-b));break;case Terrain.Type.ISOMETRIC:this.cfg.optimalSizeX=
this.cfg.optimalSizeX>a.tileWidth?this.cfg.optimalSizeX-this.cfg.optimalSizeX%a.tileWidth:a.tileWidth,this.cfg.optimalSizeY=this.cfg.optimalSizeY>a.tileHeight?this.cfg.optimalSizeY-this.cfg.optimalSizeY%a.tileHeight:a.tileHeight}this.cfg.numX=Math.ceil(a.width/this.cfg.optimalSizeX);this.cfg.numY=Math.ceil(a.height/this.cfg.optimalSizeY);this.cfg.numPatchs=this.cfg.numX*this.cfg.numY},updatePatchDebug:function(){this.$debuger.html("[numPatchs]: "+this.numPatchs+" [numVisiblePatchs]: "+this.numVisiblePatchs)},
useGrid:function(a){(this.terrainCfg.grid.use=a)?this.grid||(this.grid=new Patch.Grid(this.terrainCfg.grid.width,this.terrainCfg.grid.height,this.terrainCfg.grid.sizeX,this.terrainCfg.grid.sizeY)):this.grid&&(this.grid.clear(),this.grid=null)},cfg:null,terrainCfg:null,camera:null,level:null,entityMgr:null,patchs:null,visiblePatchs:null,numVisiblePatchs:0,boundsPatch:null,grid:null,startGridX:0,startGridY:0,endGridX:0,endGridY:0,offsetX:0,offsetY:0,prevStartNodeX:0,prevStartNodeY:0,prevEndNodeX:0,
prevEndNodeY:0,isNeedRender:!1,isNeedUpdateView:!1,$debuger:null});
Patch.Patch=Class.extend({init:function(a,b,c,d,e,f,g,h,i,k,j){this.entities=[];this.id=a;this.patchX=b;this.patchY=c;this.x=d;this.y=e;this.width=f;this.height=g+(Terrain.Cfg.tileDepth-1);this.gridX=h;this.gridY=i;this.gridWidth=k;this.gridHeight=j;this.entitiesToAdd=[];this.entitiesToRemove=[]},initBoundingVolume:function(){var a=this.x,b=this.y;this.volume=new mighty.Math.AABB(a,b,a+this.width,b+this.height);this.gridAABB=new mighty.Math.AABB(this.gridX,this.gridY,this.gridX+this.gridWidth-1,this.gridY+
this.gridHeight-1)},initRenderTarget:function(){this.texture=new Resource.Texture;this.texture.generate(this.width,this.height);this.canvas=this.texture.image;this.renderTarget=this.texture.ctx},prepare:function(){this.gridMaxX=this.gridX+this.gridWidth;this.gridMaxY=this.gridY+this.gridHeight;this.initBoundingVolume()},prepareDraw:function(){this.numTiles=this.gridWidth*this.gridHeight;this.tiles=Array(this.numTiles);mighty.engine.pushRenderTarget(this.renderTarget);this.isRendered&&mighty.context.clearRect(0,
0,this.width,this.height);for(var a=0,b=0,c=0,d=new mighty.Math.Vector2(this.startX,this.startY),e=this.gridY;e<this.gridMaxY;e++){a=this.gridX+e*Terrain.Cfg.numTilesX;this.getRowPos(d,b);b++;for(var f=this.gridX;f<this.gridMaxX;f++){var g=this.data[a];g.drawX=d.x;g.drawY=d.y;g.patch=this;this.tiles[c]=g;c++;this.getNextPos(d);a++}}},preRender:function(){mighty.engine.pushRenderTarget(this.renderTarget);var a=mighty.context;this.isRendered&&a.clearRect(0,0,this.width,this.height);for(var b=0;b<this.numLayers;++b)for(var c=
0;c<this.numTiles;++c)this.tiles[c].draw(a,b);if(b=mighty.engine.filter)b.process(this.texture),a.drawImage(b.img,0,0,this.width,this.height);mighty.engine.popRenderTarget();this.isRendered=!0;this.isNeedRender=!1},updateVisibility:function(){},clear:function(a,b,c,d){this.renderTarget.clearRect(a,b,c,d)},draw:function(a){var b=a.minX,c=a.minY,d=a.maxX,e=a.maxY;this.volume.minX>b&&(b=this.volume.minX);this.volume.maxX<d&&(d=this.volume.maxX);d-=b;if(!(0>=d)&&(this.volume.minY>c&&(c=this.volume.minY),
this.volume.maxY<e&&(e=this.volume.maxY),e-=c,!(0>=e))){var f=-a.minX+b,a=-a.minY+c,b=b-this.x,c=c-this.y;mighty.context.drawImage(this.canvas,b,c,d,e,f,a,d,e)}},redrawLayerRegion:function(a,b,c,d,e,f){var g=mighty.context;g.drawImage(this.canvas,a,b,e,f,c,d,e,f);(new mighty.Math.AABB(c,d,c+e,d+f)).draw(g)},renderDebug:function(){mighty.ctx.strokeStyle="red";this.volume.drawTranslated(mighty.ctx)},add:function(a){this.isBusy?this.entitiesToAdd.push(a):(this.entities.push(a),this.numEntities++);a.patch=
this;this.isVisible?a.setVisibleBuffer(!0):a.setVisibleBuffer(!1)},remove:function(a){if(this.isBusy)this.entitiesToRemove.push(a);else for(var b=0;b<this.numEntities;++b)if(this.entities[b]===a){this.entities[b]=this.entities[this.numEntities-1];this.entities.pop();this.numEntities--;break}},handleBuffers:function(){for(var a=this.entitiesToAdd.length,b=0;b<a;b++)this.entities.push(this.entitiesToAdd[b]),this.numEntities++;for(var c=null,a=this.entitiesToRemove.length,b=0;b<a;b++)for(var c=this.entitiesToRemove[b],
d=0;d<this.numEntities;++d)if(this.entities[d]===c){this.entities[d]=this.entities[this.numEntities-1];this.entities.pop();this.numEntities--;return}this.entitiesToAdd.length=0;this.entitiesToRemove.length=0},addToUpdate:function(a){a.isQueuedUpdate||(this.updateBuffer.push(a),this.numToUpdate++,this.parent.entityMgr.isNeedUpdate=!0)},resetUpdateBuffer:function(){this.updateBuffer=[];this.numToUpdate=0},orderPreRender:function(){this.isNeedRender=!0;this.isVisible&&(this.parent.isNeedRender=!0)},
setVisible:function(a){a!==this.isVisible&&((this.isVisible=a)?this.addToVisible():this.removeFromVisible(),a&&!this.isRendered&&(this.isNeedRender=!0))},addToVisible:function(){this.isBusy=!0;for(var a=0;a<this.numEntities;a++)this.entities[a].setVisibleBuffer(!0);this.isBusy=!1;this.handleBuffers()},removeFromVisible:function(){this.isBusy=!0;for(var a=0;a<this.numEntities;a++)this.entities[a].setVisibleBuffer(!1);this.isBusy=!1;this.handleBuffers()},isPointInside:function(a,b){return this.gridX>
a||this.gridY>b||this.gridMaxX<=a||this.gridMaxY<=b?!1:!0},parent:null,data:null,entities:null,numEntities:0,id:0,patchX:0,patchY:0,x:0,y:0,width:0,height:0,type:0,visibility:2,startX:0,startY:0,gridX:0,gridY:0,gridMaxX:0,gridMaxY:0,gridWidth:0,gridHeight:0,volume:null,gridAABB:null,cropAABB:null,texture:null,canvas:null,renderTarget:null,numLayers:1,isVisible:!1,isRendered:!1,isNeedRender:!0,isBusy:!1});
Patch.Isometric=Patch.Patch.extend({prepare:function(){this._super();this.startX=Math.floor(Terrain.Cfg.halfTileWidth)*this.parent.cfg.numTilesY;this.startY=Math.floor(Terrain.Cfg.halfTileHeight)},getNextPos:function(a){a.x+=Math.floor(Terrain.Cfg.halfTileWidth);a.y+=Math.floor(Terrain.Cfg.halfTileHeight);return a},getRowPos:function(a,b){a.x=this.startX-b*Math.floor(Terrain.Cfg.halfTileWidth);a.y=this.startY+b*Math.floor(Terrain.Cfg.halfTileHeight);return a},offsetX:0,offsetY:0});
Patch.TopDown=Patch.Patch.extend({getNextPos:function(a){a.x+=Terrain.Cfg.tileWidth;return a},getRowPos:function(a,b){a.x=0;a.y=Terrain.Cfg.tileHeight*b;return a}});
Patch.Grid=function(a,b,c,d){this.init=function(){this.cells=Array(this.numCells);for(var a=0;a<this.numCells;a++)this.cells[a]=[];this.cellInfo=new Patch.CellInfo(0,0);this.isSorting=Terrain.Cfg.grid.isDepthSorting;var b=this;SubscribeChannel(this,"Grid",function(a,c){return b.handleSignal_Grid(a,c)})};this.clear=function(){this.cells=null;UnsubscribeChannel(this,"Grid")};this.draw=function(a){for(var b=Terrain.Cfg.grid,c=new mighty.Math.AABB(0,0,0,0),d,i=0;i<this.numCells;i++)if((d=this.cells[i])&&
d.length)c.minX=i%this.sizeX*b.width,c.minY=Math.floor(i/this.sizeX)*b.height,c.maxX=c.minX+b.width,c.maxY=c.minY+b.height,c.drawTranslated(a)};this.handleSignal_Grid=function(a,b){switch(a){case Grid.Event.IS_CELL_FULL:return this.isCellFull(b);case Grid.Event.GET_CELL:return this.getCellAt(b.gridX,b.gridY);case Grid.Event.GET_RANDOM_CELL:return this.getRandomCell()}return!1};this.remove=function(a){if(this.cells){var b=a.gridX+a.gridY*this.sizeX;if(!(0>b||b>=this.numCells))for(var b=this.cells[b],
c=b.length,d,i=0;i<c;i++)if(d=b[i],d===a){b.splice(i,1);break}}};this.updateCell=function(a){if(-1<a.prevGridX){var b=this.cells[a.prevGridX+a.prevGridY*this.sizeX];if(void 0!==b)for(var c=b.length,d,i=0;i<c;i++)if(d=b[i],d===a){b.splice(i,1);break}}b=a.gridX+a.gridY*this.sizeX;0>b||b>=this.numCells||(isNaN(b)?mighty.Error.error("Grid.updateCell","Entity grid position is NaN!"):(this.cells[b].push(a),this.isSorting&&this.cells[b].sort(this._func_depthSort)))};this.getCellAt=function(a,b){return 0>
a||a>=this.sizeX||0>b||b>=this.sizeY?null:this.cells[a+b*this.sizeX]};this.isCellFull=function(a){var b=this.getCellAt(a.gridX,a.gridY);if(void 0===b)return null;if(a.isOnCell){if(b&&1===b.length)return null}else if(!b||0===b.length)return null;this.cellInfo.gridX=a.gridX;this.cellInfo.gridY=a.gridY;this.cellInfo.cell=b;return this.cellInfo};this.getRandomCell=function(){var a=mighty.Random.getNumber(0,this.sizeX-1),b=mighty.Random.getNumber(0,this.sizeY-1),c=a+b*this.sizeX;this.cellInfo.gridX=a;
this.cellInfo.gridY=b;this.cellInfo.cell=this.cells[c];return this.cellInfo};this._func_depthSort=function(a,b){return b.depth-a.depth};this.cellInfo=this.cells=null;this.width=a;this.height=b;this.sizeX=c;this.sizeY=d;this.numCells=c*d;this.isSorting=!1;this.init()};Patch.CellInfo=function(a,b){this.cell=null;this.gridX=a;this.gridY=b;this.isOnCell=!1};Scene.State=function(){this.tRender=this.tUpdate=this.tFrame=this.tFPS=this.trueFPS=this.fps=0};
Scene.State.prototype={setup:function(){this.tFPS=0;this.tUpdate=Date.now();this.tRender=Date.now()}};
Scene.Manager=Class.extend({init:function(){mighty.engine.subscribe(this);this.engineCfg=Engine.Cfg;var a=this;this.updateFunc=function(){a.update()};this.renderFunc=function(){a.render()};this.chn_scene=CreateChannel("Scene");Scene.plugin=this},update:function(){var a=Date.now(),b=a-this.state.tUpdate;this.state.tUpdate=a;this.resourceMgr.isLoaded&&this.currScene.isLoaded&&(100<b&&(b=100),this.currScene._update(b/1E3),this.isRendering||(this.isRendering=!0,this.render()));a=Date.now();b=a-this.state.tUpdate;
a=Math.max(0,this.engineCfg.tSleep-b);window.setTimeout(this.updateFunc,a)},render:function(){var a=Date.now(),b=a-this.state.tRender;this.state.tRender=a;this.state.fps++;1E3<=a-this.state.tFPS&&(this.chn_scene.signal(Scene.Event.STATE,this.state),this.state.fps=0,this.state.tFPS=a);mighty.engine.isVisible&&this.currScene.render(this.tAccumulator/this.engineCfg.tUpdateDelta,b);this.state.tRender=Date.now();requestAnimationFrame(this.renderFunc)},handleResize:function(a,b){this.currScene.handleResize(a,
b)},setCurrentScene:function(a){mighty.Template.removeAll();this.currentScene=this.currScene=a;this.currScene._install();this.currScene.install();this.currScene.setup();this.currScene._setup();this.state=a.state;this.state.setup();this.tAccumulator=this.engineCfg.tUpdateDelta;this.isRendering=!1;this.resourceMgr=Resource.plugin},engineCfg:null,currScene:null,state:null,resourceMgr:null,tScene:0,tAccumulator:0,updateFunc:null,renderFunc:null,chn_scene:null,tFPS:0,tmpFPS:0,tFrame:0,tFrameInfo:0,numFramesRec:0,
isRendering:!1});
Scene.Base=Class.extend({init:function(){this.plugins={};this.pluginsBuffer=[];this.updatePlugins=[];this.renderPlugins=[];this.timerPlugins=[];this.state=new Scene.State;this.delayedSignals=[];var a=this;this.flags=new mighty.Flag;this.flags.cb=function(){a.onFlagsLoad()};this.flags.deactivateCB=function(){a.onFlagsUnload()};this.preparePlugin("Resource");this.preparePlugin("Brush");this.preparePlugin("Component");this.terrainMgr=this.preparePlugin("Terrain");this.patchMgr=this.preparePlugin("Patch");this.entityMgr=
this.preparePlugin("Entity");this.preparePlugin("Editor");this.input=this.preparePlugin("Input");this.preparePlugin("Map");this.preparePlugin("i18n");this.preparePlugin("UI")},_install:function(){this.flags.add_Signal("Loader","Loader",Loader.Event.LOADED);this.flags.add("Level");Resource.plugin._install();Component.plugin._install();this.patchMgr._install();this.patchMgr.install();this.terrainMgr._install();this.terrainMgr.install();Brush.plugin._install();this.entityMgr._install();this.entityMgr.install();
Editor.plugin._install();Editor.plugin.install();this.input._install();this.input.install();Map.plugin._install();Map.plugin.install();var a=this.preparePlugin("Cursor");a._install();a.install();i18n.plugin._install();i18n.plugin.install();UI.plugin._install();UI.plugin.install();var a=0,b=[],c=PluginPalette,d=c.length,e;e=e=null;for(a=0;a<d;a++)if(e=window[c[a]],e=e.Cfg,!e.disabled&&(!gParams.editor||e.useInEditor))(e=this.preparePlugin(c[a]))&&b.push(e);d=b.length;for(a=0;a<d;a++)e=b[a],e._install(),
e.install();this.chn_scene=CreateChannel("Scene.OUT");var f=this;SubscribeChannel(this,"Scene.IN",function(a,b){f.handleSignal_SceneCtrl(a,b)})},_uninstall:function(){for(var a=this.pluginsBuffer.length,b=0;b<a;b++)this.pluginsBuffer[b].uninstall()},setup:mighty.EmptyFunc,install:mighty.EmptyFunc,uninstall:mighty.EmptyFunc,_setup:function(){null===this.level&&(this.isLoading||this.createEmptyLevel())},onFlagsLoad:function(){mighty.Loader.hideBlank();mighty.Loader._template&&mighty.Loader._template.hide();
this._load()},onFlagsUnload:function(){mighty.Loader.showBlank();mighty.Loader._template&&mighty.Loader._template.show()},_load:function(){if(!this.isLoading){this.isLoading=!0;mighty.engine.blockInput=!0;this.isLoaded&&(this.unload(),this.isLoaded=!1);this.load();this.isInstalled||(this.pluginsBuffer.sort(function(a,c){return c.priority-a.priority}),this.updatePlugins.sort(function(a,c){return c.priority-a.priority}),this.renderPlugins.sort(function(a,c){return c.priority-a.priority}));this.camera||
(this.camera=new Entity.Camera(this.entityMgr.createID()),mighty.engine.setCamera(this.camera));for(var a=0;a<this.numPlugins;++a)this.pluginsBuffer[a].load();this.camera.load();this.isLoading=!1;this.isLoaded=!0;mighty.Template.load();this.queuedLevel?(a=this.queuedLevel,this.queuedLevel=null,this.loadLevel(a)):(this._onReady(),this.chn_scene.signal(Scene.Event.LOADED,this),mighty.engine.blockInput=!1)}},_unload:function(){this.isReady=!1;this.numTimerPlugins=this.timerPlugins.length=0;mighty.Template.unload();
for(var a,b=0;b<this.numPlugins;++b)a=this.pluginsBuffer[b],a._unload(),a.unload();this.unload()},load:mighty.EmptyFunc,unload:mighty.EmptyFunc,ready:mighty.EmptyFunc,_onReady:function(){for(var a=0;a<this.numPlugins;a++)this.pluginsBuffer[a].ready();this.ready();this.isReady=!0},createEmptyLevel:function(a){var b=0;void 0===a||0===a.id?(a=Palettes.Entity.getByName("null"),b=0,a&&(b=a.id),mighty.editor?b=new Scene.LevelInfo(-1,"null",1,1,b):(mighty.Error.warning("Scene.createEmptyLevel","No data supplied, creating default empty map!"),
b=new Scene.LevelInfo(-1,"default",32,32,b))):(a=Palettes.Map.getByID(a.id).level,b=new Scene.LevelInfo(a.id,a.name,a.gridX,a.gridY,a.bgEntity));this.createLevel(b)},createLevel:function(a){var b=new Scene.Level(a);b.numTilesX=a.sizeX;b.numTilesY=a.sizeY;b.defaultEntityID=a.defaultEntityID;a.texture&&(b.texture=a.texture);this.level=b;this.flags.activate("Level")},saveLevel:function(){if(this.isLoaded)if(this.level){this.chn_scene.signal(Scene.Event.PRE_SAVE,this);var a=this.terrainMgr.getData(this.saveInBinary),
b=this.entityMgr.getData(this.saveInBinary);SendSignal("Server",Server.Event.SAVE_LEVEL,{action:"save",name:this.level.id,isBinary:this.saveInBinary,terrain:a,entity:b,saveOffline:Terrain.Cfg.offlineMode});this.chn_scene.signal(Scene.Event.POST_SAVE,this)}else mighty.Error.submit("Scene.saveLevel","No level file defined.");else mighty.Error.submit("Scene.saveLevel","Scene is not loaded yet.")},loadLevel:function(a){this.flags.deactivate("Level");a||(a={id:0});this.isLoading?this.queuedLevel=a:(this.isLoaded&&
(this._unload(),this.isLoaded=!1),this.level=a.level,SendSignal("Server",Server.Event.LOAD_LEVEL,a))},loadLevelData:function(a,b){b&&(a=Map["level_"+a.id]);this.level.terrain=a.terrain;this.level.entity=a.entity;this.flags.activate("Level")},reloadLevel:function(){this.level?!this.level||!this.level.name?this.isLoaded&&(this.isLoaded=!1,this._unload(),this._load()):this.loadLevel(this.level.name):mighty.Error.error("Scene.reloadLevel","No level loaded to reload.")},update:mighty.EmptyFunc,_update:function(a){if(!this.isPaused&&
this.isReady){this.update(a);for(var b=0;b<this.numUpdatePlugins;b++)this.updatePlugins[b].update(a);a*=1E3;for(b=0;b<this.numTimerPlugins;b++)this.timerPlugins[b].updateTimer(a);if(this.numDelayedSignals){a=null;for(b=0;b<this.numDelayedSignals;b++)a=this.delayedSignals[b],this.handleSignal_Scene(a.type,a.obj);this.delayedSignals=[];this.numDelayedSignals=0}}},render:function(a,b){if(this.isLoaded&&this.isReady)for(var c=0;c<this.numRenderPlugins;c++)this.renderPlugins[c].render(a,b)},handleResize:function(){this.isLoaded&&
(this.patchMgr&&this.patchMgr.updateView(),this.entityMgr.isNeedRender=!0)},preparePlugin:function(a){var b=window[a];if(void 0===b.Manager)return null;var c=new b.Manager(a);c.name=a;c.scope=b;c.scene=this;c._init();return b.plugin=c},addPlugin:function(a){this.plugins[a.name]=a;this.pluginsBuffer.push(a);this.numPlugins++;void 0!==a.update&&(this.updatePlugins.push(a),this.numUpdatePlugins++);void 0!==a.render&&(this.renderPlugins.push(a),this.numRenderPlugins++)},addPluginTimer:function(a){this.timerPlugins.push(a);
this.numTimerPlugins++;this.timerPlugins.sort(function(a,c){return c.priority-a.priority})},removePluginTimer:function(a){for(var b=0;b<this.numTimerPlugins;b++)this.timerPlugins[b]===a&&(this.timerPlugins[b]=this.timerPlugins[this.numTimerPlugins-1],this.timerPlugins.pop(),this.numTimerPlugins--);this.timerPlugins.sort(function(a,b){return b.priority-a.priority})},addTimer:function(a,b,c){Entity.plugin.addTimer(a,b,c)},removeTimer:function(a){Entity.plugin.removeTimer(a)},prepareSignal_Scene:function(a,
b){this.delayedSignals.push(new Channel.Event(a,b));this.numDelayedSignals++},handleSignal_SceneCtrl:function(a,b){switch(a){case Scene.Event.CREATE_LEVEL:return this.createLevel(b);case Scene.Event.GET_LEVEL:return this.level;case Scene.Event.LOAD_LEVEL:var c=Palettes.Map.getByName(b);if(null===c)return;this.loadLevel(c);return!0;case Scene.Event.LOAD_LEVEL_ID:c=Palettes.Map.getByID(b);if(null===c)return;this.loadLevel(c);return!0;case Scene.Event.SET_PAUSE:return this.isPaused=b,!0;case Scene.Event.SAVE_LEVEL:return this.saveLevel(),
!0;case Scene.Event.RELOAD_LEVEL:return this.reloadLevel(),!0}return!1},getPluginByID:function(a){for(var b=0;b<this.numPlugins;++b){var c=this.pluginsBuffer[b];if(c.id===a)return c}return null},getPluginByName:function(a){a=this.plugins[a];return void 0===a?null:a},camera:null,flags:null,chn_scene:null,plugins:null,pluginsBuffer:null,numPlugins:0,updatePlugins:null,renderPlugins:null,timerPlugins:null,numUpdatePlugins:0,numRenderPlugins:0,numTimerPlugins:0,input:null,entityMgr:null,terrainMgr:null,
patchMgr:null,isLoaded:!1,isLoading:!1,isInstalled:!1,isReady:!1,isPaused:!1,state:null,delayedSignals:null,numDelayedSignals:0,level:null,queuedLevel:null,saveInBinary:!1,loadInBinary:!1});Scene.Level=function(a){this.clear=function(){delete this.terrain;delete this.entity};this.data=a;this.id=a.id;this.name=a.name;this.numTilesY=this.numTilesX=0;this.sizeX=a.sizeX;this.sizeY=a.sizeY;this.entity=this.terrain=this.defaultEntityID=null};
Scene.LevelInfo=function(a,b,c,d,e){this.id=a;this.name=b;this.sizeX=c;this.sizeY=d;this.defaultEntityID=e};mighty.LoadLevel=function(a){SendSignal("Scene.IN",Scene.Event.LOAD_LEVEL,a)};mighty.ReloadLevel=function(){SendSignal("Scene.IN",Scene.Event.RELOAD_LEVEL,null)};Brush.Manager=Plugin.extend({});
Brush.Basic=Class.extend({init:function(){this.stages={};this.available={};this.actions={};this.component={}},setup:function(a,b,c){this.id=a;this.name=b;this.texture=c;this.addStage(0,this.texture,null);if(this.texture){this.width=this.texture._width;this.height=this.texture._height;var d=this,a=function(a,b){d.handleSignal_Resource(a,b)};!this.texture.isLoaded&&this.texture.subscribe(this,a)&&this.numToLoad++}},loadVar:function(a){for(var b in a)this[b]=a[b]},load:function(a){this.loadStages(a.stages);
this.loadComponents(a.component);this.loadAvailable(a.available);0>=this.numToLoad&&this._finishLoad()},update:function(){this.texture&&this.updateOffset()},clone:function(){var a=new Brush.Basic;a.setup(this.id,this.name,this.texture);a.stages=this.stages;a.component=this.component;a.available=this.available;return a},updateOffset:function(){this.drawOffsetX=this.offsetX+this.texture.offsetX;this.drawOffsetY=this.offsetY+this.texture.offsetY},subscribe:function(a,b){this.channel||(this.channel=CreateChannel("brush_"+
this.id));this.channel.subscribe(a,b,Priority.MEDIUM)},unsubscribe:function(a){this.channel&&(this.channel.unsubscribe(a),0>=this.channel.numSubscribers&&(RemoveChannel(this.channel),this.channel=null))},loadStages:function(a){if(void 0!==a)for(var b=a.length,c=this,d=function(a,b){c.handleSignal_Resource(a,b)},e=0;e<b;e++){var f=a[e],g=Resource.plugin.module.Texture.getByID(f.texture);g&&(f.options.flip!==Resource.Flip.NONE&&(g=g.flip(f.options.flip)),!g.isLoaded&&g.subscribe(this,d)&&this.numToLoad++,
this.addStage(f.type,g,f.options))}},loadComponents:function(a){if(void 0!==a){var b=Component.Obj;if(b){this.component={};for(var c=a.length,d=0;d<c;d++){var e=a[d],f=b[e.component];if(void 0===f)console.log("(Warning) Brush: No such component with id - "+e.component);else{var g=new Component[f],h;for(h in e)g[h]=e[h];this.component[f]=g}}}}},loadAvailable:function(a){if(void 0!==a)for(var b=a.length,c=0;c<b;c++)this.available[a[c]]=!0},addStage:function(a,b,c){c=new Brush.StageInfo(a,b,c);b&&(c.width=
b._width,c.height=b._height);0===this.numStages?this.defaultStage=c:b&&this.defaultStage.texture&&(b.width!=this.defaultStage.texture.width&&(c.diffX=Math.ceil((b.width-this.defaultStage.texture.width)/2)),b.height!=this.defaultStage.texture.height&&(c.diffY=Math.ceil((b.height-this.defaultStage.texture.height)/2)));this.stages[a]=c;this.numStages++},getStage:function(){return this.stages[0]},isAvailable:function(a){return this.id===a.id?!1:void 0!==this.available[a.type]||void 0!==a.available[this.type]?
!0:!1},getPreviewTexture:function(){return this.preview?this.preview:this.texture},handleSignal_Resource:function(a,b){a===Resource.Event.LOADED&&(this.numToLoad--,b.unsubscribe(this),0>=this.numToLoad&&this._finishLoad())},_finishLoad:function(){this.texture&&(this.width=this.texture.width,this.height=this.texture.height);if(mighty.engine.isWebGL){var a=mighty.context;this.vbo=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.vbo);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,this.height,0,0,this.width,
this.height,this.width,0]),a.STATIC_DRAW);this.tbo=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,this.tbo);a.bufferData(a.ARRAY_BUFFER,new Float32Array([0,1,0,0,1,1,1,0]),a.STATIC_DRAW)}this.isLoaded=!0;this.channel&&this.channel.signal(Brush.Event.LOADED,this)},id:-1,name:"",type:0,vbo:null,tbo:null,texture:null,preview:null,depthIndex:0,width:0,height:0,offsetX:0,offsetY:0,drawOffsetX:0,drawOffsetY:0,channel:null,isLoaded:!1,stages:null,defaultStage:null,numStages:0,numToLoad:0,component:null,available:null,
actions:null,isUpdatePreview:!1,isModifier:0});Brush.StageInfo=function(a,b,c){this.id=a;this.texture=b;this.options=c;this.diffY=this.diffX=this.height=this.width=0};
Entity.Loader=new function(){this.convertToBinary=function(a){for(var b=new ByteBuffer(1E3),c=Patch.Cfg.numPatchs,d=0;d<c;++d)for(var e=a.patchMgr.patchs[d],f=0;f<e.numEntities;++f){var g=e.entities[f];b.writeShort(g.gridX);b.writeShort(g.gridY);b.writeShort(g.brush.id)}return b.getData()};this.convertToJSON=function(a){var b={data:[]},c,d,e,f;e=null;for(var g=0,h=Patch.Cfg.numPatchs,i=0;i<h;++i){c=a.patchMgr.patchs[i];d=c.numEntities;for(g=0;g<d;++g)if(e=c.entities[g],e.isSaved&&!e.isNeedRemove){f=
{};this.readCoord(f,e);f.templateID=e.template.id;0!==e.angle&&(f.angle=e.angle);if(e=e.onSave())f.data=e;b.data.push(f)}}c=a.patchMgr.boundsPatch;d=c.numEntities;for(g=0;g<d;++g)e=c.entities[g],e.isSaved&&!e.isNeedRemove&&(f={},this.readCoord(f,e),f.templateID=e.template.id,b.data.push(f));return b};this.loadFromBinary=function(a){var b=a.level.buffer;if(null!==b){b.setData(a.level.entity);do{var c=b.readShort(),d=b.readShort(),e=b.readShort(),e=a.palette.getByID(e);null!==e&&(e=e.create(),e.setGridPos(c,
d),this.add(e))}while(!b.eof())}};this.loadFromJSON=function(a){this._loadStaticGrid(a);this._loadEntities(a)};this._loadStaticGrid=function(a){Terrain.plugin.level=a.level;Terrain.plugin.prepareTerrain(a.level.terrain)};this._loadEntities=function(a){Terrain.Cfg.grid.use&&(a.grid=a.patchMgr.grid);var b=a.level.entity;if(b)for(var b=b.data,c=b.length,d,e,f,g,h=null,i=0;i<c;++i)e=b[i],f=parseInt(e.x),g=parseInt(e.y),h=e.data,d=parseInt(e.templateID),d=a.palette.getByID(d),null!==d&&(d=d.create(),this.loadCoord(d,
f,g),void 0!==e.angle&&d.setAngleRad(e.angle),d.onLoad(h),a.add(d))};this.readCoord=function(a,b){a.x=b.x;a.y=b.y};this.loadCoord=function(a,b,c){a.move(b,c)}};
Entity.Geometry=Entity.Basic.extend({_init:function(){this.parent=Entity.plugin;this.id=this.parent.createID();this.node=new DepthListNode(this);this.animNode=new DepthListNode(this);this.volume=new mighty.Math.DrawAABB(0,0,0,0)},_initAfter:function(a,b){if(a){var c,d,e;for(e in a)if(c=this[e],d=a[e],void 0===c||c!==d)this[e]=d;void 0!==a.brush?"object"===typeof a.brush?this.setBrush(a.brush):this.setBrush(Palettes.Brush.getByName(a.brush)):void 0!==a.texture&&(this.setTexture(mighty.GetTextureByName(a.texture)),
this._texture&&(this.centerOffsetX=Math.floor(this.texture._width/2),this.centerOffsetY=Math.floor(this.texture._height/2),this.volume.reinit(0,0,this._texture.width,this._texture.height),this._updateState_Animated()))}else this._isPaused&&this.setPause(!0);this.forceMove(this.x,this.y);if(!b||!b.cancelLoading)this.isLoading=!1;this.handleLoaded()},remove:function(){this.isNeedRemove||(this._isVisible=!1,this.isNeedRemove=!0,this.parent.remove(this))},_removeSelf:function(){this.patch&&(this._unload(),
this.unload(),this.removeFromUpdate(),this.parent.removeFromMap(this),this.patch.remove(this),this.patch=null,this._brush&&this._brush.unsubscribe(this),this.parent.grid&&this.parent.grid.remove(this))},redraw:function(){this.isNeedDraw=!0},draw:function(a){this._draw(a)},_draw:function(a){this._drawGeometry(a)},_draw_Composite:function(a){a.globalCompositeOperation=this.composite;a.globalAlpha=this.alpha;this._drawGeometry(a);a.globalAlpha=1;a.globalCompositeOperation="source-over"},_drawTransformed:function(a){var b=
this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y;a.save();a.translate(b,c);a.rotate(this.angle);a.scale(this.scaleX,this.scaleY);a.translate(-b,-c);this._drawGeometry(a);a.restore()},_draw_TransformComposite:function(a){var b=this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y;a.save();a.translate(b,c);a.rotate(this.angle);a.scale(this.scaleX,this.scaleY);a.translate(-b,-c);a.globalCompositeOperation=this.composite;
a.globalAlpha=this.alpha;this._drawGeometry(a);a.globalAlpha=1;a.globalCompositeOperation="source-over";a.restore()},_drawMatrix:function(a){var b=this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y;a.save();a.translate(b,c);a.transform(this.matrix[0],this.matrix[1],this.matrix[3],this.matrix[4],this.matrix[6],this.matrix[7]);a.translate(-b,-c);this._drawGeometry(a);a.restore()},_drawGeometry:function(a){if(this.texture){var b=Math.floor(this.drawX+mighty.camera.x),
c=Math.floor(this.drawY+mighty.camera.y);if(this.filters){var d=0,e=this.filters.length;if(this.texture.isAnimated)for(;d<e;d++)this.texture.drawFilter(a,b,c,this.currFrame,this.filters[d]);else for(;d<e;d++)this.texture.drawFilter(a,b,c,this.filters[d])}else this.texture.isAnimated?this.texture.draw(a,b,c,this.currFrame):this.texture.draw(a,b,c)}},_draw_Rect:function(a){if(this.texture){var b=Math.floor(this.drawX+mighty.camera.x),c=Math.floor(this.drawY+mighty.camera.y),d=b,e=c,f=b+this.volume.sizeX,
g=c+this.volume.sizeY,h=mighty.camera.viewFrustum;d<h.minX&&(d=h.minX+10);e<h.minY&&(e=h.minY+10);f>h.maxX&&(f=h.maxX-10);g>h.maxY&&(g=h.maxY-10);this.filters||(this.texture.isAnimated?this.texture.draw(a,b,c,this.currFrame):this.texture.drawRect(a,d,e,d-this.x,e-this.y,f-d,g-e))}},drawGrid:null,_drawGrid_TopDown:function(a){a.strokeStyle="red";var b=this.x+mighty.camera.x,c=this.y+mighty.camera.y;(new mighty.Math.AABB(b,c,b+this.gridSizeX*Terrain.Cfg.grid.width,c+this.gridSizeY*Terrain.Cfg.grid.height)).draw(a)},
_drawGrid_Isometric:function(a){var b=this.x+mighty.camera.x,c=this.y+mighty.camera.y,d=Terrain.Cfg.grid.halfWidth,e=Terrain.Cfg.grid.halfHeight;a.strokeStyle="red";a.beginPath();a.moveTo(b,c+e);a.lineTo(b+this.gridSizeX*d,c+e-this.gridSizeX*e);a.lineTo(b+this.gridSizeX*d-this.gridSizeY*d,c-this.gridSizeX*e-this.gridSizeY*e+e);a.lineTo(b-this.gridSizeY*d,c-this.gridSizeY*e+e);a.lineTo(b,c+e);a.stroke()},drawBounds:function(a){var b,c;0!==this.angle?(b=this.drawX+this.centerOffsetX+mighty.camera.x,
c=this.drawY+this.centerOffsetY+mighty.camera.y,a.save(),a.translate(b,c),a.rotate(this.angle),a.translate(-b,-c),this.volume.drawTranslated(a),a.restore()):this.matrix?(b=this.drawX+this.centerOffsetX+mighty.camera.x,c=this.drawY+this.centerOffsetY+mighty.camera.y,a.save(),a.translate(b,c),a.transform(this.matrix[0],this.matrix[1],this.matrix[3],this.matrix[4],this.matrix[6],this.matrix[7]),a.translate(-b,-c),this.volume.drawTranslated(a),a.restore()):this.volume.drawTranslated(a)},calcDrawOffset:null,
_calcDrawOffset_TopDown:function(){},_calcDrawOffset_Isometric:function(){var a=Terrain.Cfg.grid;this.drawOffsetX=-(this.gridSizeY*a.halfWidth);this.drawOffsetY=-this._brush.height+a.halfHeight;this._brush.width<a.width&&(this.drawOffsetX+=Math.floor(a.halfWidth)-Math.floor(this._brush.width/2));this._brush.height<a.height&&(this.drawOffsetY-=Math.floor(a.halfHeight)-Math.floor(this._brush.height/2))},updatePos:function(){var a=Terrain.Cfg,b,c;switch(a.type){case Terrain.Type.ISOMETRIC:b=-(this.gridX*
a.halfTileWidth)+this.gridY*a.halfTileWidth+this.offsetX;c=this.gridY*a.halfTileHeight+this.gridX*a.halfTileHeight+this.offsetY;break;case Terrain.Type.TOP_DOWN:b=this.gridX*a.tileWidth+this.offsetX,c=this.gridY*a.tileHeight+this.offsetY}this.x=b;this.y=c},updateCenterOffset:function(){this.centerOffsetX=this.stage.width/2;this.centerOffsetY=this.stage.height/2},updateAnim:function(a){if(this.texture&&(this.tAnim+=a,!(this.tAnim<this.texture.tAnimUpdate))){a=Math.floor(this.tAnim/this.texture.tAnimUpdate);
this.tAnim-=this.texture.tAnimUpdate*a;if(this.isFlip)if(this.currFrame-=a,0>this.currFrame){this.currFrame++;this.onAnimEnd();if(!this.isAnimating){this.isNeedDraw=!0;return}this.currFrame=this.texture.totalFrames-1}else this.currFrame%=this.texture.totalFrames;else if(this.currFrame+=a,this.currFrame>=this.texture.totalFrames&&this.onAnimEnd){this.currFrame--;this.onAnimEnd();if(!this.isAnimating){this.isNeedDraw=!0;return}this.currFrame=0}else this.currFrame%=this.texture.totalFrames;this.isNeedDraw=
!0}},onAnimEnd:function(){},resetFrame:function(){this.currFrame=this.isRandFrame?this.texture.getRandFrame():this.isFlip?this.texture.totalFrames-1:0},updateDepth:null,_updateDepth_TopDown:function(){this.depth=this.gridX+this.gridY*Terrain.Cfg.sizeX+this.depthIndex;this.updateNodes();this.prevDepth=this.depth},_updateDepth_Isometric:function(){this.depth=this.gridY+this.gridX*Terrain.Cfg.sizeY+this.depthIndex;this.updateNodes();this.prevDepth=this.depth},_updateDepth_Manual:function(){this.depth=
this.depthIndex;this.updateNodes();this.prevDepth=this.depth},updateNodes:function(){this.node.depth=this.depth;this.animNode.depth=this.depth;var a=this.parent.patchMgr.getPatchFromGridPos(this.gridX,this.gridY);this.patch?this.patch!==a&&(this.patch.remove(this),this.patch=a,this.patch.add(this)):(this.patch=a,this.patch.add(this));this.isVisibleBuffer&&(this.parent.visibleEntities.update(this.node),this.isAnimating&&this.parent.animEntities.update(this.animNode))},addAnimating:function(){this.isAnimated&&
!this.isAnimating&&(this.isAnimating=!0,this.parent.addAnimating(this))},removeAnimating:function(){this.isAnimating&&(this.parent.removeAnimating(this),this.isAnimating=!1)},setPause:function(a){this._isPaused=a;this.texture&&this.texture.isAnimated&&(a?(this.removeAnimating(),this.isAnimated=!1):(this.addAnimating(),this.isAnimated=!0))},set isPaused(a){this.setPause(a)},get isPaused(){return this._isPaused},addToUpdate:function(){this.isUpdating||(this.parent.addUpdating(this),this.addAnimating(this),
this.isUpdating=!0)},removeFromUpdate:function(){this.isUpdating&&(this.parent.removeUpdating(this),this.isUpdating=!1)},onClick:function(){},onRelease:function(){},onPress:function(){},onDrag:function(){},onDragEnd:function(){},onOver:function(){},onOverExit:function(){},onDragMove:function(){},handleSignal_Brush:function(a){a===Brush.Event.LOADED&&(this.handleLoaded(),this.onBrushChange())},handleLoaded:function(){if(!this.isLoading&&!this.isLoaded&&(!this._brush||this._brush.isLoaded))if(!this._texture||
this._texture.isLoaded)this.updateStage(),this.load(),this._loadComponents(),this.ready(),this.isLoaded=!0},move:function(a,b){this.x===a&&this.y===b||(this.x=a,this.y=b,this.drawX=a+this.drawOffsetX,this.drawY=b+this.drawOffsetY,this._brush&&(this.drawX+=this.offsetX,this.drawY+=this.offsetY),this.parent.updateGridPos(this),this.volume.move(this.drawX,this.drawY),this.updateDepth(),this.isNeedStage=this.isNeedDraw=!0)},moveSilently:function(a,b){this.x===a&&this.y===b||(this.x=a,this.y=b,this.drawX=
a+this.drawOffsetX,this.drawY=b+this.drawOffsetY,this._brush&&(this.drawX+=this.offsetX,this.drawY+=this.offsetY),this.volume.move(this.drawX,this.drawY),this.isNeedDraw=!0)},moveToGrid:function(a,b){this.x=a*Terrain.Cfg.tileWidth;this.y=b*Terrain.Cfg.tileHeight},forceMove:function(a,b){this.x=a;this.y=b;this.drawX=a+this.drawOffsetX;this.drawY=b+this.drawOffsetY;this.parent.updateGridPos(this);this.volume.move(this.drawX,this.drawY);this.updateDepth();this.isNeedDraw=!0},translate:function(a,b){this.move(this.x+
a,this.y+b)},setGridPos:function(a,b){this.gridX=a;this.gridY=b;this.updatePos();this.updateVolume()},setDepth:function(a){this.depthIndex=a;this.updateDepth();this.isNeedDraw=!0},setVisible:function(a){this._isVisible!==a&&(this._isVisible=a,!a&&this.parent.grid&&this.parent.grid.remove(this),a?this.isNeedDraw=!0:this.parent.isNeedRender=!0)},setVisibleBuffer:function(a){if(this.isVisibleBuffer!==a){if(a)this.parent.visibleEntities.push(this.node);else{var b=this.getActivePatch();b?(this.patch.remove(this),
b.add(this),a=!0):this.parent.visibleEntities.remove(this.node)}this.isVisibleBuffer=a}},set isVisible(a){this.setVisible(a)},get isVisible(){return this._isVisible},setSize:function(a,b){this.volume.resize(a,b);this.centerOffsetX=Math.floor(a/2);this.centerOffsetY=Math.floor(b/2)},getActivePatch:function(){var a=this.parent.patchMgr,b=a.getPatchAt(this.x+this.volume.sizeX,this.y);return b&&b.isVisible||(b=a.getPatchAt(this.x,this.y))&&b.isVisible||(b=a.getPatchAt(this.x,this.y+this.volume.sizeY))&&
b.isVisible?b:(b=a.getPatchAt(this.x+this.volume.sizeX,this.y+this.volume.sizeY))&&b.isVisible?b:null},set isDrawBounds(a){this._isDrawBounds!==a&&((this._isDrawBounds=a)?this.parent.addDrawBounds():this.parent.removeDrawBounds(),this.isNeedDraw=!0)},get isDrawBounds(){return this._isDrawBounds},setAngle:function(a){void 0!==a&&this.angle!==a&&(this.angle=mighty.Math.ToRadians(a),this._draw=this._draw===Entity.Geometry.prototype._draw_Composite?Entity.Geometry.prototype._draw_TransformComposite:Entity.Geometry.prototype._drawTransformed,
this.isInside=this._isInsideTranslated,this.isInsidePerPx=this._isInsidePerPxTranslated,this.isNeedDraw=!0)},rotate:function(a){void 0!==a&&this.angle!==a&&(this.angle=mighty.Math.ToRadians(a),this._draw=this._draw===Entity.Geometry.prototype._draw_Composite?Entity.Geometry.prototype._draw_TransformComposite:Entity.Geometry.prototype._drawTransformed,this.isInside=this._isInsideTranslated,this.isInsidePerPx=this._isInsidePerPxTranslated,this.isNeedDraw=!0)},setAngleRad:function(a){void 0!==a&&this.angle!==
a&&(this.angle=a,this._draw=this._draw===Entity.Geometry.prototype._draw_Composite?Entity.Geometry.prototype._draw_TransformComposite:Entity.Geometry.prototype._drawTransformed,this.isInside=this._isInsideTranslated,this.isInsidePerPx=this._isInsidePerPxTranslated,this.isNeedDraw=!0)},rotateRad:function(a){void 0!==a&&this.angle!==a&&(this.angle=a,this._draw=this._draw===Entity.Geometry.prototype._draw_Composite?Entity.Geometry.prototype._draw_TransformComposite:Entity.Geometry.prototype._drawTransformed,
this.isInside=this._isInsideTranslated,this.isInsidePerPx=this._isInsidePerPxTranslated,this.isNeedDraw=!0)},setScale:function(a,b){a||(a=1);this.scaleX===a&&this.scaleY===b||(b||(b=a),this.scaleX=a,this.scaleY=b,this.volume.scale(a,b),this._draw===Entity.Geometry.prototype._draw_Composite?this._draw=Entity.Geometry.prototype._draw_TransformComposite:this._draw!==Entity.Geometry.prototype._drawTransformed&&(this._draw=Entity.Geometry.prototype._drawTransformed),this.isNeedDraw=!0)},scale:function(a,
b){a||(a=1);this.scaleX===a&&this.scaleY===b||(b||(b=a),this.scaleX=a,this.scaleY=b,this.volume.scale(a,b),this._draw===Entity.Geometry.prototype._draw_Composite?this._draw=Entity.Geometry.prototype._draw_TransformComposite:this._draw!==Entity.Geometry.prototype._drawTransformed&&(this._draw=Entity.Geometry.prototype._drawTransformed),this.isNeedDraw=!0)},setMatrix:function(a){this.matrix=a;this._draw=this._drawMatrix;this.isNeedDraw=!0},isInside:function(a,b){return this.volume.vsBorderPoint(a,b)},
_isInsideTranslated:function(a,b){var c=this.x+this.centerOffsetX,d=this.y+this.centerOffsetY,e=a-c,f=b-d,c=e*Math.cos(-this.angle)-f*Math.sin(-this.angle)+c,d=f*Math.cos(-this.angle)+e*Math.sin(-this.angle)+d;return this.volume.vsBorderPoint(c,d)},isInsidePerPx:function(a,b){if(this.texture){var c=null,d=c=0,c=1===this.scaleX?a-this.drawX-this.offsetX:Math.floor((a-this.drawX-this.offsetX+this.volume.initSizeX/2*(this.scaleX-1))/this.scaleX),d=1===this.scaleY?b-this.drawY-this.offsetY:Math.floor((b-
this.drawY-this.offsetY+this.volume.initSizeY/2*(this.scaleY-1))/this.scaleY),c=this.texture.isAnimated?this.texture.getDataAt(c,d,this.currFrame):this.texture.getDataAt(c,d);return 50<=c[3]}},_isInsidePerPxTranslated:function(a,b){if(this.texture){var c=this.x+this.centerOffsetX,d=this.y+this.centerOffsetY,e=a-c,f=b-d,c=e*Math.cos(-this.angle)-f*Math.sin(-this.angle)+c,d=f*Math.cos(-this.angle)+e*Math.sin(-this.angle)+d,e=null,f=e=0,e=1===this.scaleX?c-this.drawX-this.offsetX:Math.floor((c-this.drawX-
this.offsetX+this.volume.initSizeX/2*(this.scaleX-1))/this.scaleX),f=1===this.scaleY?d-this.drawY-this.offsetY:Math.floor((d-this.drawY-this.offsetY+this.volume.initSizeY/2*(this.scaleY-1))/this.scaleY),e=this.texture.isAnimated?this.texture.getDataAt(e,f,this.currFrame):this.texture.getDataAt(e,f);return 50<=e[3]}},updateStage:function(){var a=this.getStage();a&&(this.isNeedStage=!1,this.stage!==a&&(this.setStage(a),this.isNeedDraw=!0))},setStage:function(a){(this.stage=a)?((this.texture=this.stage.texture)||
this.volume.resize(0,0),this.stage.options&&(this.isFlip=this.stage.options.flip!==Resource.Flip.NONE)):this.texture=this._brush.texture;this._updateState_Animated()},_updateState_Animated:function(){this.texture&&this.texture.isAnimated?(this.resetFrame(),this.isAnimated=!0,this._isPaused||this.addAnimating()):0!==this.effect?this.addAnimating():(this.isAnimated=!1,this.removeAnimating())},setFrame:function(a){this.isAnimated&&(this.currFrame=a%this.texture.totalFrames,this.isNeedDraw=!0)},getStage:function(){return this._brush?
this._brush.getStage(this):null},getMinDistance:function(a){var b=Math.abs(this.gridX-a.gridX),a=Math.abs(this.gridY-a.gridY);return Math.min(b,a)},getTopLeftX:function(){return this.x+this.drawOffsetX+this._brush.offsetX},getTopLeftY:function(){return this.y+this.drawOffsetY+this._brush.offsetY},getCenterX:function(){return this.x+this.centerOffsetX},getCenterY:function(){return this.y+this.centerOffsetY},getDistanceToEntity:function(a){return mighty.Math.Length2(this.x-a.x,this.y-a.y)},updateVolume:function(){this.volume.move(this.drawX,
this.drawY)},collide:function(a,b){switch(b){case 1:return this.volume.vsBorderAABB(a);case 2:return this.volume.vsSphere(a)}return!1},lookAt:function(a,b){return Math.atan2(a-this.getCenterX(),this.getCenterY()-b)},lookAtEntity:function(a){return this.lookAt(a.getCenterX(),a.getCenterY())},addFilter:function(a){null===this.filters?this.filters=[a]:this.filters.push(a);this.isNeedDraw=!0},removeFilter:function(a){for(var b=this.filters.length,c=0;c<b;c++)if(this.filters[c]===a){this.filters.splice(c,
1);break}0===b-1&&(this.filters=null);this.isNeedDraw=!0},removeAllFilters:function(){this.filters=null;this.isNeedDraw=!0},vsEntity:function(a){return this.volume.vsAABB(a.volume)},updateVolumeFromTex:function(){if(this._texture){var a=this._texture.width,b=this._texture.height;this.volume.reinit(0,0,a,b);this.volume.scale(this.scaleX,this.scaleY);this.centerOffsetX=Math.floor(a/2);this.centerOffsetY=Math.floor(b/2);this.updateVolume()}},flip:function(a){var b=Resource.Flip;a?a===b.NONE||a===b.HORIZONTAL?
this.flipType===b.NONE?this.flipType=b.HORIZONTAL:this.flipType===b.HORIZONTAL?this.flipType=b.NONE:this.flipType===b.VERTICAL&&(this.flipType=b.HORIZONTAL_VERTICAL):a===b.VERTICAL?this.flipType===b.NONE?this.flipType=b.VERTICAL:this.flipType===b.VERTICAL?this.flipType=b.NONE:this.flipType===b.HORIZONTAL&&(this.flipType=b.HORIZONTAL_VERTICAL):a===b.HORIZONTAL_VERTICAL&&(this.flipType===b.NONE?this.flipType=b.HORIZONTAL_VERTICAL:this.flipType===b.HORIZONTAL_VERTICAL&&(this.flipType=b.NONE)):this.flipType===
b.NONE?this.flipType=b.HORIZONTAL:this.flipType===b.HORIZONTAL?this.flipType=b.NONE:this.flipType===b.VERTICAL&&(this.flipType=b.NONE);this._texture&&(this._texture=this._texture.flip(this.flipType),this.isNeedDraw=!0)},setComposite:function(a){this.composite=a;this._draw===Entity.Geometry.prototype._drawTransformed?this._draw=Entity.Geometry.prototype._draw_TransformComposite:this._draw!==Entity.Geometry.prototype._draw_TransformComposite&&(this._draw=Entity.Geometry.prototype._draw_Composite);this.isNeedDraw=
!0},setAlpha:function(a){this.alpha=a;this._draw===Entity.Geometry.prototype._drawTransformed?this._draw=Entity.Geometry.prototype._draw_TransformComposite:this._draw!==Entity.Geometry.prototype._draw_TransformComposite&&(this._draw=Entity.Geometry.prototype._draw_Composite);this.isNeedDraw=!0},onBrushChange:mighty.EmptyFunc,setBrush:function(a){this._brush&&this._brush.unsubscribe(this);this._brush=a;this._brush||(this._brush=Palettes.Brush.getByName("error"));if(this._brush){this.offsetX=this._brush.drawOffsetX;
this.offsetY=this._brush.drawOffsetY;this.centerOffsetX=Math.floor(this._brush.width/2);this.centerOffsetY=Math.floor(this._brush.height/2);this.updateBrushOffset();this.volume=new mighty.Math.DrawAABB(0,0,this._brush.width,this._brush.height);this.calcDrawOffset();var b=this;this._brush.subscribe(this,function(a,d){b.handleSignal_Brush(a,d)});this._brush.isLoaded&&this.handleSignal_Brush(Brush.Event.LOADED,this._brush);this.forceMove(this.x,this.y)}},set brush(a){this.setBrush(a)},get brush(){return this._brush},
onTextureChange:mighty.EmptyFunc,setTexture:function(a){"string"===typeof a&&(a=mighty.GetTextureByName(a));if(this._brush)this._texture=a,this._updateState_Animated(),this.onTextureChange();else{this._texture&&this._texture.unsubscribe(this);this._texture=a;this._updateState_Animated();this.onTextureChange();var b=this;a.subscribe(this,function(a){a===Resource.Event.LOADED&&(b.updateVolumeFromTex(),b.handleLoaded(),b.isNeedDraw=!0)});a.isLoaded&&(b.updateVolumeFromTex(),b.handleLoaded(),b.isNeedDraw=
!0)}},set texture(a){this.setTexture(a)},get texture(){return this._texture},updateBrushOffset:mighty.EmptyFunc,x:0,y:0,drawX:0,drawY:0,prevDepth:NaN,depth:0,depthIndex:0,gridX:-1,gridY:-1,prevGridX:-1,prevGridY:-1,offsetX:0,offsetY:0,drawOffsetX:0,drawOffsetY:0,centerOffsetX:0,centerOffsetY:0,angle:0,scaleX:1,scaleY:1,matrix:null,alpha:1,composite:"source-over",gridSizeX:1,gridSizeY:1,node:null,animNode:null,updateNodeID:0,volumeType:Entity.VolumeType.AABB,volume:null,patch:null,_texture:null,_brush:null,
stage:null,isFlip:!1,flipType:0,template:null,_isVisible:!0,isVisibleBuffer:!1,isNeedUpdate:!0,isUpdating:!1,isUpdatePause:!1,isInterpolatePause:!1,isNeedDraw:!0,isNeedStage:!1,isNeedRemove:!1,_isDrawBounds:!1,currFrame:0,tAnim:0,isAnimated:!1,isAnimating:!1,isRandFrame:!1,_isPaused:!1,effect:0,useGrid:!0,isInputOver:!1,isPickable:!0,filters:null});
Entity.Text=Entity.Geometry.extend({init:function(){this.texture=new Resource.Texture;this.texture.width=this._fontSize;this.texture.height=this._fontSize},setText:function(a){this._text=a;a=this.texture.ctx;a.font=this._style+" "+this._fontSizePx+" "+this._font;a.fillStyle=this._color;var b=a.measureText(this._text);this.volume.reinit(0,0,b.width,1.15*this._fontSize);this.centerOffsetX=Math.floor(this.volume.sizeX/2);this.centerOffsetY=Math.floor(this.volume.sizeY/2);this.updateVolume();this.texture.width=
b.width;this.texture.height=1.15*this._fontSize;a.clearRect(0,0,this.volume.sizeX,this.volume.sizeY);a.font=this._style+" "+this._fontSizePx+" "+this._font;a.fillStyle=this._color;a.textBaseline="top";a.fillText(this._text,0,0);this.isOutline&&(a.lineWidth=this._outlineWidth,a.strokeStyle=this._outlineColor,a.strokeText(this._text,0,0));this.isNeedDraw=!0},setFont:function(a){this._font=a;this.setText(this._text)},setSize:function(a){this._fontSize=a;this._fontSizePx=a+"px";this.setText(this._text)},
setColor:function(a){this._color=a;this.setText(this._text)},setOutlineColor:function(a){this._outlineColor=a;this.isOutline=!0},setOutlineWidth:function(a){this._outlineWidth=a;this._isOutline&&this.setText(this._text)},setStyle:function(a){this._style=a;this.setText(this._text)},set text(a){this.setText(a)},get text(){return this._text},set font(a){this.setFont(a)},get font(){return this._font},set size(a){this.setSize(a)},get size(){return this._fontSize},set color(a){this.setColor(a)},get color(){return this._color},
set outlineColor(a){this.setOutlineColor(a)},get outlineColor(){return this._outlineColor},set outlineWidth(a){this.setOutlineWidth(a)},get outlineWidth(){return this._outlineWidth},set style(a){this.setStyle(a)},get style(){return this._style},set isOutline(a){this._isOutline!==a&&(this._isOutline=a,this.setText(this._text))},get isOutline(){return this._isOutline},_text:"",_font:"Arial",_fontSize:18,_fontSizePx:"18px",_color:"#000000",_outlineColor:"#ffffff",_outlineWidth:1,_style:"",_isOutline:!1});
Entity.Particle=Entity.Geometry.extend({load:function(){this._particles=[];this.preset={};this.reset();this.addToUpdate()},reset:function(){this.loadPreset(Entity.Particle.Presets.clean)},loadPreset:function(a){var b=Entity.Particle.Presets.clean,c;for(c in b)this.preset[c]=b[c];"string"===typeof a&&(a=Entity.Particle.Presets[a]);for(c in a)this.preset[c]=a[c];this.setMaxParticles(this.preset.maxParticles);this.additiveTexture=this.preset.additiveTexture;this.preset.startColor=this.preset.startColor||
{r:255,g:255,b:255,a:1};this.preset.startColorVar=this.preset.startColorVar||{r:0,g:0,b:0,a:0};this.preset.endColor=this.preset.endColor||{r:255,g:255,b:255,a:1};this.preset.endColorVar=this.preset.endColorVar||{r:0,g:0,b:0,a:0};this._numParticlesLive=this._tEmit=0;this.volume.reinit(0,0,this.preset.radius,this.preset.radius);this.move(this.x,this.y)},update:function(a){if(!this._isPaused){this._numToResize&&(this.setMaxParticles(this._numToResize),this._numToResize=0);if(this.preset.emissionRate){var b=
1/this.preset.emissionRate;for(this._tEmit+=a;this._numParticlesLive<this.maxParticles&&this._tEmit>b;)this._addParticle(),this._tEmit-=b}for(var c=null,d=0,e=0,f=this.preset.gravityX*a,g=this.preset.gravityY*a,h=0,i=0,b=this._numParticlesLive-1;0<=b;--b)if(c=this._particles[b],c.life-=a,0>=c.life)this._particles[b]=this._particles[this._numParticlesLive-1],this._particles[this._numParticlesLive-1]=c,this._numParticlesLive--;else{e=d=0;if(c.radialAccel||c.tangentialAccel)this._radial.x=c.x-this.x,
this._radial.y=c.y-this.y,this._radial.normalize(),h=-this._radial.y*c.tangentialAccel,i=this._radial.x*c.tangentialAccel,this._radial.x*=c.radialAccel,this._radial.y*=c.radialAccel,d+=(this._radial.x+h)*a,e+=(this._radial.y+i)*a;d+=f;e+=g;c.velocity_x+=d;c.velocity_y+=e;c.x+=c.velocity_x*a;c.y+=c.velocity_y*a;c.scale+=c.deltaScale*a;c.color.r+=c.deltaColor.r*a;c.color.g+=c.deltaColor.g*a;c.color.b+=c.deltaColor.b*a;c.color.a+=c.deltaColor.a*a}this.isNeedDraw=!0}},_drawGeometry:function(a){var b,
c;this.relativePosition?(b=Math.floor(this.drawX+mighty.camera.x),c=Math.floor(this.drawY+mighty.camera.y)):(b=Math.floor(mighty.camera.x),c=Math.floor(mighty.camera.y));a.save();a.translate(b,c);b=0;var d,e,f;c=null;a.globalCompositeOperation=this._additiveTexture?"lighter":"source-over";if(this.preset.enableTexture&&this.texture)if(this._additiveTexture)for(;b<this._numParticlesLive;b++){c=this._particles[b];d=c.color;e=this.texture.width;f=this.texture.height;this._additiveCtx.clearRect(0,0,e,
f);this._additiveCtx.globalAlpha=d.a;this._additiveCtx.drawImage(this.texture.image,0,0);this._additiveCtx.globalCompositeOperation="source-atop";this._additiveCtx.fillStyle="rgba("+Math.floor(d.r)+","+Math.floor(d.g)+","+Math.floor(d.b)+","+d.a+")";this._additiveCtx.fillRect(0,0,e,f);d=e*c.scale;var g=f*c.scale;this._additiveCtx.globalCompositeOperation="source-over";this._additiveCtx.globalAlpha=1;a.drawImage(this._additiveCanvas,0,0,e,f,c.x,c.y,d,g)}else for(;b<this._numParticlesLive;b++)c=this._particles[b],
this.texture.draw(a,c.x,c.y);else{e=2*Math.PI;for(f=0;b<this._numParticlesLive;b++)c=this._particles[b],f=c.radius*c.scale,d=c.color,a.fillStyle="rgba("+Math.floor(d.r)+","+Math.floor(d.g)+","+Math.floor(d.b)+","+d.a+")",a.beginPath(),a.arc(c.x+f,c.y+f,f,0,e,!0),a.closePath(),a.fill()}a.restore()},_addParticle:function(){var a=this.preset,b=a.speed+Math.random()*2*a.speedVar-a.speedVar,c=mighty.Math.ToRadians(a.angleVar),d=mighty.Math.ToRadians(a.angle)+Math.random()*2*c-c,c=this._particles[this._numParticlesLive];
this.relativePosition?(c.x=Math.random()*2*a.xVar-a.xVar,c.y=Math.random()*2*a.yVar-a.yVar):(c.x=this.x+Math.random()*2*a.xVar-a.xVar,c.y=this.y+Math.random()*2*a.yVar-a.yVar);c.velocity_x=b*Math.cos(d);c.velocity_y=-b*Math.sin(d);c.life=Math.max(a.life+Math.random()*2*a.lifeVar-a.lifeVar,a.life);c.radialAccel=this.preset.radialAccel+(Math.random()*2*this.preset.radialAccelVar-this.preset.radialAccelVar);c.tangentialAccel=this.preset.tangentialAccel+(Math.random()*2*this.preset.tangentialAccelVar-
this.preset.tangentialAccelVar);c.color.r=a.startColor.r+(Math.random()*2*a.startColorVar.r-a.startColorVar.r);c.color.g=a.startColor.g+(Math.random()*2*a.startColorVar.g-a.startColorVar.g);c.color.b=a.startColor.b+(Math.random()*2*a.startColorVar.b-a.startColorVar.b);c.color.a=a.startColor.a+(Math.random()*2*a.startColorVar.a-a.startColorVar.a);this._tmpEndColor.r=a.endColor.r+(Math.random()*2*a.endColorVar.r-a.endColorVar.r);this._tmpEndColor.g=a.endColor.g+(Math.random()*2*a.endColorVar.g-a.endColorVar.g);
this._tmpEndColor.b=a.endColor.b+(Math.random()*2*a.endColorVar.b-a.endColorVar.b);this._tmpEndColor.a=a.endColor.a+(Math.random()*2*a.endColorVar.a-a.endColorVar.a);c.deltaColor.r=(this._tmpEndColor.r-c.color.r)/c.life;c.deltaColor.g=(this._tmpEndColor.g-c.color.g)/c.life;c.deltaColor.b=(this._tmpEndColor.b-c.color.b)/c.life;c.deltaColor.a=(this._tmpEndColor.a-c.color.a)/c.life;c.radius=Math.floor(a.radius+(Math.random()*2*a.radiusVar-a.radiusVar));0>c.radius&&(c.radius=0);a=this.preset.startScale+
(Math.random()*2*this.preset.startScaleVar-this.preset.startScaleVar);b=this.preset.endScale+(Math.random()*2*this.preset.endScaleVar-this.preset.endScaleVar);0>a&&(a=0);0>b&&(b=0);c.scale=a;c.deltaScale=(b-a)/c.life;this._numParticlesLive++},play:function(){this.isPaused=!1},pause:function(){this.isPaused=!0},setMaxParticles:function(a){this._particles.length=a;if(a>this._numParticlesLive)for(var b=Entity.Particle.Item,c=this._numParticlesLive,d=c+(a-this._numParticlesLive);c<d;c++)this._particles[c]=
new b;this.preset.maxParticles=a;this._numParticlesLive>a&&(this._numParticlesLive=a)},set maxParticles(a){a!==this._numToResize&&(this._isPaused?this.setMaxParticles(a):this._numToResize=a)},get maxParticles(){return this._numToResize?this._numToResize:this.preset.maxParticles},get numParticlesLive(){return this._numParticlesLive},set additiveTexture(a){a&&!this._additiveCanvas&&(this._additiveCanvas=document.createElement("canvas"),this._additiveCanvas.width=32,this._additiveCanvas.height=32,this._additiveCtx=
this._additiveCanvas.getContext("2d"));this._additiveTexture=a},get additiveTexture(){return this._additiveTexture},_numToResize:0,_numParticlesLive:0,_particles:null,_tEmit:0,_additiveTexture:!1,_additiveCanvas:null,_additiveCtx:null,_tmpEndColor:{r:0,g:0,b:0},_radial:new mighty.Math.Vector2(0,0),_tangential:{x:0,y:0},preset:null,relativePosition:!1});Entity.Particle.Presets={};
Entity.Particle.Presets.clean={maxParticles:80,emissionRate:60,life:1,lifeVar:0.5,xVar:0,yVar:0,speed:30,speedVar:10,angle:90,angleVar:360,gravityX:0,gravityY:0,radialAccel:0,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,radius:10,radiusVar:2,startScale:1,startScaleVar:0,endScale:1,endScaleVar:0,additiveTexture:!0,enableTexture:!1,endColor:{r:255,g:255,b:255,a:0}};
Entity.Particle.Presets.fire={maxParticles:90,emissionRate:75,life:1,lifeVar:0.5,xVar:0,yVar:0,speed:15,speedVar:5,angle:90,angleVar:360,gravityX:0,gravityY:-200,radialAccel:0,radialAccelVar:0,tangentialAccel:0,tangentialAccelVar:0,radius:12,radiusVar:2,additiveTexture:!0,enableTexture:!1,startColor:{r:255,g:50,b:0,a:1},startColorVar:{r:0,g:0,b:0,a:0},endColor:{r:0,g:0,b:0,a:0}};
Entity.Particle.Presets.fountain={maxParticles:400,emissionRate:100,life:2,lifeVar:1,speed:225,angleVar:20,gravityY:200,startColor:{r:28,g:92,b:180,a:1},endColor:{r:255,g:255,b:255,a:0},additiveTexture:!1};Entity.Particle.Presets.raindrops={maxParticles:250,emissionRate:250,life:1,lifeVar:0.5,x:0,y:0,xVar:1440,yVar:700,speed:-46,speedVar:10,angle:90,angleVar:24,gravityY:76,startColor:{r:202,g:232,b:255,a:1},endColor:{r:134,g:134,b:255,a:0},radius:14,radiusVar:2,startScale:1,startScaleVar:0.5,additiveTexture:!1};
Entity.Particle.Item=function(){this.life=this.angle=this.velocity_y=this.velocity_x=this.y=this.x=0;this.radius=14;this.scale=1;this.deltaScale=0;this.color={r:0,g:0,b:0};this.deltaColor={r:0,g:0,a:0};this.tangentialAccel=this.radialAccel=this.gravityY=this.gravityX=0};
Cursor.Manager=Plugin.extend({init:function(){this.volume=new mighty.Math.AABB(0,0,0,0);this.priority=Priority.LOW-1E4},initCfg:function(){this.cfg.halfStepSizeX=Math.floor(this.cfg.stepSizeX/2);this.cfg.halfStepSizeY=Math.floor(this.cfg.stepSizeY/2)},install:function(){this.patchMgr=this.scene.patchMgr;var a=this;SubscribeChannel(this,"Engine",function(b,c){a.handleSignal_Engine(b,c)});this.chn_input=SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)},Priority.HIGH);SubscribeChannel(this,
"Scene.OUT",function(b,c){a.handleSignal_Scene(b,c)})},load:function(){this.invalidFilter=new Material.Color;this.invalidFilter.setRGBA(255,100,100,210)},unload:function(){},update:function(){this.prevX=this.x;this.prevY=this.y},updatePos:function(a,b){var c=Terrain.Cfg,d=mighty.camera;this.screenX=a-d.x;this.screenY=b-d.y;var d=this.screenX,e=this.screenY;this.prevStepX=this.stepX;this.prevStepY=this.stepY;var f=1,g=1;this.isSnapping&&(f=this.cfg.stepSizeX,g=this.cfg.stepSizeY);switch(c.type){case Terrain.Type.TOP_DOWN:this.stepX=
Math.floor(d/f);this.stepY=Math.floor(e/g);break;case Terrain.Type.ISOMETRIC:this.isSnapping?(this.stepX=Math.round(e/g-d/f),this.stepY=Math.round(d/f+e/g)):(this.stepX=Math.floor(d/f),this.stepY=Math.floor(e/g))}this.prevGridX=this.gridX;this.prevGridY=this.gridY;switch(c.type){case Terrain.Type.TOP_DOWN:this.gridX=Math.floor(d/c.grid.width);this.gridY=Math.floor(e/c.grid.height);break;case Terrain.Type.ISOMETRIC:f=c.grid.width,g=c.grid.height,this.gridX=Math.round(e/g-d/f),this.gridY=Math.round(d/
f+e/g)}g=f=1;this.isSnapping&&(f=this.cfg.stepSizeX,g=this.cfg.stepSizeY);this.prevX=this.x;this.prevY=this.y;switch(c.type){case Terrain.Type.TOP_DOWN:this.x=this.stepX*f;this.y=this.stepY*g;break;case Terrain.Type.ISOMETRIC:this.isSnapping?(this.x=(this.stepY-this.stepX)*Math.floor(this.cfg.halfStepSizeX),this.y=(this.stepY+this.stepX)*Math.floor(this.cfg.halfStepSizeY)):(this.x=this.stepX*f,this.y=this.stepY*g)}this.entity&&this.entity.move(this.x,this.y);this.drawX=this.x+this.drawOffsetX;this.drawY=
this.y+this.drawOffsetY;this.volume.move(this.drawX,this.drawY);this.isVisible=!1;this.patchMgr.level&&this.patchMgr.getPatchFromGridPos(this.gridX,this.gridY)&&(this.isVisible=!0)},handleSignal_Engine:function(a,b){switch(a){case Engine.Event.CAMERA:this.camera=b}},handleSignal_Input:function(a,b){if(mighty.camera)switch(a){case Input.Event.MOVED:case Input.Event.INPUT_DOWN:case Input.Event.CLICKED:this.handleInput_Move(b.x,b.y);break;case Input.Event.KEY_DOWN:b.keyCode===Input.Key.SHIFT&&(this.isSnapping=
!1);break;case Input.Event.KEY_UP:b.keyCode===Input.Key.SHIFT&&(this.isSnapping=!0)}},handleInput_Move:function(a,b){var c=mighty.camera,a=Math.floor(a*c.zoom),b=Math.floor(b*c.zoom);this.isDragActive&&(this.isDrag=!0,c.drag(a,b));this.updatePos(a,b)},handleMouseDown:function(a,b,c){var d=mighty.camera,b=Math.floor(b*d.zoom),c=Math.floor(c*d.zoom);a===Input.Key.BUTTON_LEFT&&(this.isDragActive=!0,this.clear(),d.drag(b,c))},handleMouseClick:function(a){a===Input.Key.BUTTON_LEFT&&(this.isDrag=this.isDragActive=
!1,mighty.camera.endDrag())},handleSignal_Scene:function(a){switch(a){case Scene.Event.PRE_SAVE:return this.doPreSave(),!0;case Scene.Event.POST_SAVE:return this.doPostSave(),!0}return!1},doPreSave:function(){this.usePreSave&&(this.entity&&this.prevIsSaved)&&(this.entity.depthIndex=this.prevDepthIndex,this.entity.isSaved=this.prevIsSaved,this.entity.move(this.entityPrevX,this.entityPrevY))},doPostSave:function(){this.usePreSave&&(this.entity&&this.prevIsSaved)&&(this.entity.depthIndex=6E3,this.entity.isSaved=
!1,this.entity.move(this.x,this.y))},setInvalid:function(a){this.isInvalid!==a&&((this.isInvalid=a)?this.entity.addFilter(this.invalidFilter):this.entity.removeFilter(this.invalidFilter))},setEntity:function(a){this.entity&&this.entity!==a&&(this.entity.setDepth(this.prevDepthIndex),this.entity.isSaved=this.prevIsSaved);null===a&&this.isInvalid&&this.entity.removeFilter(this.invalidFilter);(this.entity=a)?(this.prevIsSaved=this.entity.isSaved,this.prevDepthIndex=this.entity.depthIndex,this.entity.depthIndex=
6E3,this.entity.isSaved=!1,this.entityPrevX=this.entity.x,this.entityPrevY=this.entity.y,this.entity.move(this.x,this.y),this.isInvalid&&this.entity.addFilter(this.invalidFilter)):this.offsetY=this.offsetX=0},getCenterX:function(){return this.x-this.offsetX},getCenterY:function(){return this.y-this.offsetY},isChanged:function(){return this.x!==this.prevX||this.y!==this.prevY?!0:!1},cfg:null,camera:null,patchMgr:null,x:0,y:0,prevX:0,prevY:0,screenX:0,screenY:0,offsetX:0,offsetY:0,drawOffsetX:0,drawOffsetY:0,
gridX:0,gridY:0,prevGridX:0,prevGridY:0,stepX:0,stepY:0,prevStepX:0,prevStepY:0,drawX:0,drawY:0,entity:null,entityPrevX:0,entityPrevY:0,prevDepthIndex:0,prevIsSaved:0,usePreSave:!1,isShow:!1,isVisible:!1,isInvalid:!1,isDragActive:!1,isDrag:!1,isSnapping:!0,chn_input:null});
Terrain.Loader=new function(){this.convertToBinary=function(a){var b=new ByteBuffer(1648);b.writeInt(a.level.sizeX);b.writeInt(a.level.sizeY);b.writeShort(a.basicBrush.id);for(var c=a.data.length,d=0;d<c;++d){var e=a.data[d];b.writeByte(e.numLayers);for(var f=0;f<e.numLayers;++f){var g=e.layers[f];"undefined"===typeof g?b.writeShort(0):g.brush.id===a.basicBrush.id?b.writeShort(0):b.writeShort(g.brush.id)}}return b.getData()};this.convertToJSON=function(a){var b=Entity.plugin.instance;if(b){var c=
a.level,d=c.terrain.sizeX*c.terrain.sizeY,e={};e.sizeX=c.terrain.sizeX;e.sizeY=c.terrain.sizeY;e.basicBrushID=a.clearEntity.id;e.data=Array(d);for(a=0;a<d;++a)e.data[a]=b[a].template.id;return e}}};
Terrain.Selector=function(a,b,c,d){this.init=function(a,b,c,d){switch(Terrain.Cfg.type){case Terrain.Type.TOP_DOWN:this.update=this._updateTopDown;break;case Terrain.Type.ISOMETRIC:this.update=this._updateIsometric}void 0!==a&&this.setBounds(a,b,c,d)};this.next=function(){if(this.gridX>=this.endGridX)return!1;this.gridX++;if(this.gridX>=this.endGridX&&(this.gridX=this.startGridX,this.gridY++,this.gridY>=this.endGridY))return this.gridY=this.endGridY,!1;this.update();return!0};this.prev=function(){if(this.gridX<
this.startGridX)return!1;this.gridX--;if(this.gridX<this.startGridX&&(this.gridX=this.endGridX-1,this.gridY--,this.gridY<this.startGridY))return this.gridY=this.startGridY,!1;this.update();return!0};this.reset=function(){this.gridX=this.startGridX;this.gridY=this.startGridY;this.update()};this.reverse=function(){this.gridX=this.endGridX-1;this.gridY=this.endGridY-1;this.update()};this.setBounds=function(a,b,c,d){0>a&&(a=0);0>b&&(b=0);0>c&&(c=0);0>d&&(d=0);a>this.cfg.numTilesX&&(a=this.cfg.numTilesX);
b>this.cfg.numTilesY&&(b=this.cfg.numTilesY);c>this.cfg.numTilesX&&(c=this.cfg.numTilesX);d>this.cfg.numTilesY&&(d=this.cfg.numTilesY);this.startGridX=a;this.startGridY=b;this.endGridX=c;this.endGridY=d;this.gridX=a;this.gridY=b;this.update();this.numTiles=(c-a)*(d-b)};this.setGridPos=function(a,b){this.gridX=a;this.gridY=b;this.update()};this.update=null;this._updateTopDown=function(){this.x=this.gridX*this.cfg.tileWidth;this.y=this.gridY*this.cfg.tileHeight};this._updateIsometric=function(){};this.cfg=
Terrain.Cfg;this.numTiles=this.endGridY=this.endGridX=this.startGridY=this.startGridX=this.gridY=this.gridX=this.y=this.x=0;this.init(a,b,c,d)};
Terrain.Manager=Plugin.extend({init:function(){this.priority=Priority.VERY_HIGH+101;this.typeToUpdate=[]},initCfg:function(){this.cfg.halfTileWidth=this.cfg.tileWidth/2;this.cfg.halfTileHeight=this.cfg.tileHeight/2;var a=this.cfg.grid;a.halfWidth=a.width/2;a.halfHeight=a.height/2;gParams.editor&&(this.cfg.showDebug=!0)},install:function(){this.patchMgr=this.scene.patchMgr;this.entityMgr=this.scene.entityMgr;var a=this;this.chn_terrain=SubscribeChannel(this,"Terrain.IN",function(b,c){return a.handleSignal_Terrain(b,
c)})},unload:function(){this.level=null;this.typeToUpdate=[];this.numTypeUpdates=0},prepareTerrain:function(a){var b=Palettes.Entity;a?(this.level.terrain=a,this.level.numTilesX=a.sizeX,this.level.numTilesY=a.sizeY,this.clearEntity=b.getByID(a.basicBrushID)):(this.clearEntity=b.getByName("null"),0<this.level.bgEntity?(this.clearEntity=b.getByID(this.level.bgEntity),this.clearEntity||(this.clearEntity=b.getByName("null"))):this.level.texture&&(this.clearEntity=new Entity.Geometry({texture:this.level.texture}),
Entity.plugin.add(this.clearEntity)));this.create()},create:function(){switch(this.cfg.type){case Terrain.Type.TOP_DOWN:this.cfg.width=this.level.numTilesX*this.cfg.tileWidth;this.cfg.height=this.level.numTilesY*this.cfg.tileHeight;this.cfg.volume=new mighty.Math.DrawAABB(0,0,this.cfg.width,this.cfg.height);break;case Terrain.Type.ISOMETRIC:this.cfg.width=this.level.numTilesX*this.cfg.halfTileWidth+this.level.numTilesY*this.cfg.halfTileWidth;this.cfg.height=this.level.numTilesY*this.cfg.halfTileHeight+
this.level.numTilesX*this.cfg.halfTileHeight;var a=-(this.cfg.width-this.level.numTilesY*this.cfg.halfTileWidth),b=-this.cfg.halfTileHeight;this.cfg.volume=new mighty.Math.DrawAABB(a,b,this.cfg.width+a,this.cfg.height+b)}a=this.level.numTilesX;b=this.level.numTilesY;this.level.terrain&&(a=this.level.terrain.sizeX,b=this.level.terrain.sizeY);this.level.sizeX=a;this.level.sizeY=b;this.cfg.numTiles=a*b;this.cfg.numTilesX=a;this.cfg.numTilesY=b;this.cfg.sizeX=a;this.cfg.sizeY=b;var c=null;if(this.level.terrain)c=
this.level.terrain.data;else var d=this.level.sizeX*this.level.sizeY,c=Array(d);var e=new Entity.InstanceGridBuffer;e.buffer=c;e.entityBuffer=[this.clearEntity];var f=0;this.clearEntity&&(f=this.clearEntity.id);for(var g=0;g<d;g++)c[g]=f;null===this.level.terrain&&(this.level.terrain={},this.level.terrain.sizeX=a,this.level.terrain.sizeY=b);this.level.terrain.data=c;Patch.plugin.create(this.level);SendSignal("Entity.IN",Entity.Event.LOAD_GRID_INSTANCE,e);this.level.numGridX=Terrain.Cfg.grid.sizeX;
this.level.numGridY=Terrain.Cfg.grid.sizeY;mighty.Coord.load()},resize:function(a){var b=this.level.terrain.data,c=null,c=a.gridX*a.gridY,d=a.gridX,e=a.gridY;if(this.level.terrain.sizeX*this.level.terrain.sizeY!==c){for(var c=Array(c),f=this.level.terrain.sizeX,g=this.level.terrain.sizeY,h=0,i=0,k=Math.min(d,f),j=Math.min(e,g),i=0;i<j;i++)for(h=0;h<k;h++)c[h+i*d]=b[h+i*f];if(d>f){for(i=0;i<j;i++)for(h=k;h<d;h++)c[h+i*d]=b[0];if(e>g)for(i=j;i<e;i++)for(h=0;h<d;h++)c[h+i*d]=b[0]}else if(e>g)for(i=j;i<
e;i++)for(h=0;h<k;h++)c[h+i*d]=b[0]}else c=b;a.bgEntity=Number(a.bgEntity);b=a.bgEntity;Palettes.Entity.getByID(b)||(b=Palettes.Entity.getByName("null").id,0===a.bgEntity&&(a.bgEntity=b));if(!this.clearEntity||this.clearEntity.id!==a.bgEntity)a=mighty.Macro.CreateEntityID(b),a.setVisible(!1),a.isSaved=!1,this.changeBgEntity(a,c);this.level.terrain.data=c;this.level.sizeX=d;this.level.sizeY=e;this.level.terrain.sizeX=d;this.level.terrain.sizeY=e;Entity.plugin.instance=c;Patch.plugin.updateView()},
changeBgEntity:function(a,b){if(!a||!b)mighty.Error.submit("Terrain.changeBgEntity","Invalid parameters.");else{var c=-1;this.clearEntity&&(c=this.clearEntity.id);for(var c=Entity.plugin.instanceEntities[c],d=b.length,e=0;e<d;e++)b[e]===c&&(b[e]=a);this.clearEntity=a.template;Entity.plugin.instanceEntities[this.clearEntity.id]=a}},update:function(){this.updateTypes(!1)},updateTypes:function(a){if(this.needTypeUpdate||a){for(a=0;a<this.numTypeUpdates;a++)this.updateType(this.typeToUpdate[a]);this.needTypeUpdate=
!1}},updateType:function(a){for(var b=this.level.numTilesX*this.level.numTilesY,c=0;c<b;++c){var d=this.data[c],e=d.getLayerByType(a);-1<e&&d.update(this,e)}},addTypeUpdate:function(a){for(var b=0;b<this.numTypeUpdates;b++)if(this.typeToUpdate[b]===a)return;this.typeToUpdate.push(a);this.numTypeUpdates++;this.needTypeUpdate=!0},brushTileAt:function(a,b,c){var d=0;void 0===a.fillType&&(a.fillType=0);switch(a.fillType){case Terrain.FillType.DEFAULT:d=b+c*this.cfg.numTilesX;this.data[d].setBrush(a,!1);
break;case Terrain.FillType.FLOOD:var e=b-1,d=c-1,f=b+1,g=c+1;0>e&&(e=0);0>d&&(d=0);f>this.cfg.numTilesX&&(f=this.cfg.numTilesX);g>this.cfg.numTilesY&&(g=this.cfg.numTilesY);for(var h=d;h<=g;++h)for(var i=e;i<=f;++i)d=i+h*this.cfg.numTilesX,b!==i||c!==h?this.data[d].setBrush(a,!0):this.data[d].setBrush(a,!1)}this.updateTypes(!0)},brushTiles:function(a,b,c,d,e){for(var f=!1;c<e;c++)for(var g=b;g<d;g++)this.data[g+c*this.cfg.numTilesX].setBrush(this,a)!==Terrain.StatusType.NO_CHANGES&&(f=!0);return f},
clearTile:function(a,b){this.data[a+b*this.cfg.numTilesX].clearNextLayer()},handleMouseMove:function(){(this.currGridX!==Cursor.plugin.gridX||this.currGridY!==Cursor.plugin.gridY)&&this.updateMode(Cursor.plugin.gridX,Cursor.plugin.gridY);this.currGridX=Cursor.plugin.gridX;this.currGridY=Cursor.plugin.gridY},handleSignal_Terrain:function(a,b){switch(a){case Terrain.Event.RESIZE:return this.resize(b),!0}return!1},isTileAvailable:function(a,b,c){return 0>=a||a>=this.cfg.numTilesX-1||0>=b||b>=this.cfg.numTilesY-
1?null:this.data[a+b*this.cfg.numTilesX].isAvailable(c)},getTileAt:function(a,b){return 0>a||a>=this.level.numTilesX||0>b||b>=this.level.numTilesY?null:this.data[a+b*this.level.numTilesX]},getTileWithTypeAt:function(a,b,c){if(0>a||a>=this.level.numTilesX||0>b||b>=this.level.numTilesY)return null;a=this.data[a+b*this.level.numTilesX];return a.isType(c)?a:null},getData:function(a){return a?Terrain.Loader.convertToBinary(this):Terrain.Loader.convertToJSON(this)},getPositionFromGrid:function(a,b){var c=
new mighty.Math.Vector2(0,0);switch(this.cfg.type){case Terrain.Type.TOP_DOWN:c.x=a*this.cfg.tileWidth,c.y=b*this.cfg.tileHeight}return c},camera:null,patchMgr:null,entityMgr:null,level:null,data:null,clearEntity:null,currGridX:-1,currGridY:-1,typeToUpdate:null,numTypeUpdates:0,needTypeUpdate:!1,chn_terrain:null});
Editor.Manager=Plugin.extend({install:function(){gParams.editor&&(this.cfg.useEditor=!0);var a=this;SubscribeChannel(this,"Editor",function(b,c){a.handleSignal(b,c)});this.prevStepSizeX=Cursor.Cfg.stepSizeX;this.prevStepSizeY=Cursor.Cfg.stepSizeY;this.useLayer(Entity.Layer.ENTITY)},handleSignal:function(a,b){switch(a){case Editor.Event.SET_LAYER:return this.useLayer(b),!0;case Editor.Event.USE_ITEM:return this.useItem(b),!0;case Editor.Event.USE_ITEM_ID:return this.useItemID(b),!0;case Editor.Event.SET_MODE:return this.setMode(b),
!0;case Editor.Event.GET_LAYER:return Entity.plugin.activeLayerID;case Editor.Event.GET_MODE:return this.currModule.mode}return!1},useModule:function(a){var b=mighty.GetModule("Entity","Editor-"+a);if(b!==this.currModule&&("TERRAIN"===a?(Cursor.Cfg.stepSizeX=Terrain.Cfg.tileWidth,Cursor.Cfg.stepSizeY=Terrain.Cfg.tileHeight):(Cursor.Cfg.stepSizeX=this.prevStepSizeX,Cursor.Cfg.stepSizeY=this.prevStepSizeY),this.cancelModule(),this.currModule=b))this.currModule.activate(),this.currModule.userMgr=this},
useLayer:function(a){if(this.cfg.useEditor){var b=mighty.Macro.GetStrEnum(Entity.Layer,a);void 0!==b&&(this.useModule(b),Entity.plugin.activeLayerID=a)}},cancelModule:function(){this.currModule&&this.currModule.deactivate();this.currModule=null},useItem:function(a){this.currModule&&this.currModule.useItem(a)},useItemID:function(a){this.currModule&&this.currModule.useItemID(a)},setMode:function(a){this.currModule&&this.currModule.setMode(a)},currModule:null,prevStepSizeX:0,prevStepSizeY:0});
mighty.CreateModule("Entity","Editor-TERRAIN",{activate:function(){var a=this;SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)});SubscribeChannel(this,"EntityInteract",function(b,c){a.handleSignal_EntityInteract(b,c)})},deactivate:function(){UnsubscribeChannel(this,"Input");UnsubscribeChannel(this,"EntityInteract");this.setMode(Editor.Mode.SELECT);this._overEntity&&(this._overEntity.isDrawBounds=!1)},setMode:function(a){if(this.mode!==a){switch(this.mode){case Editor.Mode.SELECT:this.clearMode_SELECT();
break;case Editor.Mode.ADD:this.clearMode_ADD();break;case Editor.Mode.MOVE:this.clearMode_MOVE();break;case Editor.Mode.REMOVE:this.clearMode_REMOVE()}this.mode=a;switch(this.mode){case Editor.Mode.ADD:this.setupMode_ADD();break;case Editor.Mode.MOVE:this.setupMode_MOVE();break;case Editor.Mode.REMOVE:this.setupMode_REMOVE()}}},clearMode_SELECT:function(){this.entity&&(this.entity.isDrawBounds=!1,this.entity=null)},clearMode_ADD:function(){this.entity&&this.entity.remove();this.entity=null;Cursor.plugin.setEntity(null)},
clearMode_MOVE:function(){this.entity&&(this.entity.move(this._tmpMoveX,this._tmpMoveY),this.entity=null,Cursor.plugin.setEntity(this.entity))},clearMode_REMOVE:function(){},setupMode_ADD:function(){this.entity&&(Cursor.plugin.setEntity(this.entity),this.updateMode_ADD())},setupMode_MOVE:function(){},setupMode_REMOVE:function(){},updateMode:function(){switch(this.mode){case Editor.Mode.ADD:this.updateMode_ADD();break;case Editor.Mode.MOVE:this.updateMode_MOVE();break;case Editor.Mode.REMOVE:this.updateMode_REMOVE()}},
updateMode_ADD:function(){this.checkIfAllowed()},updateMode_MOVE:function(){this.checkIfAllowed()},updateMode_REMOVE:function(){this.isAvailable=this.mgr.getFromPosPx(Cursor.plugin.screenX,Cursor.plugin.screenY)?!0:!1},checkIfAllowed:function(){if(this.entity&&this.userMgr.cfg.disallowDuplicates){Cursor.plugin.setInvalid(!1);var a=this.mgr.getFromPosEx(Cursor.plugin.screenX,Cursor.plugin.screenY,this.entity);a&&a.template===a.template&&(a.x===this.entity.x&&a.y===this.entity.y)&&Cursor.plugin.setInvalid(!0)}},
overMode:function(a){switch(this.mode){case Editor.Mode.SELECT:this.overMode_SELECT(a);break;case Editor.Mode.MOVE:this.overMode_SELECT(a);break;case Editor.Mode.REMOVE:this.overMode_SELECT(a)}},overMode_SELECT:function(a){a.isDrawBounds=!0;this.overEntity=a},doMode:function(){if(this.isAvailable)switch(this.mode){case Editor.Mode.SELECT:this.doMode_SELECT();break;case Editor.Mode.ADD:this.doMode_ADD();break;case Editor.Mode.MOVE:this.doMode_MOVE();break;case Editor.Mode.REMOVE:this.doMode_REMOVE()}},
doMode_SELECT:function(){!this.overEntity&&this.entity&&(this.entity.isDrawBounds=!1,this.entity=null)},doMode_ADD:function(){if(this.entity){var a=Cursor.plugin;if(!a.isInvalid){var b=Terrain.Cfg,c=Math.floor(a.x/b.tileWidth),a=Math.floor(a.y/b.tileHeight),b=c+a*b.numTilesX;console.log(b,c,a);Entity.plugin.setGridInstance(b,this.entity);this.updateMode_ADD()}}},doMode_MOVE:function(){this.entity?Cursor.plugin.isInvalid||(this.entity=null,Cursor.plugin.setEntity(null)):this.overEntity&&(this.entity=
this.overEntity,Cursor.plugin.setEntity(this.entity))},doMode_REMOVE:function(){this.overEntity&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.removeGridInstance():(this.overEntity.remove(),this.overEntity=null))},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.updateMode();break;case Input.Event.KEY_DOWN:this.handleKeyDown(b.keyCode);break;case Input.Event.CLICKED:this.doMode()}},handleSignal_EntityInteract:function(a,b){switch(a){case Entity.Event.OVER_ENTER:this.overMode(b);
break;case Entity.Event.OVER_EXIT:b&&this.overEntity!==b&&(b.isDrawBounds=!1);this.overEntity=b;break;case Entity.Event.CLICKED:if(this.entity===b)break;if(this.mode!==Editor.Mode.SELECT)break;this.entity&&(this.entity.isDrawBounds=!1);this.entity=b;this.entity.isDrawBounds=!0}},handleKeyDown:function(a){if(this.entity)switch(this.mode){case Editor.Mode.SELECT:this.keyDownMode_SELECT(a)}},keyDownMode_SELECT:function(a){switch(a){case Input.Key.ARROW_DOWN:this.entity.move(this.entity.x,this.entity.y+
1);break;case Input.Key.ARROW_UP:this.entity.move(this.entity.x,this.entity.y-1);break;case Input.Key.ARROW_LEFT:this.entity.move(this.entity.x-1,this.entity.y);break;case Input.Key.ARROW_RIGHT:this.entity.move(this.entity.x+1,this.entity.y)}},useItem:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(a);this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},useItemID:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(Palettes.Entity.getByID(a).name);
this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},entity:null,overEntity:null,mode:Editor.Mode.NONE,layer:Entity.Layer.ENTITY,isAvailable:!0,_overEntity:null,_tmpMoveX:0,_tmpMoveY:0});
mighty.CreateModule("Entity","Editor-ENTITY",{activate:function(){var a=this;SubscribeChannel(this,"Input",function(b,c){a.handleSignal_Input(b,c)});SubscribeChannel(this,"EntityInteract",function(b,c){a.handleSignal_EntityInteract(b,c)});this.mode=Editor.Mode.SELECT},deactivate:function(){UnsubscribeChannel(this,"Input");UnsubscribeChannel(this,"EntityInteract");this.setMode(Editor.Mode.SELECT);this.entity&&(this.entity.isDrawBounds=!1);this._overEntity&&(this._overEntity.isDrawBounds=!1)},setMode:function(a){if(this.mode!==
a){this.isAvailable=!0;switch(this.mode){case Editor.Mode.SELECT:this.clearMode_SELECT();break;case Editor.Mode.ADD:this.clearMode_ADD();break;case Editor.Mode.MOVE:this.clearMode_MOVE()}this.mode=a;switch(this.mode){case Editor.Mode.ADD:this.setupMode_ADD();break;case Editor.Mode.MOVE:this.setupMode_MOVE();break;case Editor.Mode.ROTATE:this.setupMode_ROTATE()}}},clearMode_SELECT:function(){this.entity&&(this.entity.isDrawBounds=!1,this.entity=null)},clearMode_ADD:function(){this.entity&&this.entity.remove();
this.entity=null;Cursor.plugin.setEntity(null)},clearMode_MOVE:function(){Cursor.plugin.usePreSave=!1;this.entity&&(this.entity.move(this._tmpMoveX,this._tmpMoveY),this.entity=null,Cursor.plugin.setEntity(this.entity))},setupMode_ADD:function(){this.entity&&(Cursor.plugin.setEntity(this.entity),this.updateMode_ADD())},setupMode_MOVE:function(){Cursor.plugin.usePreSave=!0},setupMode_ROTATE:function(){Cursor.plugin.usePreSave=!0},updateMode:function(a){switch(this.mode){case Editor.Mode.ADD:this.updateMode_ADD();
break;case Editor.Mode.MOVE:this.updateMode_MOVE();break;case Editor.Mode.ROTATE:this.updateMode_ROTATE(a);break;case Editor.Mode.REMOVE:this.updateMode_REMOVE()}},updateMode_ADD:function(){this.checkIfAllowed()},updateMode_MOVE:function(){this.checkIfAllowed()},updateMode_ROTATE:function(a){this.entity&&(a.alternativeEvent&&a.alternativeEvent.shiftKey)&&(console.log(a),a=this.entity.lookAt(a.x-mighty.camera.x,a.y-mighty.camera.y),Cursor.Cfg.angleStep&&(a=Math.floor(a/Cursor.Cfg.angleStep)*Cursor.Cfg.angleStep),
this.entity.setAngleRad(a))},updateMode_REMOVE:function(){this.isAvailable=this.mgr.getFromPosPx(Cursor.plugin.screenX,Cursor.plugin.screenY)?!0:!1},checkIfAllowed:function(){if(this.entity&&this.userMgr.cfg.disallowDuplicates){Cursor.plugin.setInvalid(!1);this.isAvailable=!0;var a=this.mgr.getFromPosEx(Cursor.plugin.screenX,Cursor.plugin.screenY,this.entity);a&&(a.template===a.template&&a.x===this.entity.x&&a.y===this.entity.y)&&(Cursor.plugin.setInvalid(!0),this.isAvailable=!1)}},overMode:function(a){switch(this.mode){case Editor.Mode.SELECT:this.overMode_SELECT(a);
break;case Editor.Mode.MOVE:this.overMode_SELECT(a);break;case Editor.Mode.ROTATE:this.overMode_SELECT(a);break;case Editor.Mode.REMOVE:this.overMode_SELECT(a)}},overMode_SELECT:function(a){a.isDrawBounds=!0;this.overEntity=a},doMode:function(){if(this.isAvailable)switch(this.mode){case Editor.Mode.SELECT:this.doMode_SELECT();break;case Editor.Mode.ADD:this.doMode_ADD();break;case Editor.Mode.MOVE:this.doMode_MOVE();break;case Editor.Mode.ROTATE:this.doMode_ROTATE();break;case Editor.Mode.REMOVE:this.doMode_REMOVE()}},
doMode_SELECT:function(){!this.overEntity&&this.entity&&(this.entity.isDrawBounds=!1,this.entity=null)},doMode_ADD:function(){this.entity&&!Cursor.plugin.isInvalid&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.setGridInstance():(this.entity=mighty.Macro.CreateEntity(this.entity.name),Cursor.plugin.setEntity(this.entity)),this.updateMode_ADD())},doMode_MOVE:function(){this.entity?Cursor.plugin.isInvalid||(this.entity=null,Cursor.plugin.setEntity(null)):this.overEntity&&(this.entity=
this.overEntity,Cursor.plugin.setEntity(this.entity))},doMode_ROTATE:function(){this.entity?this.entity=null:this.overEntity&&(this.entity=this.overEntity,this.rotateStartAngle=this.entity.angle)},doMode_REMOVE:function(){this.overEntity&&(Entity.plugin.activeLayerID===Entity.Layer.TERRAIN?Entity.plugin.removeGridInstance():(this.overEntity.remove(),this.overEntity=null))},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:this.updateMode(b);break;case Input.Event.KEY_DOWN:this.handleKeyDown(b.keyCode);
break;case Input.Event.CLICKED:this.doMode()}},handleSignal_EntityInteract:function(a,b){switch(a){case Entity.Event.OVER_ENTER:this.overMode(b);break;case Entity.Event.OVER_EXIT:this.entity!==b&&(b.isDrawBounds=!1);this.overEntity=null;break;case Entity.Event.CLICKED:if(this.entity===b)break;if(this.mode!==Editor.Mode.SELECT)break;this.entity&&(this.entity.isDrawBounds=!1);this.entity=b;this.entity.isDrawBounds=!0}},handleKeyDown:function(a){if(this.entity)switch(this.mode){case Editor.Mode.SELECT:this.keyDownMode_SELECT(a);
break;case Editor.Mode.MOVE:this.keyDownMode_SELECT(a);break;case Editor.Mode.ROTATE:this.keyDownMode_ROTATE(a)}},keyDownMode_SELECT:function(a){switch(a){case Input.Key.ARROW_DOWN:this.entity.move(this.entity.x,this.entity.y+1);break;case Input.Key.ARROW_UP:this.entity.move(this.entity.x,this.entity.y-1);break;case Input.Key.ARROW_LEFT:this.entity.move(this.entity.x-1,this.entity.y);break;case Input.Key.ARROW_RIGHT:this.entity.move(this.entity.x+1,this.entity.y)}},keyDownMode_ROTATE:function(a){switch(a){case Input.Key.ARROW_DOWN:this.entity.setAngleRad(0.01*
Math.round(100*this.entity.angle)+0.01);break;case Input.Key.ARROW_UP:this.entity.setAngleRad(0.01*Math.round(100*this.entity.angle)-0.01);break;case Input.Key.ARROW_LEFT:this.entity.setAngleRad(0.01*Math.round(100*this.entity.angle)+0.05);break;case Input.Key.ARROW_RIGHT:this.entity.setAngleRad(0.01*Math.round(100*this.entity.angle)-0.05);break;case 27:this.entity.setAngleRad(this.rotateStartAngle),this.entity=null}},useItem:function(a){this.entity&&this.entity.remove();this.entity=mighty.Macro.CreateEntity(a);
this.mode===Editor.Mode.ADD&&this.setupMode_ADD()},useItemID:function(a){this.entity&&this.entity.remove();var b=Palettes.Entity.getByID(a);null===b?mighty.Error.submit("EntityEditor.useItemID","No such item with id '"+a+"'"):(this.entity=mighty.Macro.CreateEntity(b.name),this.mode===Editor.Mode.ADD&&this.setupMode_ADD())},entity:null,overEntity:null,mode:-1,isAvailable:!0,_overEntity:null,_tmpMoveX:0,_tmpMoveY:0});UI.Manager=Plugin.extend({install:function(){}});
Entity.Camera=Entity.Basic.extend({init:function(a){this.cfg=Camera.Cfg;this.terrainCfg=Terrain.Cfg;this.id=a;this.name="Camera";this.viewFrustum=new mighty.Math.AABB(0,0,0,0);var b=this;this.chn_unique=CreateChannel("Camera");SubscribeChannel(this,"Engine",function(a,d){return b.handleSignal_Engine(a,d)},Priority.HIGH);SubscribeChannel(this,"Input",function(a,d){return b.handleSignal_Input(a,d)},Priority.HIGH);void 0!==gParams.editor&&(this.isEditor=!0)},load:function(){this.resetView();this.chn_unique.signal(Camera.Event.MOVED,
this);var a=this.cfg.position;if(a.type===Camera.Position.FOLLOW)if(this.isEditor)this.cfg.position.type=Camera.Position.DEFAULT;else{a=Ask("Entity.IN",Entity.Event.GET_BY_TYPE,a.gameObject);if(!a)return;this.setFollowEntity(a);this.chn_unique.signal(Camera.Event.MOVED,this)}this.isEditor&&(this.cfg.position.isDrag=!0,this.cfg.position.ignoreBorder=!0)},update:function(){if(this.followEntity&&(this.x=-(this.followEntity.getCenterX()+this.followOffsetX+this.cfg.position.offsetX),this.y=-(this.followEntity.getCenterY()+
this.followOffsetY+this.cfg.position.offsetY),this.x!==this.prevFollowX||this.y!==this.prevFollowY)){if(!this.cfg.isIgnoreBorder){var a=this.terrainCfg.volume;-this.x<a.minX?this.x=-a.minX:-this.x+this.width>a.maxX&&(this.x=this.width-a.maxX);-this.y<a.minY?this.y=-a.minY:-this.y+this.height>a.maxY&&(this.y=this.height-a.maxY)}this.viewFrustum.move(-Math.floor(this.x),-Math.floor(this.y));this.chn_unique.signal(Camera.Event.MOVED,this);this.prevFollowX=this.x;this.prevFollowY=this.y}},updateViewFrustum:function(){this.viewFrustum.resize(this.width,
this.height);this.viewFrustum.move(-this.x,-this.y)},updateView:function(){if(this.cfg.zoom.useAutoZoom){var a=1/mighty.engine.width*Terrain.Cfg.width,b=1/mighty.engine.height*Terrain.Cfg.height,c=a;b>a&&(c=b);this.zoom=c;this.defaultZoom=this.zoomValue=1/c}this.width=Math.ceil(mighty.engine.width*this.zoom);this.height=Math.ceil(mighty.engine.height*this.zoom);this.updateOffset();this.updateViewFrustum();mighty.engine.setZoom(this.zoomValue)},updateOffset:function(){var a=this.offsetX,b=this.offsetY,
c=this.terrainCfg.volume;switch(this.cfg.position.type){case Camera.Position.DEFAULT:this.offsetX=-c.minX;this.offsetY=-c.minY;break;case Camera.Position.CENTER:this.offsetX=Math.floor((this.width-Terrain.Cfg.width)/2)-c.minX;this.offsetY=Math.floor((this.height-Terrain.Cfg.height)/2)-c.minY;break;case Camera.Position.H_CENTER:this.offsetX=Math.floor((this.width-Terrain.Cfg.width)/2)-c.minX;this.offsetY=-c.minY;break;case Camera.Position.V_CENTER:this.offsetX=-c.minX;this.offsetY=Math.floor((this.height-
Terrain.Cfg.height)/2)-c.minY;break;case Camera.Position.FOLLOW:this.followOffsetX=-Math.floor(this.width/2),this.followOffsetY=-Math.floor(this.height/2)}a!==this.offsetX&&(this.x+=this.offsetX-a);b!==this.offsetY&&(this.y+=this.offsetY-b)},resetView:function(){var a=1;this.cfg.zoom.active&&(a=this.cfg.zoom.defaultValue,a<this.cfg.zoom.min&&(a=this.cfg.zoom.min),a>this.cfg.zoom.max&&(a=this.cfg.zoom.max));this.zoom=1/a;this.zoomValue=a;this.x=this.offsetX;this.y=this.offsetY;this.updateView()},drag:function(a,
b){this.isPrepareDrag&&(this.isPrepareDrag=!1,this.isDrag=!0);if(this.isDrag){var c=a-this.dragX,d=b-this.dragY;if(void 0===gParams.editor&&!this.cfg.position.ignoreBorder){var e=this.terrainCfg.volume;if(this.terrainCfg.width>this.width){var f=-(this.x+c),g=f+this.width;f<e.minX?c=-(e.minX+this.x):g>e.maxX&&(c=-(e.maxX-(-this.x+this.width)))}else c=0;this.terrainCfg.height>this.height?(f=-(this.y+d),g=f+this.height,f<e.minY?d=-(e.minY+this.y):g>e.maxY&&(d=-(e.maxY-(-this.y+this.height)))):d=0}this.x+=
c;this.y+=d;this.viewFrustum.translate(-c,-d);this.chn_unique.signal(Camera.Event.MOVED,this)}else this.isPrepareDrag=!0;this.dragX=a;this.dragY=b},handleSignal_Input:function(a,b){switch(a){case Input.Event.MOVED:if(this.followEntity)return;if(this.cfg.position.isDrag&&(this.isPrepareDrag||this.isDrag))return this.drag(b.x,b.y),!0;break;case Input.Event.INPUT_DOWN:if(this.followEntity)return;this.cfg.position.isDrag&&b.keyCode===Input.Key.BUTTON_LEFT&&this.drag(b.x,b.y);break;case Input.Event.CLICKED:case Input.Event.INPUT_UP:if(this.followEntity)return;
this.isPrepareDrag=!1;if(this.isDrag)return this.isDrag=!1,!0}return!1},handleSignal_Engine:function(a){switch(a){case Engine.Event.RESIZE:this.updateView()}},handleFollowEntity:function(a){a===Entity.Event.REMOVED&&(this.followEntity=null,this.chn_Entity=SubscribeChannel(this,"Entity.OUT",function(a,c){return self.handleSignal_Entity(a,c)}))},move:function(a,b){this.x=-a;this.y=-b;this.updateViewFrustum();this.chn_unique.signal(Camera.Event.MOVED,this)},moveToGridPos:function(a,b){var c=mighty.Coord.toWorld({x:a,
y:b});this.x=c.x;this.y=c.y;this.update();this.updateViewFrustum();this.chn_unique.signal(Camera.Event.MOVED,this)},resetZoom:function(){this.zoomValue=this.zoom=this.defaultZoom;mighty.engine.setZoom(this.zoomValue)},zoomIn:function(){this.zoomValue!==this.maxZoom&&(this.zoomValue+=this.zoomStep,this.zoomValue=parseFloat(this.zoomValue.toFixed(2)),this.zoomValue>this.maxZoom&&(this.zoomValue=this.maxZoom),this.zoom=1/this.zoomValue,this.zoom=parseFloat(this.zoom.toFixed(2)),mighty.engine.setZoom(this.zoomValue,
!0))},zoomOut:function(){this.zoomValue!=this.minZoom&&(this.zoomValue-=this.zoomStep,this.zoomValue=parseFloat(this.zoomValue.toFixed(2)),this.zoomValue<this.minZoom&&(this.zoomValue=this.minZoom),this.zoom=1/this.zoomValue,this.zoom=parseFloat(this.zoom.toFixed(2)),mighty.engine.setZoom(this.zoomValue))},setZoom:function(a){a!==this.zoomValue&&(this.zoom=1/a,this.zoomValue=a,this.updateView())},setFollowEntity:function(a){this.followEntity&&this.followEntity.unsubscribe(this);a?(this.followEntity=
a,this.prevFollowY=this.prevFollowX=0,this.cfg.position.type=Camera.Position.FOLLOW,this.updateOffset(),a.subscribe(this,function(a,c){self.handleFollowEntity(a,c)})):(this.followEntity=null,this.cfg.position.type=Camera.Position.DEFAULT,this.updateOffset())},cfg:null,terrainCfg:null,x:0,y:0,offsetX:0,offsetY:0,width:0,height:0,viewFrustum:null,chn_Engine:null,chn_Entity:null,chn_Camera:null,isDrag:!1,isPrepareDrag:!1,zoom:1,zoomValue:1,minZoom:0.6,maxZoom:2,defaultZoom:1,zoomStep:0.1,followEntity:null,
prevFollowX:0,prevFollowY:0,followOffsetX:0,followOffsetY:0,isEditor:!1});Map.Manager=Plugin.extend({loadPalette:function(){this._super();for(var a,b=this.scope.palette,c=b.length,d=0;d<c;d++)a=b[d],this.palette.getByID(a.id).level=a},token:"505d6e6c485121616f2b7b5562"});
i18n.Manager=Plugin.extend({init:function(){this.chn_i18n=CreateChannel("i18n.OUT")},install:function(){var a=this;SubscribeChannel(this,"i18n.IN",function(b,c){return a.handleSignal_i18n(b,c)});this.setLang(this.cfg.defaultLang)},loadPaletteAsTemplate:function(){for(var a=0,b={},c=Object.keys(this.scope.Lang),d=c.length,a=0;a<d;a++)b[c[a]]={};for(var e=this.scope.palette,f=e.length,g=null,h="",a=0;a<f;a++)for(var g=e[a],i=0;i<d;i++)h=g[c[i]],h.length&&(b[c[i]][g.key]=h);this.palette=b;Palettes.I18n=
b;delete i18n.palette},processHTML:function(a){if(!(a instanceof HTMLElement)){var b=document.createElement("div");b.innerHTML=a;a=b}for(var b=[],c=null,d=null,d=mighty.Device.support.querySelector?a.querySelectorAll("*"):a.getElementsByTagName("*"),e=0;e<d.length;e++)c=d[e].childNodes[0],0<d[e].childNodes.length&&3==c.nodeType&&(b.push(c),c.nodeValue=this.processText(c.nodeValue));return a},processWithCacheHTML:function(a,b){if(!(a instanceof HTMLElement)){var c=document.createElement("div");c.innerHTML=
a;a=c}for(var d=c=null,d=mighty.Device.support.querySelector?a.querySelectorAll("*"):a.getElementsByTagName("*"),e=0;e<d.length;e++)c=d[e].childNodes[0],0<d[e].childNodes.length&&3==c.nodeType&&(c.prevValue=c.nodeValue,c.nodeValue=this.processText(c.nodeValue),b.push(c));return a},processText:function(a){var b="",a=(""+a).split(this.cfg.replaceStart),c=null,d=0,e="",e="",f=a.length;if(1>=f)return a[0];var g=0;for(""===a[0]&&g++;g<f;g++)c=a[g],""===c?b+=this.cfg.replaceStart:(d=c.indexOf(this.cfg.replaceEnd),
-1===d?b+=c:(e=c.substr(0,d),e=this.activeHolder[e],b=void 0!==e&&e.length?b+(e+c.substring(d+this.cfg.replaceEnd.length)):b+(this.cfg.replaceStart+c)));return b},handleSignal_i18n:function(a,b){switch(a){case i18n.Event.PROCESS_HTML:return this.processHTML(b);case i18n.Event.PROCESS_TEXT:return this.processText(b);case i18n.Event.SET_LANG:return this.setLang(b),!0;case i18n.Event.GET_LANG:return this.currLang}return!1},setLang:function(a){this.currLang=a;this.activeHolder=this.palette?this.palette[mighty.Macro.GetStrEnum(i18n.Lang,
a)]:{};this.chn_i18n.signal(i18n.Event.LANG_CHANGED,this.currLang)},currLang:-1,activeHolder:null,chn_i18n:null});
mighty.Macro={CreateEntity:function(a,b,c){a=new Entity.Info(Palettes.Entity.getByName(a),b,c);return Ask("Entity.IN",Entity.Event.ADD_FROM_INFO,a)},CreateEntityID:function(a,b,c){a=new Entity.Info(Palettes.Entity.getByID(a),b,c);return Ask("Entity.IN",Entity.Event.ADD_FROM_INFO,a)},GetStrEnum:function(a,b){if(void 0===a)return"Unknown";for(var c in a)if(a[c]===b)return c;return"Unknown"},GetStringFromObj:function(a,b){for(var c in a)if(a[c]===b)return c;return"Unknown"},GetTextureByID:function(a){return Resource.plugin.module.Texture.getByID(a)},
GetTextureByName:function(a){return Resource.plugin.module.Texture.getByName(a)},GetSoundByID:function(a){return Resource.plugin.module.Sound.getByID(a)},GetSoundByName:function(a){return Resource.plugin.module.Sound.getByName(a)},IsUrl:function(a){return-1!==a.indexOf("http://")||-1!==a.indexOf("https://")?!0:!1}};for(key in mighty.Macro)mighty[key]=mighty.Macro[key];mighty.LoadLevel=function(a){SendSignal("Scene.IN",Scene.Event.LOAD_LEVEL,a)};
(function(){var a=Engine.Cfg.version,b=Object.keys(Engine.Version);void 0!==a&&a<b.length-1&&a===Engine.Version["0_9_9"]&&(Entity.Geometry.prototype.updateBrushOffset=function(){this.x-=this.centerOffsetX;this.y-=this.centerOffsetY},Entity.Manager.prototype.addFromInfo=function(a){if(void 0===a)return null;if(void 0===a.template||null===a.template)return mighty.Error.warning("Entity.addFromInfo","No template specified."),null;var b=a.template.create();b.x=a.x;b.y=a.y;b=this.add(b);b.forceMove(a.x,
a.y);return b},Entity.Loader.readCoord=function(a,b){a.x=b.getCenterX();a.y=b.getCenterY()},Entity.Loader.loadCoord=function(a,b,e){a.move(b-a.centerOffsetX,e-a.centerOffsetY)})})();
